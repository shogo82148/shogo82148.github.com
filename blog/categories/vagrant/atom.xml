<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Vagrant | Shogo's Blog]]></title>
  <link href="http://shogo82148.github.io/blog/categories/vagrant/atom.xml" rel="self"/>
  <link href="http://shogo82148.github.io/"/>
  <updated>2014-09-13T00:49:45+09:00</updated>
  <id>http://shogo82148.github.io/</id>
  <author>
    <name><![CDATA[Shogo Ichinose]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[VeeWeeでVagrantのboxを作ってみた]]></title>
    <link href="http://shogo82148.github.io/blog/2012/09/01/veewee/"/>
    <updated>2012-09-01T15:26:00+09:00</updated>
    <id>http://shogo82148.github.io/blog/2012/09/01/veewee</id>
    <content type="html"><![CDATA[<h2>Vagrant</h2>

<p><a href="http://vagrantup.com/">Vagrant</a>はコマンドラインから<a href="https://www.virtualbox.org/">VirtualBox</a>を扱えるようにするツール。
仮想マシンの起動・再起動をコマンドライン上から行えるのはもちろん、<a href="http://wiki.opscode.com/display/chef/Home">Chef</a>や
<a href="http://puppetlabs.com/puppet/what-is-puppet/">Puppet</a>
と連携することで必要なソフトウェアのインストールを行なってくれます。</p>

<!-- more -->


<p>Vagrantを使うには仮想マシンのひな形であるBase Boxが必要です。
<a href="http://www.vagrantbox.es/">Vagrantbox.es</a>にいろんなOSのBoxがあるけど、
インストールされているOSのバージョンが古かったり、タイムゾーンがUTCになっていたりして
不具合発生。
そこでBoxを自分で作ってみようと思い立ち、やってみたのでそのメモ。</p>

<p>作ったBoxは GitHub にあげておいたので使いたい方はどうぞ。
Ubuntu 12.04.2 Server + VirtualBox 4.2.10 で作ってあります。</p>

<p><code>
vagrant box add myubuntu http://shogo82148.github.com/boxes/ubuntu-12.04.2-amd64.box
</code></p>

<h2>VeeWee</h2>

<p><a href="https://github.com/jedi4ever/veewee">VeeWee</a>はBoxの作成を自動化してくれるツール。
OSのインストール、不要なパッケージの削除、Box化なんかを自動でやってくれるらしい。</p>

<h2>VagrantとVeeWeeのインストール</h2>

<p>Rubyの実行環境とVirtualBoxのインストールを済ませたら、
gemを使ってVagrantとVeeWeeをインストール。</p>

<p><code>
gem install vagrant
gem install veewee
</code></p>

<h2>使ってみる</h2>

<p><code>
vagrant basebox templates
</code></p>

<p>と打つとテンプレートの一覧が出てくる。
現時点でのUbuntu最新版であるUbuntu 12.04をテンプレートとして使ってみる。</p>

<p><code>
vagrant basebox define myubuntu ubuntu-12.04-server-amd64
</code></p>

<p>これでdefinitions/myubuntuの中に設定ファイルができる。</p>

<p>そのままだとisoのダウンロードで404が帰ってくるので設定ファイルを書き換え。
加えて日本語が使えるようにLocaleをja_JPに、タイムゾーンをAsia/Tokyoにしておく。</p>

<p>```diff
--- templates/ubuntu-12.04-server-amd64/definition.rb   2012-08-31 18:23:28.000000000 +0900
+++ definitions/myubuntu/definition.rb                  2012-08-31 21:17:52.000000000 +0900
@@ -6,8 +6,8 @@
   :hostiocache => 'off',
   :os_type_id => 'Ubuntu_64',
   :iso_file => "ubuntu-12.04-server-amd64.iso",
-  :iso_src => "http://releases.ubuntu.com/12.04/ubuntu-12.04-server-amd64.iso",
-  :iso_md5 => 'f2e921788d35bbdf0336d05d228136eb',
+  :iso_src => "http://ftp.jaist.ac.jp/pub/Linux/ubuntu-releases/12.04.1/ubuntu-12.04.1-server-amd64.iso",
+  :iso_md5 => '06472ddf11382c8da1f32e9487435c3d',
   :iso_download_timeout => "1000",
   :boot_wait => "4",
   :boot_cmd_sequence => [
--- templates/ubuntu-12.04-server-amd64/preseed.cfg     2012-08-31 18:23:28.000000000 +0900
+++ definitions/myubuntu/preseed.cfg                    2012-08-31 19:22:47.000000000 +0900
@@ -1,5 +1,5 @@
 ## Options to set on the command line
-d-i debian-installer/locale string en_US.utf8
+d-i debian-installer/locale string ja_JP.utf8
 d-i console-setup/ask_detect boolean false
 d-i console-setup/layout string USA</p>

<p>@@ -11,7 +11,7 @@
 # Not working , specify a dummy in the DHCP
 #d-i netcfg/no_default_route boolean</p>

<p>-d-i time/zone string UTC
+d-i time/zone string Asia/Tokyo
 d-i clock-setup/utc-auto boolean true
 d-i clock-setup/utc boolean true
```</p>

<p>設定ができたらビルド。</p>

<p><code>
vagrant basebox build myubuntu
</code></p>

<p>isoのダウンロードとosのインストールが始まるので気長にまつ。
途中で「isoが無いけどダウンロードする？」と聞かれるので「Yes」と答えよう(「y」と打つだけだと自分でダウンロードしろと言われる)。</p>

<p>ビルドができたらファイルの形式にエクスポート。</p>

<p><code>
vagrant basebox export myubuntu
</code></p>

<p>カレントディレクトリにmyubuntu.boxができて完成！</p>

<p>myubuntuをboxとして登録すれば、vagrantから使えるようになる。
GitHub にあげておいたので、以下のコマンドで使える。</p>

<p><code>
vagrant box add myubuntu http://shogo82148.github.com/boxes/ubuntu-12.04.2-amd64.box
mkdir foo
cd foo
vagrant init myubuntu
vagrant up
vagrant ssh
</code></p>
]]></content>
  </entry>
  
</feed>
