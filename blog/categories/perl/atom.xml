<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: perl | Shogo's Blog]]></title>
  <link href="http://shogo82148.github.io/blog/categories/perl/atom.xml" rel="self"/>
  <link href="http://shogo82148.github.io/"/>
  <updated>2013-11-10T01:32:27+09:00</updated>
  <id>http://shogo82148.github.io/</id>
  <author>
    <name><![CDATA[Shogo Ichinose]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[ISUCON3の本戦に参加してきた]]></title>
    <link href="http://shogo82148.github.io/blog/2013/11/09/isucon3/"/>
    <updated>2013-11-09T23:58:00+09:00</updated>
    <id>http://shogo82148.github.io/blog/2013/11/09/isucon3</id>
    <content type="html"><![CDATA[<p><a href="http://shogo82148.github.io/blog/2013/10/07/isucon3-qualify/">ISUCON3の予選</a>を何とか通過し、
本戦へと参戦してきました。</p>

<p>大会中の方針とか考えたこととかメモ。</p>

<h2>お題</h2>

<ul>
<li>Tw○tter--likeな画像投稿サービス

<ul>
<li>ユーザをフォローできる</li>
<li>フォローしたユーザが画像を投稿すると、タイムラインに画像が流れる</li>
<li>公開範囲を全員に公開・フォロワーのみに公開・自分だけに公開から選べる</li>
</ul>
</li>
<li>タイムラインはロングポーリングを使ってリアルタイム反映

<ul>
<li>JSON-APIが用意されていて、Javascriptから叩く</li>
</ul>
</li>
<li>使用できるサーバは5台</li>
</ul>


<p>画像を扱うお題と聞いて、会場がざわめきました。</p>

<h2>MySQLのクエリを見てみる</h2>

<p>開始直後、鍵を用意したり、gitのレポジトリを立てたりなんだりした後、
一回目の計測。</p>

<p>topコマンドで走っているプロセスを見ていると、大量のconvertが！！
プロセス名とお題から考えるに、こいつら確実にImage Magickだ・・・。
CPUのほとんどが画像の変換にくわれていたので、
まずは「どこかでキャッシュする」作戦をとることに。
キャッシュするならフロントに近いほうがいいだろうということで、
フロントのnginxでキャッシュする作戦をとることにしました
(アクセス制限があるimageは難しいかもしれないけど、全部publicなiconならすぐできるだろうとこのときは思ってました)。</p>

<p>僕はnginxがconvertを駆逐してくれると信じて、MySQLに投げているクエリを中心にPerlのコードを見てました。
役割分担はこんな感じ。</p>

<ul>
<li>サーバの設定とか(@mackee_wさん)</li>
<li>nginxでキャッシュする設定(@9reさん)</li>
<li>コード読む、主にMySQLに投げてるクエリとか(@shogo82148)</li>
</ul>


<p>毎回、ひどいクエリが仕込まれているようなイメージがあったけど、
今回はそこまでひどくない。
クエリチューニング全然効果なさそうと判断して、次の作戦を考えることにしました。</p>

<h2>No Image Magick, use Imager!</h2>

<p>やっぱり一番のボトルネックは画像変換。
nginxでキャッシュするとはいえ軽いほうがいいよね、ということで、
外部プロセスで実行している画像変換をImmagerを使ってPerlと同じプロセスでやる作戦。</p>

<p>Imagerに置き換え後ベンチにかけたら、若干スコアが・・・上がった・・・ような・・・？
しかし、画像が変化していると怒られて、スコアは無効。
画像エラーを修正するコストと、スコアの上がり具合を見て、Image Magickのままにすることにしました。</p>

<p>予選でも同じように外部プロセス起動している部分をPerlのライブラリにしたけど、
その時はあっさり動いた。
あれは外部プロセス起動をやめたらスコア上がると思い込ませるための布石だったんだ・・・。
(今回の場合、プロセスの起動より画像の変換のほうが重いので、スコアが上がらないのは当たり前)</p>

<h2>いろいろ諦めてPerl側でファイルキャッシュ</h2>

<p>Imagerはテストを通らず、nginxの設定キャッシュ設定も上手く動作しなかったので、
Perlでファイルキャッシュする方針に変更。
convertの結果にmvで適当な場所にコピーして保存。
これだけでスコアが5倍くらいに跳ね上がり、一気に上位に浮上！
最初からやっておくべきだった・・・。
もうちょっと早ければ特別賞もらえたかもしれないのに。</p>

<h2>rsync! rsync!</h2>

<p>ファイルキャッシュの作業をやっている間に、@mackee_wさんがnfsの設定をやってくれたので、
アップロードされたファイルやキャッシュファイルの保存先をnfsに変更。</p>

<p>あとは物量作戦でいくしかないだろうということで、rsyncで他のサーバにコピーして調整を繰り返してた。
(並行してnginxのキャッシュ設定にも再チャレンジしてたけど、nginx力が足りなかった)</p>

<h2>最終結果</h2>

<p>テストFAILした!! No Score!!</p>

<p>なんかこんなの前もあった！</p>

<h2>反省点</h2>

<ul>
<li>画像変換をGETでやってたけど、POSTでやったほうがよかったかも</li>
<li>nginxについて勉強しよう</li>
<li>nfsについて勉強しよう</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Redis::NamespaceとRedis::Keyをリリースしました]]></title>
    <link href="http://shogo82148.github.io/blog/2013/10/18/redis-namespace-and-redis-key/"/>
    <updated>2013-10-18T23:21:00+09:00</updated>
    <id>http://shogo82148.github.io/blog/2013/10/18/redis-namespace-and-redis-key</id>
    <content type="html"><![CDATA[<p>こんばんは、最近シングルトン恐怖症になっているいっちーです。
<a href="https://metacpan.org/release/Redis-Namespace">Redis::Namespace</a>と
<a href="https://metacpan.org/release/Redis-Key">Redis::Key</a>をリリースしました。</p>

<!-- More -->


<h2>Redis::Namespace</h2>

<p>「<a href="http://shogo82148.github.io/blog/2013/09/14/redis-namespace-perl/">Redis::NamespaceのPerl版書いた</a>」
で紹介したモジュールをCPANizeしました。
コマンドのキー名に当たる部分に、自動にプレフィックスをつけてくれる賢い奴です。</p>

<p>```perl
use Redis;
use Redis::Namespace;</p>

<p>my $redis = Redis->new;
my $ns = Redis::Namespace->new(redis => $redis, namespace => 'fugu');</p>

<p>$ns->set('foo', 'bar');    # $redis->set('fugu:foo', 'bar');
my $foo = $ns->get('foo'); # my $foo = $redis->get('fugu:foo');
```</p>

<p>RedisにはKey-Value Storeなんてかっこいい名前が付いているけど、
結局はシステム全体で使えるグローバル変数なわけです。
グローバル変数は駆逐するべきです。
いちいちプレフィックスつけて名前の衝突を回避するなんて人間のやることとは思えません。</p>

<p>せめてモジュールローカルとか、クラスローカルとかある程度スコープを制限したいですよね。
Redis::Namespaceを使えば簡単に実現できます。</p>

<h2>Redis::Key</h2>

<p>Redis::Key は Redisのキーの簡単なラッパークラスです。
毎回毎回「接続先のRedisサーバ」と「キーの名前」を指定するのは面倒です。
この2つをセットにして、一つのオブジェクトとして扱うことができます。</p>

<p>```perl
use Redis;
use Redis::Key;</p>

<p>my $redis = Redis->new;
my $key = Redis::Key->new(redis => $redis, key => 'hoge');
$key->set('fugu'); # $redis->set('hoge', 'fuga');
$key->get;         # $redis->get('hoge');
```</p>

<p>普通に使っている限りは他のキーにアクセスすることができなくなるので、
Redis::Keyのオブジェクトを他のクラスに渡す、とかしても安心です。</p>

<p>あと、キーの名前の一部をプレースホルダーにして、あとから値を埋め込むこともできます。
キー名の一部に日付やIDを埋め込むっていうことが多いのでつけてみました。</p>

<p><code>perl
my $user_keys = Redis::Key-&gt;new(redis =&gt; $redis, key =&gt; 'user:{id}', need_bind =&gt; 1);
my $user = $user_keys-&gt;bind(id =&gt; 1001);
$user-&gt;get;  # $redis-&gt;get('user:1001');
</code></p>

<p>Key-Value Store はお手軽ではありますが、キーの名前に一定のルールを設けてあげないと
さすがに管理できなくなります。
Redis::Key を使ってルールを書くのが楽になるといいですね。</p>

<h2>Redis::Fast と Redis::Namespace と Redis::Key を組み合わせる</h2>

<p>Redis::Fast と Redis::Namespace は Redis.pm 互換なので組み合わせて使えます。</p>

<p><code>perl
my $redis = Redis::Fast-&gt;new;
my $ns1 = Redis::Namespace-&gt;new(redis =&gt; $redis, namespace =&gt; 'hoge');
my $ns2 = Redis::Namespace-&gt;new(redis =&gt; $ns1, namespace =&gt; 'fuga'); # Redis::Namespaceのネストもできる
my $key = Redis::Key-&gt;new(redis =&gt; $ns2, key =&gt; 'key'); # hoge:fuga:key という名前になる
</code></p>

<p>なんだか最近Redis関連のモジュールばかり書いてますが、
なんでもRedisに突っ込めばいいと思っているわけではありません。
Redisを使ったコードを読んでいたら目眩がしたからです。
ISUCON3の予選で使ったのはRedisを使いたかったらというより、
Redis::Fastを使いたかったからです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Redis::Fastをcpanize＆アップデートしました]]></title>
    <link href="http://shogo82148.github.io/blog/2013/10/13/cpanize-redis-fast/"/>
    <updated>2013-10-13T22:39:00+09:00</updated>
    <id>http://shogo82148.github.io/blog/2013/10/13/cpanize-redis-fast</id>
    <content type="html"><![CDATA[<p>Redis::Fastを<a href="https://metacpan.org/release/Redis-Fast">cpanizeしました！</a></p>

<p>さらに！早速不具合が見つかったので0.01から0.02にアップデートしました！</p>

<!-- More -->


<p>CPANに上げてから24時間も経たないうちにpull requestがやってきてCPAN怖いところです。</p>

<p>最初のバージョンである0.01ではタイムアウト処理をちゃんと書いていなかったので、
タイムアウト時に無限ループに陥る不具合がありました。
LinuxとMacとでコネクションを張るのに失敗したときの挙動が違うらしく、
Linuxでは問題なくテストが通るのに、Mac上でのテストでは再現するという面倒バグでした。
さらに面倒なことにRedisの起動のタイミングによって、
Macでもテストが通ったり通らなかったりするという・・・。</p>

<p>主に開発はLinux上でやって、Linux上でしかテスト動かしてなかったので全く気がついていませんでした。
CPANデビューのモジュールがネットワーク関連でXSで少しハードルを上げ過ぎた感じがします。
環境依存な部分が多くてつらいです。</p>

<p>pull requestを送ってくださったsyohexさん、実際にインストールを試みてテストが通らないことを教えてくださったみなさん、ありがとうございました。
アップデートした0.02では、タイムアウト時の処理を少し書きなおして、pull requestも取り込みました。
Mac上でも問題なくテストが通ってインストールできるはずです(きっとね)。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ISUCON3の予選に参加してきた]]></title>
    <link href="http://shogo82148.github.io/blog/2013/10/07/isucon3-qualify/"/>
    <updated>2013-10-07T13:03:00+09:00</updated>
    <id>http://shogo82148.github.io/blog/2013/10/07/isucon3-qualify</id>
    <content type="html"><![CDATA[<p>こんにちは、いつの間にかチームぽわわ2のメンバーになっていたいっちーです。</p>

<p><a href="https://twitter.com/9re">@9re</a>さんと
<a href="https://twitter.com/mackee_w">@mackee_w</a>さんとでISUCON3の予選に参加してきました。
主にアプリの書き換えを担当していたので、やったことを残しておきます。
チーム全体の方針とか役割分担とかはまこぴー先生の<a href="http://mackee.hatenablog.com/entry/2013/10/06/230412">#isucon 予選でとりあえず10位だった</a>を参照。</p>

<!-- More -->


<h2>お題</h2>

<p>gistみたいなWebアプリ。
<a href="http://shogo82148.github.io/blog/2013/04/13/isucon/">社内ISUCON</a>のときと似たようなお題ですね。
違いは...</p>

<ul>
<li>スターは無い</li>
<li>Recent Postsのサイドバーが無い代わりに、ページングしてたどっていけるページがある</li>
<li>privateな投稿ができる</li>
<li>Markdown形式で投稿できて、表示はHTMLでレンダリングされる</li>
</ul>


<p>詳しくは、れもんさんの<a href="http://isucon.net/archives/32853582.html">#isucon 2013年予選問題の解説など</a>を参照。</p>

<h2>やったこと</h2>

<p>一言で言えば、Redisにキャッシュするようにしました。</p>

<h3>RecentをRedisのリストで管理</h3>

<p>Recentの表示で日付順ソートしているのが重たそうだったので、
公開メモのソート結果をあらかじめRedisのリストに入れておく作戦。</p>

<p>Redisの<code>SORT</code>コマンドが高機能で面白いなーって思ってたので使ってみました。
リストにはメモのIDだけ入れておいて、メモの実体は別のキーを参照する、なんてことができます。
このコマンド、<code>SORT</code>って名前なのに「ソートしない」ってオプションあるところがいいですよね！</p>

<p>MySQLがボトルネックになっているのはこれで解消できました。</p>

<h3>bin/markdownを使わない＆レンダリング結果をキャッシュ</h3>

<p>Markdownのレンダリングを外部コマンド叩いてやっていたので、
<a href="https://metacpan.org/module/Text::Markdown::Discount">Text::Markdown::Discount</a>を使ってレンダリングするように変更。
qx{hoge}って記法はじめて見ました。Perlってやつはいろんな書き方があってよくわからないです。</p>

<p>Markdownの文法って亜種が結構あるので、レンダラをかえるのはちょっと怖かったんですが、全く問題なし。
スコアも3000くらい上がってかなり効果がありました。</p>

<p>さらにレンダリング結果をRedisに入れてキャッシュで+1000くらい。</p>

<h3>Recentのレンダリング結果をキャッシュ</h3>

<p>RecentをRedisでさばくようにしたけど、そもそも100要素もあるHTMLのレンダリングそうとう重いはず。
と、いうわけでここもRedisにキャッシュするようにしました。
公開メモが投稿されたらRecent/:pageのキャッシュを全部削除。
Postのたびにキャッシュクリアされるのであんまり効果ないかなーと思っていたけど、わりと効果あったみたい？
(正確なスコアよく見てなかった)</p>

<h3>Redis::Fast!!</h3>

<p>残り時間も少なくなり時間内にできることも限られれきたので、最後の最後で<a href="https://github.com/shogo82148/Redis-Fast">Redis::Fast</a>を投入。
これで+1000くらい上がったらしい。(正確なスコアよく見てなかった)</p>

<p>s/Redis/Redis::Fast/ するだけの簡単なお仕事の予定が、githubからのインストールに一番手間取った。
cpanfileにgitのレポジトリを書くと(非公式だけど)インストールできるよ！ってどこかで見た気がするけどなかなかうまく行かず、
自分で<code>git clone</code>してそのディレクトリを指定してインストール(したってまこぴー先生が言ってた)。
(<code>hiredis.h</code>が無い！って叫んでいたから、cartonがsubmoduleをうまく処理できていなかったと予想。
非公式の機能に頼るの良くないね。)</p>

<h2>できなかったこと</h2>

<ul>
<li>my.cnf？なにそれ美味しいの？</li>
<li>SQLクエリをいじる余裕がなかった

<ul>
<li>Newer/Olderのクエリが残念なのはわかってたけど、結局いじってない</li>
</ul>
</li>
<li>Nginxでキャッシュしたい</li>
<li>必要なモジュールは事前にCPANにあげておこう。</li>
</ul>


<h2>まとめ</h2>

<p>結果は13192.1点で10位でした。
特に問題がなければこのまま予選突破できるはず・・・！</p>

<p>ところで、魔王軍が学生枠を制圧していて恐ろしいですね。
てか、<a href="http://shiro-goma.hatenablog.com/entry/2013/10/07/202913">僕らのチームとの差、500点程度しか無いじゃないですか</a>。怖！！！
これ以上の侵攻はなんとしてでも食い止めなければ。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Redis::NamespaceのPerl版書いた]]></title>
    <link href="http://shogo82148.github.io/blog/2013/09/14/redis-namespace-perl/"/>
    <updated>2013-09-14T18:36:00+09:00</updated>
    <id>http://shogo82148.github.io/blog/2013/09/14/redis-namespace-perl</id>
    <content type="html"><![CDATA[<p><a href="http://redis.io/">Redis</a> のキーにプリフィックスつけるの面倒だなー自動的につけてくれないかなーと思い、
調べてみると Ruby に <a href="https://github.com/resque/redis-namespace">Redis-Namespace</a> というものがあるらしい。
だけども、Perl では探しても見つからなかったので書いてみた。</p>

<p>レポジトリはこちら→<a href="https://github.com/shogo82148/Redis-Namepace">Redis::Namespace</a></p>

<!-- More -->


<h2>使い方</h2>

<p>インターフェースは <a href="http://search.cpan.org/~melo/Redis/">Perl Redis</a> と一緒。
コマンドのキー名に当たる部分に、自動的にプレフィックスをつけてくれる。</p>

<p>``` perl
use Redis;
use Redis::Namespace;</p>

<p>my $redis = Redis->new;
my $ns = Redis::Namespace(redis => $redis, namespace => 'fugu');</p>

<p>$ns->set('foo', 'bar');    # $redis->set('fugu:foo', 'bar');
my $foo = $ns->get('foo'); # my $foo = $redis->get('fugu:foo');
```</p>

<p>大体のコマンドには対応したつもり。
別のプレフィックスがついたキーには基本的にアクセスできなくなるので、
キー名の管理が少し楽になると思います。</p>

<p>でも、flushdb とか flushall すると全部消えるので気をつけてね！</p>
]]></content>
  </entry>
  
</feed>
