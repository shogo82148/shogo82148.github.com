<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&family=Noto+Sans+Mono&display=swap" rel="stylesheet"> 

  
  <title>初期化なしのusing文ってOK？</title>

  
  
  <link rel="stylesheet" href="/css/hugo-octopress.css">

  
  
    <link rel="stylesheet" href="https://shogo82148.github.io/css/syntax.css">
  

  
  <link href="https://shogo82148.github.io/favicon.png" rel="icon">

  
  

  <meta name="description" content="" />
  <meta name="keywords" content="">
  <meta name="author" content="ICHINOSE Shogo">

  
  <meta name="generator" content="Hugo 0.120.4">


<script async src="https://www.googletagmanager.com/gtag/js?id=G-40R0PCLKVF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-40R0PCLKVF');
</script>


<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>

<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

  
  
</head>
<body>


<header role="banner">
<hgroup>
  
  <h1><a href="https://shogo82148.github.io/">Shogo&#39;s Blog</a></h1>
  <h2></h2>
</hgroup>
</header>


<nav role="navigation">
<fieldset class="mobile-nav">
  
  <select onchange="location = this.value;">
    <option value="">Navigate…</option>
      
  </select>
</fieldset>


<ul class="main-navigation">
  
  
</ul>

<ul class="subscription">
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:https://shogo82148.github.io/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
  <p class="meta">May 27, 2014
     - 3 minute read 
    

    
    
      - <a class="label" href="https://shogo82148.github.io/categories/csharp/">csharp </a>
    
  </p>
  <h1 class="entry-title">
     初期化なしのusing文ってOK？ 
  </h1>
</header>


        <div class="entry-content">
          
          
          
          
          <p>C# の using ステートメント、普通は変数の初期化とか new とかをまとめてやるものだと思ってたんですが、
某プロジェクトでusing文をこんな感じで使っているのを見かけました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">hoge</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Hoge</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">using</span><span class="p">(</span><span class="n">hoge</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// using( var hoge = new Hoge() ) { ならよく見る</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>見慣れない書き方だったので、本当にリソース解放が行われているのか不安・・・。
リソース解放が行われているのか調べてみました。</p>
<!-- More -->
<h2 id="まずは結論">まずは結論</h2>
<ul>
<li>リソース解放自体は行われているので、ちゃんと書いてあれば問題なし</li>
<li>しかしエラーをコンパイル時に見つけられない場合があるので非推奨</li>
</ul>
<h2 id="逆アセンブルして調べてみた">逆アセンブルして調べてみた</h2>
<p>コンパイル結果見ればちゃんとリソース解放されているかわかるよね！
ってことでバイナリを逆アセンブルして調べてみました。</p>
<h3 id="サンプルコード">サンプルコード</h3>
<p>検証に使ったのはこんなコード。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">UsingTest</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">MainClass</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span> <span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">sr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamReader</span> <span class="p">(</span><span class="s">&#34;hoge.txt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span> <span class="p">(</span><span class="s">&#34;Hoge: {0}&#34;</span><span class="p">,</span> <span class="n">sr</span><span class="p">.</span><span class="n">ReadLine</span> <span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>僕はMac使いに転向したので、Monoを使います。
<code>mcs</code>を使ってコンパイル、<code>monodis</code> ってのを使うとILを見れるらしいです。
Windowsだったら .NET Framework SDK に <code>ildasm</code> ってのが付属してるので、それで見れるはず。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mcs UsingTest.cs
</span></span><span class="line"><span class="cl">monodis UsingTest.exe
</span></span></code></pre></div><p>標準出力にILが吐かれます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">.assembly extern mscorlib
</span></span><span class="line"><span class="cl">// ... 中略 ...
</span></span><span class="line"><span class="cl">.namespace UsingTest
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  .class private auto ansi beforefieldinit MainClass
</span></span><span class="line"><span class="cl">  	 extends [mscorlib]System.Object
</span></span><span class="line"><span class="cl">  {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // method line 1
</span></span><span class="line"><span class="cl">    .method public hidebysig specialname rtspecialname
</span></span><span class="line"><span class="cl">           instance default void &#39;.ctor&#39; ()  cil managed
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">        // Method begins at RVA 0x2050
</span></span><span class="line"><span class="cl">	// Code size 7 (0x7)
</span></span><span class="line"><span class="cl">	.maxstack 8
</span></span><span class="line"><span class="cl">	IL_0000:  ldarg.0
</span></span><span class="line"><span class="cl">	IL_0001:  call instance void object::&#39;.ctor&#39;()
</span></span><span class="line"><span class="cl">	IL_0006:  ret
</span></span><span class="line"><span class="cl">    } // end of method MainClass::.ctor
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // method line 2
</span></span><span class="line"><span class="cl">    .method public static hidebysig
</span></span><span class="line"><span class="cl">           default void Main (string[] args)  cil managed
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">        // Method begins at RVA 0x2058
</span></span><span class="line"><span class="cl">	.entrypoint
</span></span><span class="line"><span class="cl">	// Code size 29 (0x1d)
</span></span><span class="line"><span class="cl">	.maxstack 2
</span></span><span class="line"><span class="cl">	.locals init (
</span></span><span class="line"><span class="cl">		class [mscorlib]System.IO.StreamReader	V_0)
</span></span><span class="line"><span class="cl">		IL_0000:  nop
</span></span><span class="line"><span class="cl">		IL_0001:  ldstr &#34;hoge.txt&#34;
</span></span><span class="line"><span class="cl">		IL_0006:  newobj instance void class [mscorlib]System.IO.StreamReader::&#39;.ctor&#39;(string)
</span></span><span class="line"><span class="cl">		IL_000b:  stloc.0
</span></span><span class="line"><span class="cl">		IL_000c:  ldstr &#34;Hoge: {0}&#34;
</span></span><span class="line"><span class="cl">		IL_0011:  ldloc.0
</span></span><span class="line"><span class="cl">		IL_0012:  callvirt instance string class [mscorlib]System.IO.TextReader::ReadLine()
</span></span><span class="line"><span class="cl">		IL_0017:  call void class [mscorlib]System.Console::WriteLine(string, object)
</span></span><span class="line"><span class="cl">		IL_001c:  ret
</span></span><span class="line"><span class="cl">    } // end of method MainClass::Main
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  } // end of class UsingTest.MainClass
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>Disposeが呼ばれてない！
リソース解放されてないぞ！！</p>
<h3 id="usingと一緒に初期化してみる">usingと一緒に初期化してみる</h3>
<p>usingステートメントを使って解放処理をしてみます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">sr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamReader</span> <span class="p">(</span><span class="s">&#34;hoge.txt&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span> <span class="p">(</span><span class="s">&#34;Hoge: {0}&#34;</span><span class="p">,</span> <span class="n">sr</span><span class="p">.</span><span class="n">ReadLine</span> <span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">// Code size 49 (0x31)
</span></span><span class="line"><span class="cl">.maxstack 2
</span></span><span class="line"><span class="cl">.locals init (
</span></span><span class="line"><span class="cl">    class [mscorlib]System.IO.StreamReader	V_0)
</span></span><span class="line"><span class="cl">IL_0000:  nop
</span></span><span class="line"><span class="cl">IL_0001:  ldstr &#34;hoge.txt&#34;
</span></span><span class="line"><span class="cl">IL_0006:  newobj instance void class [mscorlib]System.IO.StreamReader::&#39;.ctor&#39;(string)
</span></span><span class="line"><span class="cl">IL_000b:  stloc.0
</span></span><span class="line"><span class="cl">.try { // 0
</span></span><span class="line"><span class="cl">  L_000c:  nop
</span></span><span class="line"><span class="cl">  IL_000d:  ldstr &#34;Hoge: {0}&#34;
</span></span><span class="line"><span class="cl">  IL_0012:  ldloc.0
</span></span><span class="line"><span class="cl">  IL_0013:  callvirt instance string class [mscorlib]System.IO.TextReader::ReadLine()
</span></span><span class="line"><span class="cl">  IL_0018:  call void class [mscorlib]System.Console::WriteLine(string, object)
</span></span><span class="line"><span class="cl">  IL_001d:  nop
</span></span><span class="line"><span class="cl">  IL_001e:  leave IL_0030
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">} // end .try 0
</span></span><span class="line"><span class="cl">finally { // 0
</span></span><span class="line"><span class="cl">  IL_0023:  ldloc.0
</span></span><span class="line"><span class="cl">  IL_0024:  brfalse IL_002f
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  IL_0029:  ldloc.0
</span></span><span class="line"><span class="cl">  IL_002a:  callvirt instance void class [mscorlib]System.IDisposable::Dispose()
</span></span><span class="line"><span class="cl">  IL_002f:  endfinally
</span></span><span class="line"><span class="cl">} // end handler 0
</span></span><span class="line"><span class="cl">IL_0030:  ret
</span></span><span class="line"><span class="cl">} // end of method MainClass::Main
</span></span></code></pre></div><p>自動的に try-finall節が作られ、その中でDisposeが呼ばれています。(たぶん。ILよくわかんないけど)</p>
<h3 id="usingでは初期化しない">usingでは初期化しない</h3>
<p>次にusingの外で初期化</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">sr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamReader</span> <span class="p">(</span><span class="s">&#34;hoge.txt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="p">(</span><span class="n">sr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span> <span class="p">(</span><span class="s">&#34;Hoge: {0}&#34;</span><span class="p">,</span> <span class="n">sr</span><span class="p">.</span><span class="n">ReadLine</span> <span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">// Code size 51 (0x33)
</span></span><span class="line"><span class="cl">.locals init (
</span></span><span class="line"><span class="cl">    class [mscorlib]System.IO.StreamReader V_0,
</span></span><span class="line"><span class="cl">    class [mscorlib]System.IO.StreamReader V_1)
</span></span><span class="line"><span class="cl">IL_0000:  nop
</span></span><span class="line"><span class="cl">IL_0001:  ldstr &#34;hoge.txt&#34;
</span></span><span class="line"><span class="cl">IL_0006:  newobj instance void class [mscorlib]System.IO.StreamReader::&#39;.ctor&#39;(string)
</span></span><span class="line"><span class="cl">IL_000b:  stloc.0
</span></span><span class="line"><span class="cl">IL_000c:  ldloc.0
</span></span><span class="line"><span class="cl">IL_000d:  stloc.1
</span></span><span class="line"><span class="cl">.try { // 0
</span></span><span class="line"><span class="cl">  IL_000e:  nop
</span></span><span class="line"><span class="cl">  IL_000f:  ldstr &#34;Hoge: {0}&#34;
</span></span><span class="line"><span class="cl">  IL_0014:  ldloc.0
</span></span><span class="line"><span class="cl">  IL_0015:  callvirt instance string class [mscorlib]System.IO.TextReader::ReadLine()
</span></span><span class="line"><span class="cl">  IL_001a:  call void class [mscorlib]System.Console::WriteLine(string, object)
</span></span><span class="line"><span class="cl">  IL_001f:  nop
</span></span><span class="line"><span class="cl">  IL_0020:  leave IL_0032
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">} // end .try 0
</span></span><span class="line"><span class="cl">finally  { // 0
</span></span><span class="line"><span class="cl">  IL_0025:  ldloc.1
</span></span><span class="line"><span class="cl">  IL_0026:  brfalse IL_0031
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  IL_002b:  ldloc.1
</span></span><span class="line"><span class="cl">  IL_002c:  callvirt instance void class [mscorlib]System.IDisposable::Dispose()
</span></span><span class="line"><span class="cl">  IL_0031:  endfinally
</span></span><span class="line"><span class="cl">} // end handler 0
</span></span><span class="line"><span class="cl">IL_0032:  ret
</span></span></code></pre></div><p>お、ちゃんとDispose呼ばれてるみたい！
リソース解放はされてますね。</p>
<p>上のILをよく見ると、ローカル変数が２つ定義されています。
どうやらusingの中と外では同じ<code>sr</code>を指定しても別変数として扱われているようです。
そのためにコピーするコードが追加されているので、コードサイズが2byteほど増えてます。</p>
<h3 id="ブロックの外でインタンスを使う">ブロックの外でインタンスを使う</h3>
<p><code>sr</code> のスコープは<code>Main</code>メソッドの中全体なので、usingのあとに<code>sr</code> をいじってもコンパイルは通ります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">sr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamReader</span> <span class="p">(</span><span class="s">&#34;hoge.txt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="p">(</span><span class="n">sr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span> <span class="p">(</span><span class="s">&#34;Hoge: {0}&#34;</span><span class="p">,</span> <span class="n">sr</span><span class="p">.</span><span class="n">ReadLine</span> <span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span> <span class="p">(</span><span class="s">&#34;Hoge: {0}&#34;</span><span class="p">,</span> <span class="n">sr</span><span class="p">.</span><span class="n">ReadLine</span> <span class="p">());</span> <span class="c1">// 例外を吐いて死ぬ</span>
</span></span></code></pre></div><p>しかし、最後の行で例外を吐いて死にます。
使えるけど使うと死ぬインスタンスが残ってるの気持ち悪いですね・・・。</p>
<h2 id="再び結論">再び結論</h2>
<p>ちゃんと Dispose は呼ばれるので、usingを抜けたところでリソース解放は行われます。
(たった2byteだけど)意味の無いILが生成されたり、コンパイル時のチェックがされなかったり、
あんまりいいことが無いので積極的に使う理由はないですね。</p>
<h2 id="see-also">SEE ALSO</h2>
<p>ちゃんとドキュメントに書いてあった。</p>
<ul>
<li><a href="http://msdn.microsoft.com/ja-jp/library/yh598w02.aspx">using ステートメント (C# リファレンス)</a></li>
</ul>
<blockquote>
<p>リソース オブジェクトをインスタンス化して、変数を using ステートメントに渡すことは可能ですが、これはベスト プラクティスではありません。
You can instantiate the resource object and then pass the variable to the using statement, but this is not a best practice.</p>
</blockquote>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">ICHINOSE Shogo</span></span>
    
    <time>May 27, 2014</time>
    
    </span>
  </p>

  

  <p class="meta">
    
        <a class="basic-alignment left" href="https://shogo82148.github.io/blog/2014/05/25/mini-message-pack/" title="C# でお手軽にMessagePack解析！">C# でお手軽にMessagePack解析！</a>
    

    
      <a class="basic-alignment right" href="https://shogo82148.github.io/blog/2014/05/29/conditional-attribute/" title="C#のconditional Attributeのコンパイル結果を見てみる">C#のconditional Attributeのコンパイル結果を見てみる</a>
    
  </p>
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      <a target="_blank" href="https://github.com/shogo82148/" title="https://github.com/shogo82148/"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a target="_blank" href="https://twitter.com/shogo82148/" title="https://twitter.com/shogo82148/"><i class="fa fa-twitter fa-3x"></i></a>
      
         
      
      
      
      
      
      
      
      

    
    
    </li>
  </ul>

  

  

  
  
  
    
      <section class="even">
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
          
          
            
          
            
              <li class="post">
                <a href="/blog/2024/06/22/2024-06-22-limit-concurrency-in-typescript/">TypeScriptで同時実行数を制限しながら並行実行する</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024/03/27/2024-03-27-use-cryptographically-secure-random/">鍵生成には暗号論的に安全な乱数を使おう</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024/03/20/2024-03-20-go-mysql-pool/">GoでMySQLを使ったテストを書くときにつかうユーティリティーライブラリを作った</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024/03/12/2024-03-12-use-mysql-new-connector-and-sql-open-db/">GoのMySQLドライバーを使うときはmysql.NewConnectorとsql.OpenDBを使おう</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024/03/11/2024-03-11-before-connect-of-mysql-driver/">GoのMySQLドライバーにBeforeConnectが追加されました</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024/02/06/2024-02-06-introduce-ridgenative-and-lambtrip/">AWS Lambda Function URLsのイベントをnet/httpで扱えるridgenativeとlambtripを書いた</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024/02/04/2024-02-04-actions-setup-mysql-and-actions-setup-redis-now-work-on-macos14/">actions-setup-mysqlとactions-setup-redisがApple M1上で動くようになりました</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024/02/01/2024-02-01-actions-setup-perl-now-works-on-macos14/">actions-setup-perlがApple M1上で動くようになりました</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024/01/11/2024-01-11-go-forwarded-header/">GoでForwarded Headerのパーサーを作った</a>
              </li>
            
          
        </ul>
      </section>
    
  
</aside>

  </div>
</div>

<footer role="contentinfo">
  <p>Copyright &copy; 2024 ICHINOSE Shogo - <a
      href="https://shogo82148.github.io/license/">License</a> -
    <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank"
        href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
  </p>
</footer>









</body>

</html>

