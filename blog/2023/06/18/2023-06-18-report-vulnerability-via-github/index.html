<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&family=Noto+Sans+Mono&display=swap" rel="stylesheet"> 

  
  <title>GitHub経由で脆弱性報告してみた</title>

  
  
  <link rel="stylesheet" href="/css/hugo-octopress.css">

  
  
    <link rel="stylesheet" href="https://shogo82148.github.io/css/syntax.css">
  

  
  <link href="https://shogo82148.github.io/favicon.png" rel="icon">

  
  

  <meta name="description" content="" />
  <meta name="keywords" content="">
  <meta name="author" content="ICHINOSE Shogo">

  
  <meta name="generator" content="Hugo 0.91.2" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-40R0PCLKVF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-40R0PCLKVF');
</script>


<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>

<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

  
  
</head>
<body>


<header role="banner">
<hgroup>
  
  <h1><a href="https://shogo82148.github.io/">Shogo&#39;s Blog</a></h1>
  <h2></h2>
</hgroup>
</header>


<nav role="navigation">
<fieldset class="mobile-nav">
  
  <select onchange="location = this.value;">
    <option value="">Navigate…</option>
      
  </select>
</fieldset>


<ul class="main-navigation">
  
  
</ul>

<ul class="subscription">
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:https://shogo82148.github.io/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
  <p class="meta">Jun 18, 2023
     - 3 minute read 
     - <a href="https://shogo82148.github.io/blog/2023/06/18/2023-06-18-report-vulnerability-via-github/#disqus_thread">Comments</a>

    
    
      - <a class="label" href="https://shogo82148.github.io/categories/github/">github </a>
    
  </p>
  <h1 class="entry-title">
     GitHub経由で脆弱性報告してみた 
  </h1>
</header>


        <div class="entry-content">
          
          
          
          
          <p><a href="https://github.com/lestrrat-go/jwx">lestrrat-go/jwx</a>に脆弱性を発見したので報告しました。</p>
<ul>
<li><a href="https://github.com/lestrrat-go/jwx/security/advisories/GHSA-rm8v-mxj3-5rmq">GHSA-rm8v-mxj3-5rmq Potential Padding Oracle Attack Vulnerability</a></li>
</ul>
<p>「メールでやり取りするの面倒だなー」と思っていたら、いつのまにかGitHub経由で脆弱性報告できるようになってるじゃないですか。</p>
<ul>
<li><a href="https://docs.github.com/en/code-security/security-advisories/guidance-on-reporting-and-writing/privately-reporting-a-security-vulnerability">Privately reporting a security vulnerability</a></li>
</ul>
<p>というわけで試してみたお話です。</p>
<h2 id="背景">背景</h2>
<h3 id="脆弱性報告の難しさ">脆弱性報告の難しさ</h3>
<p>脆弱性に関する情報は悪い人に悪用される可能性があるので、GitHubのIssueで報告するのは厳禁です。
公開レポジトリのIssueは広く公開されているので、悪い人に見つかってしまいます。</p>
<p>そのため、基本的に脆弱性の報告者はメンテナーと直接やり取りをする必要があります。
しかし、やり取りの方法に決まったルールはありません。
GitHubではセキュリティーポリシーを<code>SECURITY.md</code>に記載するルールになっているので、運が良ければ<code>SECURITY.md</code>に連絡先が書いてあります。</p>
<ul>
<li><a href="https://docs.github.com/en/code-security/getting-started/adding-a-security-policy-to-your-repository">Adding a security policy to your repository</a></li>
</ul>
<p>運が悪ければ連絡先を頑張って探すところからはじめなければなりません。</p>
<p>まあ、たいていは連絡先としてメールアドレスが見つかるので、そこにメールを送ることになります。
ただし、メールというものは脆弱性の報告に特化したものではないので、どうやって情報をやり取りするかお互いに工夫が必要です。
僕はやったことないですが、修正のパッチをメーリングリストに送るんですかね。
大変そうです。</p>
<hr>
<p>脆弱性と聞けば、CVEのような<a href="https://ja.wikipedia.org/wiki/%E8%84%86%E5%BC%B1%E6%80%A7%E6%83%85%E5%A0%B1%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9">脆弱性情報データベース</a>や、IPAの<a href="https://www.ipa.go.jp/security/todokede/vuln/uketsuke.html">脆弱性関連情報の届出受付</a>を思い浮かべるひとも多いでしょう。</p>
<ul>
<li><a href="https://www.ipa.go.jp/security/vuln/scap/cve.html">共通脆弱性識別子CVE概説 - IPA</a>
<ul>
<li><a href="https://megalodon.jp/2023-0618-1636-47/https://www.ipa.go.jp:443/security/vuln/scap/cve.html">魚拓</a></li>
</ul>
</li>
<li><a href="https://www.ipa.go.jp/security/todokede/vuln/uketsuke.html">脆弱性関連情報の届出受付 - IPA</a>
<ul>
<li><a href="https://megalodon.jp/2023-0618-1638-40/https://www.ipa.go.jp:443/security/todokede/vuln/uketsuke.html">魚拓</a></li>
</ul>
</li>
</ul>
<p>しかしこういった制度も、メンテナーの連絡先を管理しているわけではありません。
メンテナーの連絡先を探す手間も、メンテナーとのやり取りをする手間もかわりません。
（まあやったことないけど）</p>
<p>実際に報告した人のレポートにもありますが、「虎の威を借る」効果は多少期待できるでしょう。
CVEやIPAの名前だけ知っているというひとは多いでので、優先度を上げてくれるメンテナーも多いと思います。</p>
<ul>
<li><a href="https://remoteroom.jp/diary/2020-04-19/">脆弱性情報をIPAへ報告して修正されました #情報処理安全確保支援士</a></li>
<li><a href="https://atmarkit.itmedia.co.jp/ait/articles/1909/19/news005.html">アカネちゃん、JVNに謝辞が載る：こうしす！　こちら京姫鉄道 広報部システム課 ＠IT支線（17） - ＠IT</a></li>
</ul>
<p>逆に言えば、脆弱性レポートの段階では、その程度の効果しかありません。</p>
<h3 id="脆弱性の概要">脆弱性の概要</h3>
<p><a href="https://github.com/lestrrat-go/jwx">lestrrat-go/jwx</a>のJWEのデコード機能を利用する場合に、本脆弱性の影響を受ける可能性があります。</p>
<p>AES-CBCで暗号化されたデーターを復号するにはパディングを取り除く必要があります。
このとき不正なパディングを見つけた場合に &ldquo;failed to generate plaintext from decrypted blocks: invalid padding&rdquo; というエラーを返す実装になっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/lestrrat-go/jwx/blob/8840ffd4afc5839f591ff0e9ba9034af52b1643e/jwe/internal/aescbc/aescbc.go#L210-L213
</span><span class="c1"></span>	<span class="nx">plaintext</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">unpad</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">blockCipher</span><span class="p">.</span><span class="nf">BlockSize</span><span class="p">())</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">`failed to generate plaintext from decrypted blocks: %w`</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
</code></pre></div><p>パディングの検証結果をエラーとして返してしまうと、パディングオラクル攻撃を受ける可能性があります。</p>
<ul>
<li><a href="https://partender810.hatenablog.com/entry/2021/06/08/225105">Padding Oracle Attack 分かりやすく解説したい</a></li>
<li><a href="https://rintaro.hateblo.jp/entry/2017/12/31/174327">Padding Oracle AttackによるCBC modeの暗号文解読と改ざん</a></li>
</ul>
<p>ライブラリの利用者としては、エラーの内容について詳しいレポートがあるのはうれしいです。
しかし、セキュリティーに関わる文脈では、エラーの内容も攻撃材料に使われてしまうので、慎重にエラー報告しなければなりません。</p>
<p><a href="https://www.rfc-editor.org/rfc/rfc7516">RFC 7516 JSON Web Encryption (JWE)</a>にも実装時の考慮事項として、
このようなエラーは報告「してはなりません（MUST NOT）」と書いてあります。
（僕もこの脆弱性報告を書いていてはじめてRFCに記載があることを知った・・・）</p>
<blockquote>
<p>11.5.  Timing Attacks
To mitigate the attacks described in RFC 3218 [RFC3218], the
recipient MUST NOT distinguish between format, padding, and length
errors of encrypted keys.  It is strongly recommended, in the event
of receiving an improperly formatted key, that the recipient
substitute a randomly generated CEK and proceed to the next step, to
mitigate timing attacks.</p>
</blockquote>
<h2 id="報告の流れ">報告の流れ</h2>
<p>今までの脆弱性報告では、まず「連絡先を探す」というハードルがありました。
GitHubの脆弱性レポート機能を使えばGitHubが代わりにメンテナーへ連絡してくれるので、連絡先を探す手間はありません。</p>
<ul>
<li><a href="https://github.blog/jp/2023-04-26-private-vulnerability-reporting-now-generally-available/">プライベート脆弱性レポート機能の一般提供（GA）を開始 </a></li>
<li><a href="https://github.blog/2023-04-19-private-vulnerability-reporting-now-generally-available/">Private vulnerability reporting now generally available</a></li>
</ul>
<p>レポートにはGitHubの便利な機能もそのまま使えます。
だいたいドキュメントに書いてあるとおりですが、見ていきましょう。</p>
<ul>
<li><a href="https://docs.github.com/en/code-security/security-advisories/guidance-on-reporting-and-writing/privately-reporting-a-security-vulnerability">Privately reporting a security vulnerability</a></li>
</ul>
<h3 id="security-advisoryを作成する">Security Advisoryを作成する</h3>
<p>GitHubレポジトリのSecurityタブから「Report a vulnerability」というボタンを押すと、Security Advisoryを作成できます。
レポジトリごとの設定で無効化できてしまうので、万が一このボタンが表示されない場合は、諦めてメンテナーの連絡先を探しましょう。</p>
<p>脆弱性の概要・詳細・PoCなどを入力します。</p>
<p><img src="/images/2023-06-18-report-vulnerability-via-github-1.png" alt="Advisory Details"></p>
<p>僕の場合は以下の内容で報告しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="gu">### Summary
</span><span class="gu"></span>
Decrypting AES-CBC encrypted JWE has Potential Padding Oracle Attack Vulnerability.

<span class="gu">### Details
</span><span class="gu"></span>
On [<span class="nt">v2.0.10</span>](<span class="na">https://github.com/lestrrat-go/jwx/releases/tag/v2.0.10</span>), decrypting AES-CBC encrypted JWE may return an error &#34;failed to generate plaintext from decrypted blocks: invalid padding&#34;:

https://github.com/lestrrat-go/jwx/blob/8840ffd4afc5839f591ff0e9ba9034af52b1643e/jwe/internal/aescbc/aescbc.go#L210-L213

Reporting padding error causes [<span class="nt">Padding Oracle Attack</span>](<span class="na">https://en.wikipedia.org/wiki/Padding_oracle_attack</span>) Vulnerability.
RFC 7516 JSON Web Encryption (JWE) says that we <span class="gs">**MUST NOT**</span> do this.
<span class="k">
</span><span class="k">&gt; </span><span class="ge">11.5.  Timing Attacks
</span><span class="ge"></span><span class="k">&gt; </span><span class="ge">To mitigate the attacks described in RFC 3218 [RFC3218], the
</span><span class="ge"></span><span class="k">&gt; </span><span class="ge">recipient MUST NOT distinguish between format, padding, and length
</span><span class="ge"></span><span class="k">&gt; </span><span class="ge">errors of encrypted keys.  It is strongly recommended, in the event
</span><span class="ge"></span><span class="k">&gt; </span><span class="ge">of receiving an improperly formatted key, that the recipient
</span><span class="ge"></span><span class="k">&gt; </span><span class="ge">substitute a randomly generated CEK and proceed to the next step, to
</span><span class="ge"></span><span class="k">&gt; </span><span class="ge">mitigate timing attacks.
</span><span class="ge"></span>
In addition, the time to remove padding depends on the length of the padding.
It may leak the length of the padding by Timing Attacks.

https://github.com/lestrrat-go/jwx/blob/796b2a9101cf7e7cb66455e4d97f3c158ee10904/jwe/internal/aescbc/aescbc.go#L33-L66

To mitigate Timing Attacks, it MUST be done in constant time.

<span class="gu">### Impact
</span><span class="gu"></span>
The authentication tag is verified, so it is not an immediate attack.
</code></pre></div><p>報告すると、報告者とメンテナーのみ閲覧可能な状態になります。</p>
<h3 id="一時的なプライベートレポジトリを作成する">一時的なプライベートレポジトリを作成する</h3>
<p>「Start a temporary private fork」をクリックすると、非公開のレポジトリをフォークしてくれます。
通常のレポジトリと同じように<code>git clone</code>して、修正をコミットしましょう。</p>
<p><img src="/images/2023-06-18-report-vulnerability-via-github-2.png" alt="Start a temporary private fork"></p>
<p>プルリクエストも送ることができます。
upstreamに対してプルリクエストを送ると普通はフォーク元でプルリクエストが公開されますが、
プライベートレポジトリから送ったプルリクエストは非公開のままです。
以下の画像はお試しでgo-sfvのレポジトリでプルリクエストを作成してみた様子です。</p>
<p><img src="/images/2023-06-18-report-vulnerability-via-github-3.png" alt="Comparing changes"></p>
<h3 id="メンテナーからのリアクションを待つ">メンテナーからのリアクションを待つ</h3>
<p>メンテナーが脆弱性に対応してくれるのを待ちます。
僕の場合はその日のうちに<a href="https://twitter.com/lestrrat">@lestrrat</a>が反応して、修正をマージしてくれました。
いつ返信が返ってくるかはメンテナーの気分次第なので、気長に待ちましょう。</p>
<p>送った脆弱性レポートは、メンテナーが内容をチェックして修正したのち公開されます。
公開時に報告者宛に「Reporterとして公開していいか？」とGitHubからメッセージが来るので、名前を公開していい人は許諾します。</p>
<h2 id="まとめ">まとめ</h2>
<p>GitHubの脆弱性レポート機能を体験してみました。
いつも通りプルリクエストを送る感覚で報告できて便利でした。</p>
<ul>
<li><a href="https://github.com/lestrrat-go/jwx/security/advisories/GHSA-rm8v-mxj3-5rmq">GHSA-rm8v-mxj3-5rmq Potential Padding Oracle Attack Vulnerability</a></li>
</ul>
<p>今回僕は報告者という立場でしたが、
ソフトウェアをメンテナーをやっているひとは、<a href="https://github.com/settings/security_analysis">settings/security_analysis</a>からレポート受付を有効化しておくと良いでしょう。</p>
<p><img src="/images/2023-06-18-report-vulnerability-via-github-4.png" alt="Setting: Private vulnerability reporting"></p>
<p>あれ、GAのブログ記事が公開されたけど、Betaのまま・・・？</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://github.com/lestrrat-go/jwx">github.com/lestrrat-go/jwx</a></li>
<li><a href="https://github.com/lestrrat-go/jwx/security/advisories/GHSA-rm8v-mxj3-5rmq">GHSA-rm8v-mxj3-5rmq Potential Padding Oracle Attack Vulnerability</a></li>
<li><a href="https://docs.github.com/en/code-security/security-advisories/guidance-on-reporting-and-writing/privately-reporting-a-security-vulnerability">Privately reporting a security vulnerability</a></li>
<li><a href="https://github.blog/jp/2023-04-26-private-vulnerability-reporting-now-generally-available/">プライベート脆弱性レポート機能の一般提供（GA）を開始 </a></li>
<li><a href="https://github.blog/2023-04-19-private-vulnerability-reporting-now-generally-available/">Private vulnerability reporting now generally available</a></li>
<li><a href="https://docs.github.com/en/code-security/getting-started/adding-a-security-policy-to-your-repository">Adding a security policy to your repository</a></li>
<li><a href="https://ja.wikipedia.org/wiki/%E8%84%86%E5%BC%B1%E6%80%A7%E6%83%85%E5%A0%B1%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9">脆弱性情報データベース</a></li>
<li><a href="https://www.ipa.go.jp/security/vuln/scap/cve.html">共通脆弱性識別子CVE概説 - IPA</a>
<ul>
<li><a href="https://megalodon.jp/2023-0618-1636-47/https://www.ipa.go.jp:443/security/vuln/scap/cve.html">魚拓</a></li>
</ul>
</li>
<li><a href="https://www.ipa.go.jp/security/todokede/vuln/uketsuke.html">脆弱性関連情報の届出受付 - IPA</a>
<ul>
<li><a href="https://megalodon.jp/2023-0618-1638-40/https://www.ipa.go.jp:443/security/todokede/vuln/uketsuke.html">魚拓</a></li>
</ul>
</li>
<li><a href="https://remoteroom.jp/diary/2020-04-19/">脆弱性情報をIPAへ報告して修正されました #情報処理安全確保支援士</a></li>
<li><a href="https://atmarkit.itmedia.co.jp/ait/articles/1909/19/news005.html">アカネちゃん、JVNに謝辞が載る：こうしす！　こちら京姫鉄道 広報部システム課 ＠IT支線（17） - ＠IT</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc7516">RFC 7516 JSON Web Encryption (JWE)</a></li>
<li><a href="https://partender810.hatenablog.com/entry/2021/06/08/225105">Padding Oracle Attack 分かりやすく解説したい</a></li>
<li><a href="https://rintaro.hateblo.jp/entry/2017/12/31/174327">Padding Oracle AttackによるCBC modeの暗号文解読と改ざん</a></li>
</ul>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">ICHINOSE Shogo</span></span>
    
    <time>Jun 18, 2023</time>
    
    </span>
  </p>

  

  <p class="meta">
    
        <a class="basic-alignment left" href="https://shogo82148.github.io/blog/2023/05/29/2023-05-29-why-you-should-not-use-timestamp-as-id/" title="なぜタイムスタンプをIDとして扱ってはいけないのか">なぜタイムスタンプをIDとして扱ってはいけないのか</a>
    

    
      <a class="basic-alignment right" href="https://shogo82148.github.io/blog/2023/06/22/2023-06-22-go-loopvar-experiment/" title="Go 1.22で導入されるforループ変数の変更">Go 1.22で導入されるforループ変数の変更</a>
    
  </p>
  
    
      <div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
      
      
      
      if (window.location.hostname == "localhost")
          return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'shogosblog';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      <a target="_blank" href="https://github.com/shogo82148/" title="https://github.com/shogo82148/"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a target="_blank" href="https://twitter.com/shogo82148/" title="https://twitter.com/shogo82148/"><i class="fa fa-twitter fa-3x"></i></a>
      
         
      
      
      
      
      
      
      
      

    
    
    </li>
  </ul>

  

  

  
  
  
    
      <section class="even">
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
          
          
            
          
            
              <li class="post">
                <a href="/blog/2023/09/21/2023-09-21-start-http-server/">ぼくのかんがえたさいきょうのGo HTTPサーバー起動方法</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2023/09/18/2023-09-18-go-comment-eraser/">Goのコメント全部消す</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2023/09/16/2023-09-16-choose-a-license-in-japanese/">ChooseALicense.com の日本語訳を公開しました</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2023/09/14/2023-09-14-cfn-ecdsa-acm/">CloudFormationでECDSA形式のTLS証明書が取れた</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2023/09/10/2023-09-10-logrus-slog-hook/">log/slogにログを転送する logrus hook を書いた</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2023/09/08/2023-09-08-actions-checkout-v4/">actions/checkout@v4の襲撃を受けた件</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2023/09/04/2023-09-04-generate-random-float/">ぼくのかんがえたさいきょうの[0.0, 1.0)の乱数を得るための方法</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2023/09/03/2023-09-03-gyotaku/">ウェブ魚拓の創業者のインタビュー記事のウェブ魚拓</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2023/09/03/2023-09-03-shonanpm-no-1/">湘南.pm #1 で「趣味でPerlのビルドをしている話」をしてきた</a>
              </li>
            
          
        </ul>
      </section>
    
  
</aside>

  </div>
</div>

<footer role="contentinfo">
  <p>Copyright &copy; 2023 ICHINOSE Shogo - <a
      href="https://shogo82148.github.io/license/">License</a> -
    <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank"
        href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
  </p>
</footer>









</body>

</html>

