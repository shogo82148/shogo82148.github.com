
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>ACMのドメイン検証をシミュレートするやつ書いた - Shogo's Blog</title>
  <meta name="author" content="Shogo Ichinose">

  
  <meta name="description" content="始まりは一件のメールから。 Title: Action Required - Your certificate renewal Greetings from Amazon Web Services, You have an AWS Certificate Manager (ACM) &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://shogo82148.github.io/blog/2017/10/22/aws-certification-manager-validation/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Shogo's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4526627-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script type="text/javascript" src="//s.hatena.ne.jp/js/HatenaStar.js"></script>
<script type="text/javascript">
Hatena.Star.Token = '0da43945db72b59fd47eb24198fc7a0293c0191f';
Hatena.Star.SiteConfig = {
  entryNodes: {
    'article': {
      uri: 'h1 a',
      title: 'h1',
      container: 'h1'
    },
    'article.hentry': {
      uri: 'window.location',
      title: 'h1.entry-title',
      container: 'h1.entry-title'
    }
  }
};
</script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Shogo's Blog</a></h1>
  
    <h2>たぶんプログラミングとかについて書いていくブログ</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="shogo82148.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">ACMのドメイン検証をシミュレートするやつ書いた</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-10-22T15:45:02+09:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>3:45 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>始まりは一件のメールから。</p>

<blockquote><p>Title: Action Required - Your certificate renewal</p>

<p>Greetings from Amazon Web Services,</p>

<p>You have an AWS Certificate Manager (ACM) provided SSL/TLS certificate in your AWS account that expires on Nov 04, 2017 at 12:00:00 UTC. That certificate has the following domains:
example.com, *.example.com</p>

<p>AWS account ID: xxxxxx
AWS Region name: us-east-1
Certificate identifier: arn:aws:acm:us-east-1:xxxxxx:certificate/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</p>

<p>Therefore, ACM has initiated the process to renew this certificate. You must take the action below before Nov 04, 2017 at 12:00:00 UTC to avoid certificate expiration, which might cause your website to become unreachable.
To complete the renewal of this certificate, the domain owners must use the approval link that was sent in separate validation request emails. Those emails were last sent on Sep 20, 2017 at 12:11:48 UTC.
以下略</p></blockquote>

<p>要約すると、AWS Certificate Manager (以下ACM)で管理している証明書の自動更新に失敗したので、
手動更新をしてくれとのこと。</p>

<p>このメールの対応方法についてのメモと、次回から自動更新に成功するようおこなった設定について書きます。
ついでに確認用のツールも作ったので、その紹介も。</p>

<ul>
<li><a href="https://github.com/shogo82148/go-acm-checker">shogo82148/go-acm-checker</a></li>
</ul>


<!-- More -->


<h2>手動での対応方法</h2>

<p>メール以下のページへのリンクが貼られているので、これに従えば基本的にはOK。</p>

<ul>
<li><a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/resend-email-ssl/">I didn&rsquo;t receive a validation email for the SSL certificate I requested through AWS Certificate Manager</a></li>
</ul>


<p>日本語だと Developers.IO さんの記事が詳しいです。</p>

<ul>
<li><a href="https://dev.classmethod.jp/etc/acm-expire-cation/">ACMで管理されているSSL/TLS証明書の自動更新失敗について</a></li>
</ul>


<blockquote><ol>
<li>AWSマネジメントコンソールにログイン</li>
<li>Certificate Managerを選択</li>
<li>更新対象の証明書チェックボタンを選択</li>
<li>[アクション]-[検証Eメールの再送信]を選択</li>
<li>検証メールアドレスに送信された「Certificate approval for &lt;ドメイン名>」に記載されている「Amazon Certificate Approvals」を選択</li>
<li>承認ページが表示されますので、ドメイン名・AWSアカウントID・証明書識別子に相違がないことを確認して「I Approve」を選択</li>
<li>「Success」が表示されることを確認</li>
<li>Certificate Managerに戻って頂き、証明書の更新ステータスが「成功」になっていることを確認</li>
</ol>
</blockquote>

<h2>頑張って自動更新を有効にする</h2>

<p>しかしまあ、更新作業が面倒でACMを使っているというのに、
13ヶ月ごとに更新作業をするのは面倒です。</p>

<p>以下のドキュメントを参考に、自動更新が有効になるよう設定しましょう。</p>

<ul>
<li><a href="http://docs.aws.amazon.com/ja_jp/acm/latest/userguide/configure-domain-for-automatic-validation.html">自動検証のためにドメインを設定する</a></li>
</ul>


<blockquote><ul>
<li>ACM によって証明書の各ドメインと HTTPS 接続を確立できる必要があります。</li>
<li>各接続では、返される証明書が ACM が更新している証明書と一致する必要があります。</li>
</ul>
</blockquote>

<h2>証明書のシリアル番号チェッカーを書いてみた</h2>

<p>HTTPS接続の確立は <code>curl</code> を使って一発ですが、
「返される証明書が ACM が更新している証明書と一致する」のを確認するのはなかなか骨です。
一応、Chromeのデベロッパーコンソール→Securityタブ→View Certificate→詳細な情報→シリアル番号と辿っていけば、
ACMに表示されているシリアル番号との一致を確認できます。
コンソールから確認できないものかと少しググったのですが、見つけられませんでした。</p>

<p>ということで、Go言語でシリアル番号を表示するツールをサクッと書いてみました。
<code>go run main.go https://example.com</code> で実行できます。
こういうのがすぐに書けるのがGoのいいところですね。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>  <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>  <span class="s">&quot;os&quot;</span>
</span><span class='line'>  <span class="s">&quot;strings&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">DefaultClient</span><span class="p">.</span><span class="nx">CheckRedirect</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">via</span> <span class="p">[]</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ErrUseLastResponse</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">serial</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">TLS</span><span class="p">.</span><span class="nx">PeerCertificates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">SerialNumber</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">s</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">serial</span><span class="p">))</span>
</span><span class='line'>  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">b</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">serial</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">s</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="p">))</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>自動検証シミュレーター</h2>

<p>複数のドメインを管理しているとシリアル番号の確認をするのも面倒になってきたので、
ACMに登録されている証明書を検証するシミュレーターを書いてみました。</p>

<ul>
<li><a href="https://github.com/shogo82148/go-acm-checker">shogo82148/go-acm-checker</a></li>
</ul>


<p>Go製のツールなので、おなじみの<code>go get</code>でインストールできます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>go get -u github.com/shogo82148/go-acm-checker</span></code></pre></td></tr></table></div></figure>


<p>実行するとACMで管理されている証明書の情報を全リージョンから取ってきて、
検証を試みます。
検証に成功すると以下のようなメッセージが表示されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go-acm-checker
</span><span class='line'>2017/10/21 14:30:04 success to validate example.com(arn:aws:acm:us-east-1:1234567890:certificate/00000000-0000-0000-0000-000000000000)</span></code></pre></td></tr></table></div></figure>


<p>検証に失敗すると、どのドメインの検証に失敗したかを教えてくれます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go-acm-checker
</span><span class='line'>2017/10/21 14:30:05 failed to validate example.com
</span><span class='line'>2017/10/21 14:30:05 failed to validate *.example.com
</span><span class='line'>2017/10/21 14:30:05 failed to validate example.com(arn:aws:acm:us-east-1:1234567890:certificate/00000000-0000-0000-0000-000000000000)</span></code></pre></td></tr></table></div></figure>


<p>検証に失敗した場合、「<a href="http://docs.aws.amazon.com/ja_jp/acm/latest/userguide/configure-domain-for-automatic-validation.html">自動検証のためにドメインを設定する</a>」を参考に、
<code>https://example.com/</code> や <code>https://www.example.com/</code> に正常にアクセスできる状態にしてください。</p>

<h2>まとめ</h2>

<p>AMCの手動更新の方法と、自動更新を有効化するための方法を簡単にまとめてみました。
なお、 <a href="https://github.com/shogo82148/go-acm-checker">shogo82148/go-acm-checker</a> で検証成功したからといって、
ACMの検証が必ず成功するとは限りません。
自動更新だからと油断せずに、こまめにメールはチェックしましょうね。</p>

<p>(ちなみに今回メールが来たドメインは自動更新できるように設定し直したけど、自動更新のタイミングがよくわからないので、いつ手動更新をやるかチキンレースの真っ最中です・・・)</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Shogo Ichinose</span></span>

      




<time class='entry-date' datetime='2017-10-22T15:45:02+09:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>3:45 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/go/'>go</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//b.hatena.ne.jp/entry/https://shogo82148.github.io/blog/2017/10/22/aws-certification-manager-validation/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"><img src="//b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="//b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://shogo82148.github.io/blog/2017/10/22/aws-certification-manager-validation/" data-via="shogo82148" data-counturl="https://shogo82148.github.io/blog/2017/10/22/aws-certification-manager-validation/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/08/25/unicode9-grapheme-cluster/" title="Previous Post: Perl 5.26 & Unicode 9.0 で変わる書記素クラスタ(grapheme cluster)のお話">&laquo; Perl 5.26 & Unicode 9.0 で変わる書記素クラスタ(grapheme cluster)のお話</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/10/22/aws-certification-manager-validation/">ACMのドメイン検証をシミュレートするやつ書いた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/25/unicode9-grapheme-cluster/">Perl 5.26 & Unicode 9.0 で変わる書記素クラスタ(grapheme Cluster)のお話</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/26/go19-monotonic-clock/">Go1.9から使える Monotonic Clocks を試してみた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/16/mysql-driver-and-context/">ぼくのかんがえたさいきょうのcontext対応版go-mysql-driverをマージしてもらった</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/05/30/grumpy/">Re: GoとPythonとGrumpyの速度ベンチマーク</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/shogo82148">@shogo82148</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'shogo82148',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Shogo Ichinose -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'shogosblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://shogo82148.github.io/blog/2017/10/22/aws-certification-manager-validation/';
        var disqus_url = 'https://shogo82148.github.io/blog/2017/10/22/aws-certification-manager-validation/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
