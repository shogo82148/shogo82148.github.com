<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
    
    
      <link href="/css/fonts.css" rel="stylesheet" type="text/css">
    
  

  
  <title>PerlのDBIx::Class利用上の注意点</title>

  
  
  <link rel="stylesheet" href="/css/hugo-octopress.css">

  
  
    <link rel="stylesheet" href="https://shogo82148.github.io/css/syntax.css">
  

  
    <link rel="stylesheet" href="/css/fork-awesome.min.css">
  

  
  <link href="https://shogo82148.github.io/favicon.png" rel="icon">

  
  

  <meta name="description" content="" />
  <meta name="keywords" content="">
  <meta name="author" content="Shogo Ichinose">

  
  <meta name="generator" content="Hugo 0.75.1" />

  
  

  
  
</head>
<body>


<header role="banner">
<hgroup>
  
  <h1><a href="https://shogo82148.github.io/">Shogo&#39;s Blog</a></h1>
  <h2></h2>
</hgroup>
</header>


<nav role="navigation">
<fieldset class="mobile-nav">
  
  <select onchange="location = this.value;">
    <option value="">Navigate…</option>
      
  </select>
</fieldset>


<ul class="main-navigation">
  
  
</ul>

<ul class="subscription">
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:https://shogo82148.github.io/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
  <p class="meta">Dec 17, 2015
     - 6 minute read 
     - <a href="https://shogo82148.github.io/blog/2015/12/17/dbix-class/#disqus_thread">Comments</a>

    
    
      - <a class="label" href="https://shogo82148.github.io/categories/perl/">perl </a>
    
  </p>
  <h1 class="entry-title">
     PerlのDBIx::Class利用上の注意点 
  </h1>
</header>


        <div class="entry-content">
          
          
          
          
          <p>この記事は、<a href="http://qiita.com/advent-calendar/2015/perl5">Perl 5 Advent Calendar</a>の17日目の記事です。</p>
<p><a href="http://tech.kayac.com/archive/reconnect_redisfast.html">Redis::Fast の reconnect について</a>の中で
<a href="https://metacpan.org/release/DBIx-Class">DBIx::Class</a>のreconnectについても触れています。
DBIx::Classの安全にreconnectionが行えるように考慮されていますが、色々と注意点があります。
reconnection周りで調べてみたので、Advent Calendarの枠を借りてまとめたいと思います。</p>
<h2 id="dbixclassとは">DBIx::Classとは</h2>
<p><a href="https://metacpan.org/release/DBIx-Class">DBIx::Class</a>はPerlのO/Rマッピングモジュールです。
テーブル間のリレーションを定義でき、JOIN句の入ったクエリもサポートする等、かなり高機能なモジュールです。
もう僕はJOIN句をDBIx::Class以外で書ける気がしません。
詳しくはtypester先生の解説記事をどうぞ。</p>
<ul>
<li><a href="http://gihyo.jp/dev/serial/01/perl-hackers-hub">Perl Hackers Hub</a>
<ul>
<li><a href="http://gihyo.jp/dev/serial/01/perl-hackers-hub/000301">第3回　DBIx::Classでデータベース操作（1）</a></li>
<li><a href="http://gihyo.jp/dev/serial/01/perl-hackers-hub/000302">第3回　DBIx::Classでデータベース操作（2）</a></li>
<li><a href="http://gihyo.jp/dev/serial/01/perl-hackers-hub/000303">第3回　DBIx::Classでデータベース操作（3）</a></li>
</ul>
</li>
</ul>
<h2 id="サンプル">サンプル</h2>
<p>サンプルとしてユーザの所持金を管理する簡単なアプリを作ってみます。
Webアプリとか作るの面倒だったので、コンソールアプリです。</p>
<div class="highlight"><pre class="chroma"><code class="language-perl" data-lang="perl"><span class="k">package</span> <span class="nn">My::Schema::User</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">base</span> <span class="s">&#39;DBIx::Class::Core&#39;</span><span class="p">;</span>

    <span class="nn">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">);</span>

    <span class="nn">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">add_columns</span><span class="p">(</span>
        <span class="n">id</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">data_type</span>         <span class="o">=&gt;</span> <span class="s">&#39;INTEGER&#39;</span><span class="p">,</span>
            <span class="n">is_nullable</span>       <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">is_auto_increment</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">username</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">data_type</span>   <span class="o">=&gt;</span> <span class="s">&#39;VARCHAR&#39;</span><span class="p">,</span>
            <span class="n">size</span>        <span class="o">=&gt;</span> <span class="mi">255</span><span class="p">,</span>
            <span class="n">is_nullable</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">);</span>

    <span class="nn">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">set_primary_key</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">);</span>

    <span class="c1"># userとmoneyは1対1の関係で、userに対応するmoneyが必ず存在しなければならない</span>
    <span class="nn">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">has_one</span><span class="p">(</span>
        <span class="s">&#39;money&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;My::Schema::Money&#39;</span><span class="p">,</span>
        <span class="p">{</span> <span class="s">&#39;foreign.user_id&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;self.id&#39;</span> <span class="p">},</span>
    <span class="p">);</span>

    <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">package</span> <span class="nn">My::Schema::Money</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">base</span> <span class="s">&#39;DBIx::Class::Core&#39;</span><span class="p">;</span>

    <span class="nn">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;money&#39;</span><span class="p">);</span>

    <span class="nn">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">add_columns</span><span class="p">(</span>
        <span class="n">user_id</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">data_type</span>   <span class="o">=&gt;</span> <span class="s">&#39;INTEGER&#39;</span><span class="p">,</span>
            <span class="n">is_nullable</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">yen</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">data_type</span>   <span class="o">=&gt;</span> <span class="s">&#39;INTEGER&#39;</span><span class="p">,</span>
            <span class="n">is_nullable</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">);</span>

    <span class="nn">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">set_primary_key</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">);</span>

    <span class="nn">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">belongs_to</span><span class="p">(</span>
        <span class="s">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;My::Schema::User&#39;</span><span class="p">,</span>
        <span class="p">{</span> <span class="s">&#39;foreign.id&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;self.user_id&#39;</span> <span class="p">},</span>
    <span class="p">);</span>

    <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">package</span> <span class="nn">My::Schema</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">base</span> <span class="s">&#39;DBIx::Class::Schema&#39;</span><span class="p">;</span>

    <span class="nn">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">load_classes</span><span class="p">(</span><span class="sx">qw/User Money/</span><span class="p">);</span>

    <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">use</span> <span class="nn">feature</span> <span class="s">&#39;say&#39;</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$schema</span> <span class="o">=</span> <span class="nn">My::Schema</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="s">&#39;dbi:mysql:host=127.0.0.1;port=3306;database=test;mysql_write_timeout=1;mysql_read_timeout=1&#39;</span><span class="p">,</span> <span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
<span class="nv">$schema</span><span class="o">-&gt;</span><span class="nn">storage</span><span class="o">-&gt;</span><span class="nn">dbh</span><span class="o">-&gt;</span><span class="k">do</span><span class="p">(</span><span class="s">&#39;DROP TABLE IF EXISTS money, user&#39;</span><span class="p">);</span>
<span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">deploy</span><span class="p">;</span>
</code></pre></div><p>実行するとMySQLのデータベースに以下のようなテーブルが作成されます。
userテーブルはユーザの名前を管理するテーブル、moneyはユーザの所持金を管理するテーブルです。</p>
<pre><code>mysql&gt; desc user;
+----------+--------------+------+-----+---------+----------------+
| Field    | Type         | Null | Key | Default | Extra          |
+----------+--------------+------+-----+---------+----------------+
| id       | int(11)      | NO   | PRI | NULL    | auto_increment |
| username | varchar(255) | NO   |     | NULL    |                |
+----------+--------------+------+-----+---------+----------------+
2 rows in set (0.00 sec)

mysql&gt; desc money;
+---------+---------+------+-----+---------+-------+
| Field   | Type    | Null | Key | Default | Extra |
+---------+---------+------+-----+---------+-------+
| user_id | int(11) | NO   | PRI | NULL    |       |
| yen     | int(11) | NO   |     | NULL    |       |
+---------+---------+------+-----+---------+-------+
2 rows in set (0.00 sec)
</code></pre><h2 id="タイムアウトとロールバックの微妙な関係">タイムアウトとロールバックの微妙な関係</h2>
<h3 id="ユーザの初期化プログラムを実装してみる">ユーザの初期化プログラムを実装してみる</h3>
<p>テーブル作っただけではつまらないので、データを入れてみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-perl" data-lang="perl"><span class="c1"># スキーマ定義等略</span>

<span class="c1"># ユーザ作成</span>
<span class="k">my</span> <span class="nv">$user_rs</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">resultset</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">);</span>
<span class="nb">eval</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="c1"># ユーザを初期化するためクエリ(ちょっと時間がかかる)</span>
    <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({},</span> <span class="p">{</span><span class="nb">select</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="s">&#39;SLEEP(1)&#39;</span><span class="p">})</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">;</span>
    <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>
<span class="p">};</span>
<span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;名前: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&#34;所持金: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="nn">money</span><span class="o">-&gt;</span><span class="n">yen</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;ユーザが見つかりませんでした&#34;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>実行してみると、1000円持ったユーザが作成されます。</p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">$ perl dbic-test.pl
名前: ok_macopy
所持金: 1000
</code></pre></div><h3 id="タイムアウトと戦う">タイムアウトと戦う</h3>
<p>一件上手く動いていそうに見えますが、上記コードを何回か実行すると、ときたま以下のように失敗します。</p>
<pre><code>$ perl dbic-test.pl
DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: Lost connection to MySQL server during query [for Statement &quot;SELECT SLEEP(1) FROM user me&quot;] at dbic-test.pl line 80
名前: ok_macopy
所持金: 0
</code></pre><p>所持金が0円になってしまいました。
<code>SELECT SLEEP(1) FROM user me</code> という時間のかかるクエリを投げたので、コネクションがタイムアウトしてしまったようです。
データベースの状態を確認すると、userに行はあるけど、moneyは空っぽの状態です。
「userに対応するmoneyが必ず存在しなければならない」とスキーマで定義したのに、その条件を満たしていませんね。
たとえタイムアウトしたとしても、このような状態にはならないで欲しいです。</p>
<pre><code>mysql&gt; SELECT * FROM user;
+----+-----------+
| id | username  |
+----+-----------+
|  1 | ok_macopy |
+----+-----------+
1 row in set (0.00 sec)

mysql&gt; SELECT * FROM money;
Empty set (0.00 sec)
</code></pre><h3 id="トランザクションを使ってみる">トランザクションを使ってみる</h3>
<p>リレーショナルデータベースにはこれを実現するためにトランザクションという便利なものがあります。
DBIx::Classから扱うにはいくつか方法がありますが、例えばガードオブジェクトを使って以下のように書けます。</p>
<div class="highlight"><pre class="chroma"><code class="language-perl" data-lang="perl"><span class="c1"># ユーザ作成</span>
<span class="k">my</span> <span class="nv">$user_rs</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">resultset</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">);</span>
<span class="nb">eval</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="c1"># ユーザを初期化するためクエリ(ちょっと時間がかかる)</span>
    <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({},</span> <span class="p">{</span><span class="nb">select</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="s">&#39;SLEEP(1)&#39;</span><span class="p">})</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">;</span>
    <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>

    <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;名前: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&#34;所持金: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span> <span class="p">?</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="nn">money</span><span class="o">-&gt;</span><span class="n">yen</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;ユーザが見つかりませんでした&#34;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>これで片一方だけ更新されるのが防げるはず！
ところが、片一方だけ更新自体は防げはするのですが、
今度は所持金を表示するところでコケてしまいます。
トランザクションを使っていないときは正常に表示できていたし、
表示部分は一切いじってないのに不思議ですね。</p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">$ perl dbic-test.pl
Transaction aborted: DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: Lost connection to MySQL server during query [for Statement &#34;SELECT SLEEP(1) FROM user me&#34;] at dbic-test.pl line 80
 Rollback failed: DBIx::Class::Storage::DBI::_exec_txn_rollback(): DBI Exception: DBD::mysql::db rollback failed: Turning on AutoCommit failed at dbic-test.pl line 72
DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: MySQL server has gone away [for Statement &#34;SELECT me.id, me.username FROM user me WHERE ( id = ? )&#34; with ParamValues: 0=1] at dbic-test.pl line 89
# ※「ユーザが見つかりませんでした」と表示されて欲しいがされない
</code></pre></div><p>実はコネクションがタイムアウトしたとはMySQLとの再接続をする必要があるのですが、
DBIx::Classが裏で再接続処理を自動的にやってくれるので、普段は意識する必要はありません。
ただし例外があって、 <strong>トランザクションの中では再接続処理を行ってくれません</strong> 。</p>
<p>トランザクション内で勝手に再接続が行われると逆に困るので、この挙動自体は正しいのですが、
これにロールバックが絡むと少し不思議なことが起こります。
<strong>ロールバックしてトランザクションを抜けても、DBIx::Classはトランザクションの中にいると判断してしまうのです。</strong>
このことは<code>transaction_depth</code>を見ることで確認できます。</p>
<div class="highlight"><pre class="chroma"><code class="language-perl" data-lang="perl"><span class="c1"># ユーザ作成</span>
<span class="k">my</span> <span class="nv">$user_rs</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">resultset</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">);</span>
<span class="n">say</span> <span class="s">&#39;transaction_depth = &#39;</span><span class="p">,</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="nn">storage</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">transaction_depth</span><span class="p">};</span>
<span class="nb">eval</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&#39;transaction_depth = &#39;</span><span class="p">,</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="nn">storage</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">transaction_depth</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="c1"># ユーザを初期化するためクエリ(ちょっと時間がかかる)</span>
    <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({},</span> <span class="p">{</span><span class="nb">select</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="s">&#39;SLEEP(1)&#39;</span><span class="p">})</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">;</span>
    <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>

    <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">say</span> <span class="s">&#39;transaction_depth = &#39;</span><span class="p">,</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="nn">storage</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">transaction_depth</span><span class="p">};</span>

<span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;名前: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&#34;所持金: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span> <span class="p">?</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="nn">money</span><span class="o">-&gt;</span><span class="n">yen</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;ユーザが見つかりませんでした&#34;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">$ perl dbic-test.pl
transaction_depth = 0
transaction_depth = 1
Transaction aborted: DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: Lost connection to MySQL server during query [for Statement &#34;SELECT SLEEP(1) FROM user me&#34;] at dbic-test.pl line 82
 Rollback failed: DBIx::Class::Storage::DBI::_exec_txn_rollback(): DBI Exception: DBD::mysql::db rollback failed: Turning on AutoCommit failed at dbic-test.pl line 73
transaction_depth = 1 # ※トランザクションの外なのに1になってる
DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: MySQL server has gone away [for Statement &#34;SELECT me.id, me.username FROM user me WHERE ( id = ? )&#34; with ParamValues: 0=1] at dbic-test.pl line 92
</code></pre></div><p>この状態になるといつまで経っても再接続は行われません。
都度接続なら大きな問題にはならないのですが、Webアプリでコネクションの永続化を行っている場合は深刻です。
一度タイムアウトすると以後のリクエストがすべて失敗してしまいます。</p>
<h3 id="確実に再接続を行う">確実に再接続を行う</h3>
<p>これを防ぐには確実に再接続をおこなって欲しいところで <code>$schema-&gt;storage-&gt;ensure_connected;</code> を実行します。</p>
<div class="highlight"><pre class="chroma"><code class="language-perl" data-lang="perl"><span class="c1"># ユーザ作成</span>
<span class="k">my</span> <span class="nv">$user_rs</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">resultset</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">);</span>
<span class="nb">eval</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="c1"># ユーザを初期化するためクエリ(ちょっと時間がかかる)</span>
    <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({},</span> <span class="p">{</span><span class="nb">select</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="s">&#39;SLEEP(1)&#39;</span><span class="p">})</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">;</span>
    <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>

    <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$schema</span><span class="o">-&gt;</span><span class="nn">storage</span><span class="o">-&gt;</span><span class="n">ensure_connected</span><span class="p">;</span> 

<span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;名前: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&#34;所持金: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span> <span class="p">?</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="nn">money</span><span class="o">-&gt;</span><span class="n">yen</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;ユーザが見つかりませんでした&#34;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>こうすることで、何度実行しても「所持金1000のユーザが作られる」or「ユーザが見つかりませんでした」の状態になり、
中途半端な状態のユーザが作られたり、再接続に失敗したりということはなくなります。</p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">$ perl dbic-test.pl
Transaction aborted: DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: Lost connection to MySQL server during query [for Statement &#34;SELECT SLEEP(1) FROM user me&#34;] at dbic-test.pl line 80
 Rollback failed: DBIx::Class::Storage::DBI::_exec_txn_rollback(): DBI Exception: DBD::mysql::db rollback failed: Turning on AutoCommit failed at dbic-test.pl line 72
        (in cleanup) {UNKNOWN}: DBI Exception: DBD::mysql::db DESTROY failed: MySQL server has gone away  at /home/ichinose/.plenv/versions/5.20.2/lib/perl5/site_perl/5.20.2/DBIx/Class/Schema.pm line 1077.
        DBIx::Class::Schema::throw_exception(My::Schema=HASH(0x118d088), &#34;DBI Exception: DBD::mysql::db DESTROY failed: MySQL server ha&#34;...) called at /home/ichinose/.plenv/versions/5.20.2/lib/perl5/site_perl/5.20.2/DBIx/Class/Storage.pm line 113
        DBIx::Class::Storage::throw_exception(DBIx::Class::Storage::DBI::mysql=HASH(0x118d718), &#34;DBI Exception: DBD::mysql::db DESTROY failed: MySQL server ha&#34;...) called at /home/ichinose/.plenv/versions/5.20.2/lib/perl5/site_perl/5.20.2/DBIx/Class/Storage/DBI.pm line 1473
        DBIx::Class::Storage::DBI::__ANON__(&#34;DBD::mysql::db DESTROY failed: MySQL server has gone away&#34;, DBI::db=HASH(0x16efbb8), undef) called at dbic-test.pl line 91
        eval {...} called at dbic-test.pl line 91

ユーザが見つかりませんでした
</code></pre></div><h2 id="ネストしたトランザクションとロールバックの微妙な関係">ネストしたトランザクションとロールバックの微妙な関係</h2>
<h3 id="トランザクションをネストする">トランザクションをネストする</h3>
<p>キャンペーン期間中なので通常1000円のところ2000円で初期化してあげることになりました。
<strong>2000円への更新処理の途中で何かエラーが起こった場合は1000円で初期化して欲しい</strong> ので、
以下のようにトランザクションをネストしてみました。</p>
<div class="highlight"><pre class="chroma"><code class="language-perl" data-lang="perl"><span class="nb">eval</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="c1"># ユーザを初期化するためクエリ</span>
    <span class="k">my</span> <span class="nv">$money</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>

    <span class="c1"># キャンペーン期間中なので2000円で初期化してげよう</span>
    <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$txn2</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
        <span class="nv">$money</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">({</span><span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">});</span>
        <span class="nb">undef</span> <span class="nv">$txn2</span><span class="p">;</span> <span class="c1"># エラーが起こったのでロールバックして欲しい！1000円にもどって!!</span>
    <span class="p">}</span>

    <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$schema</span><span class="o">-&gt;</span><span class="nn">storage</span><span class="o">-&gt;</span><span class="n">ensure_connected</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;名前: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&#34;所持金: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="nn">money</span><span class="o">-&gt;</span><span class="n">yen</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;ユーザが見つかりませんでした&#34;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>わざとエラーが起こるようにして実行してみましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">$ perl dbic-test.pl
DBIx::Class::Storage::TxnScopeGuard::DESTROY(): A DBIx::Class::Storage::TxnScopeGuard went out of scope without explicit commit or error. Rolling back. at dbic-test.pl line 88
名前: ok_macopy
所持金: 2000
</code></pre></div><p>2000円！</p>
<p><strong>「Rolling back」って出てるのに全然ロールバックされてない！</strong></p>
<h3 id="save-pointを使う">SAVE POINTを使う</h3>
<p>接続時に<code>auto_savepoint</code>オプションを有効にすると、<code>SAVE POINT</code>を使った部分的なロールバックが使用可能になります。</p>
<div class="highlight"><pre class="chroma"><code class="language-perl" data-lang="perl"><span class="k">my</span> <span class="nv">$schema</span> <span class="o">=</span> <span class="nn">My::Schema</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="s">&#39;dbi:mysql:host=127.0.0.1;port=3306;database=test;mysql_write_timeout=1;mysql_read_timeout=1&#39;</span><span class="p">,</span> <span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">auto_savepoint</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">$ perl dbic-test.pl
DBIx::Class::Storage::TxnScopeGuard::DESTROY(): A DBIx::Class::Storage::TxnScopeGuard went out of scope without explicit commit or error. Rolling back. at dbic-test.pl line 90
名前: ok_macopy
所持金: 1000
</code></pre></div><h3 id="大人しく全部ロールバックする">大人しく全部ロールバックする</h3>
<p>MySQLにはSAVE POINTという便利機能があるとはいえ、どこまでロールバックするべきかを管理するのはすごく大変です。
現実的には ALL or NOTHING、失敗したら全部ロールバックで十分なのではと思ってます。
このサンプルではdieしてしまえばいいですね。</p>
<div class="highlight"><pre class="chroma"><code class="language-perl" data-lang="perl"><span class="nb">eval</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="c1"># ユーザを初期化するためクエリ</span>
    <span class="k">my</span> <span class="nv">$money</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>

    <span class="c1"># キャンペーン期間中なので2000円で初期化してげよう</span>
    <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$txn2</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
        <span class="nv">$money</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">({</span><span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">});</span>
        <span class="nb">die</span> <span class="s">&#39;something error!&#39;</span><span class="p">;</span> <span class="c1"># エラーが起こったのでロールバックして欲しい！1000円にもどって!!</span>
    <span class="p">}</span>

    <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$schema</span><span class="o">-&gt;</span><span class="nn">storage</span><span class="o">-&gt;</span><span class="n">ensure_connected</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;名前: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
    <span class="n">say</span> <span class="s">&#34;所持金: &#34;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="nn">money</span><span class="o">-&gt;</span><span class="n">yen</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">say</span> <span class="s">&#34;ユーザが見つかりませんでした&#34;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">something error! at dbic-test.pl line 85.
ユーザが見つかりませんでした
</code></pre></div><p>途中で<code>eval</code>して例外キャッチしているとロールバックしたのにコミットされる現象が起こる
(その場合警告すら出ないっぽいので更に怖い)ので、例外握り潰していたら要注意です。</p>
<p>部分的なロールバックができない場合は、
「子トランザクションがロールバックされていたら親トランザクションのコミットが失敗する」
が安全だと思うんですが、なぜこんな挙動になっているんでしょうね。
誰か経緯についてご存知のかたは教えていただきたいです。</p>
<h2 id="まとめ">まとめ</h2>
<ul>
<li>トランザクション外では自動的に再接続してくれるが、トランザクション内では行われない</li>
<li>必ず再接続して欲しいところで <code>$schema-&gt;storage-&gt;ensure_connected;</code></li>
<li>部分的なロールバックはやらないのが吉</li>
</ul>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Shogo Ichinose</span></span>
    
    <time>Dec 17, 2015</time>
    
    </span>
  </p>

  

  <p class="meta">
    
        <a class="basic-alignment left" href="https://shogo82148.github.io/blog/2015/12/16/customize-git-merge/" title="git-mergeの挙動をカスタマイズする">git-mergeの挙動をカスタマイズする</a>
    

    
      <a class="basic-alignment right" href="https://shogo82148.github.io/blog/2015/12/20/mecab-in-python3-final/" title="MeCabをPython3から使う(続報)">MeCabをPython3から使う(続報)</a>
    
  </p>
  
    
      <div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
      
      
      
      if (window.location.hostname == "localhost")
          return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'shogosblog';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      <a target="_blank" href="https://github.com/shogo82148/" title="https://github.com/shogo82148/"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a target="_blank" href="https://twitter.com/shogo82148/" title="https://twitter.com/shogo82148/"><i class="fa fa-twitter fa-3x"></i></a>
      
         
      
      
      
      
      
      
      
      

    
    
    </li>
  </ul>

  

  

  
  
  
    
      <section class="even">
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
          
          
            
              <li class="post">
                <a href="/blog/2021/03/17/actions-check-permissions/">Dependabot が起動する GitHub Actions Workflow から write 権限が無くなった件</a>
              </li>
            
          
            
          
            
              <li class="post">
                <a href="/blog/2021/03/02/perl-lambda-in-ap-northeast-3/">AWS Lambda Perl Runtime Layer in 大阪リージョン を公開しました</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2021/02/28/fix-ghq-list-fails-with-interrupted-system-call/">ghq list が interrupted system call で死ぬ問題を直した</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2021/02/23/improve-go-and-perl-polyglot/">改: PerlとGolangで実行できるPolyglot書いてみた</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2021/02/21/private-yum-repo-on-s3/">AWS Lambda &#43; S3 を使ってyumレポジトリを作った</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2021/02/03/setup-perl-uses-azure-blob-storage/">Setup Perl Environment Action のストレージを Azure Blob Storage に移行しました</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2021/01/29/super-ellipse/">スーパー楕円をベジェ曲線で近似してみる</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2021/01/02/perl-runtime-supports-docker-format/">Perl Runtime for AWS Lambda の Docker コンテナ対応を公開しました</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2020/12/30/github-actions-mutex/">排他制御を行う GitHub Action を作った</a>
              </li>
            
          
        </ul>
      </section>
    
  
</aside>

  </div>
</div>

<footer role="contentinfo">
  <p>Copyright &copy; 2021 Shogo Ichinose - <a
      href="https://shogo82148.github.io/license/">License</a> -
    <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank"
        href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
  </p>
</footer>










<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['\\(','\\)'], ['{% m %}', '{% em %}']],
    displayMath: [['\\[','\\]'], ['{% math %}', '{% endmath %}']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
})
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Queue(function() {
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  let all = MathJax.Hub.getAllJax()
  for(let o of all) {
      o.SourceElement().parentNode.className += ' has-jax'
  }
})
</script>

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>


<script>
  var _gaq = [['_setAccount', 'UA-4526627-4'], ['_trackPageview']];
  (function (d, t) {
    var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
    g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s)
  }(document, 'script'));
</script>

</body>

<script>
  var _gaq = [['_setAccount', 'UA-4526627-4'], ['_trackPageview']];
  (function (d, t) {
    var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
    g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s)
  }(document, 'script'));
</script>

</body>

</html>

