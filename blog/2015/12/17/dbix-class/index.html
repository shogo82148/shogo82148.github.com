
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>PerlのDBIx::Class利用上の注意点 - Shogo's Blog</title>
  <meta name="author" content="Shogo Ichinose">

  
  <meta name="description" content="この記事は、Perl 5 Advent Calendarの17日目の記事です。 Redis::Fast の reconnect についての中で
DBIx::Classのreconnectについても触れています。
DBIx::Classの安全にreconnectionが行えるように考慮されていますが &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://shogo82148.github.io/blog/2015/12/17/dbix-class/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Shogo's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4526627-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script type="text/javascript" src="//s.hatena.ne.jp/js/HatenaStar.js"></script>
<script type="text/javascript">
Hatena.Star.Token = '0da43945db72b59fd47eb24198fc7a0293c0191f';
Hatena.Star.SiteConfig = {
  entryNodes: {
    'article': {
      uri: 'h1 a',
      title: 'h1',
      container: 'h1'
    },
    'article.hentry': {
      uri: 'window.location',
      title: 'h1.entry-title',
      container: 'h1.entry-title'
    }
  }
};
</script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Shogo's Blog</a></h1>
  
    <h2>たぶんプログラミングとかについて書いていくブログ</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="shogo82148.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">PerlのDBIx::Class利用上の注意点</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-17T18:35:00+09:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:35 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>この記事は、<a href="http://qiita.com/advent-calendar/2015/perl5">Perl 5 Advent Calendar</a>の17日目の記事です。</p>

<p><a href="http://tech.kayac.com/archive/reconnect_redisfast.html">Redis::Fast の reconnect について</a>の中で
<a href="https://metacpan.org/release/DBIx-Class">DBIx::Class</a>のreconnectについても触れています。
DBIx::Classの安全にreconnectionが行えるように考慮されていますが、色々と注意点があります。
reconnection周りで調べてみたので、Advent Calendarの枠を借りてまとめたいと思います。</p>

<h2>DBIx::Classとは</h2>

<p><a href="https://metacpan.org/release/DBIx-Class">DBIx::Class</a>はPerlのO/Rマッピングモジュールです。
テーブル間のリレーションを定義でき、JOIN句の入ったクエリもサポートする等、かなり高機能なモジュールです。
もう僕はJOIN句をDBIx::Class以外で書ける気がしません。
詳しくはtypester先生の解説記事をどうぞ。</p>

<ul>
<li><a href="http://gihyo.jp/dev/serial/01/perl-hackers-hub">Perl Hackers Hub</a>

<ul>
<li><a href="http://gihyo.jp/dev/serial/01/perl-hackers-hub/000301">第3回　DBIx::Classでデータベース操作（1）</a></li>
<li><a href="http://gihyo.jp/dev/serial/01/perl-hackers-hub/000302">第3回　DBIx::Classでデータベース操作（2）</a></li>
<li><a href="http://gihyo.jp/dev/serial/01/perl-hackers-hub/000303">第3回　DBIx::Classでデータベース操作（3）</a></li>
</ul>
</li>
</ul>


<h2>サンプル</h2>

<p>サンプルとしてユーザの所持金を管理する簡単なアプリを作ってみます。
Webアプリとか作るの面倒だったので、コンソールアプリです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="nb">package</span> <span class="nn">My::Schema::</span><span class="n">User</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">use</span> <span class="n">base</span> <span class="s">&#39;DBIx::Class::Core&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">add_columns</span><span class="p">(</span>
</span><span class='line'>        <span class="n">id</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data_type</span>         <span class="o">=&gt;</span> <span class="s">&#39;INTEGER&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">is_nullable</span>       <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="n">is_auto_increment</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">username</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data_type</span>   <span class="o">=&gt;</span> <span class="s">&#39;VARCHAR&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">size</span>        <span class="o">=&gt;</span> <span class="mi">255</span><span class="p">,</span>
</span><span class='line'>            <span class="n">is_nullable</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">set_primary_key</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># userとmoneyは1対1の関係で、userに対応するmoneyが必ず存在しなければならない</span>
</span><span class='line'>    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">has_one</span><span class="p">(</span>
</span><span class='line'>        <span class="s">&#39;money&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;My::Schema::Money&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="p">{</span> <span class="s">&#39;foreign.user_id&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;self.id&#39;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nb">package</span> <span class="nn">My::Schema::</span><span class="n">Money</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">use</span> <span class="n">base</span> <span class="s">&#39;DBIx::Class::Core&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;money&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">add_columns</span><span class="p">(</span>
</span><span class='line'>        <span class="n">user_id</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data_type</span>   <span class="o">=&gt;</span> <span class="s">&#39;INTEGER&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">is_nullable</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">yen</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data_type</span>   <span class="o">=&gt;</span> <span class="s">&#39;INTEGER&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">is_nullable</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">set_primary_key</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">belongs_to</span><span class="p">(</span>
</span><span class='line'>        <span class="s">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;My::Schema::User&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="p">{</span> <span class="s">&#39;foreign.id&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;self.user_id&#39;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nb">package</span> <span class="nn">My::</span><span class="n">Schema</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">use</span> <span class="n">base</span> <span class="s">&#39;DBIx::Class::Schema&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">__PACKAGE__</span><span class="o">-&gt;</span><span class="n">load_classes</span><span class="p">(</span><span class="sx">qw/User Money/</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="n">feature</span> <span class="s">&#39;say&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">my</span> <span class="nv">$schema</span> <span class="o">=</span> <span class="nn">My::</span><span class="n">Schema</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="s">&#39;dbi:mysql:host=127.0.0.1;port=3306;database=test;mysql_write_timeout=1;mysql_read_timeout=1&#39;</span><span class="p">,</span> <span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">dbh</span><span class="o">-&gt;</span><span class="k">do</span><span class="p">(</span><span class="s">&#39;DROP TABLE IF EXISTS money, user&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">deploy</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>実行するとMySQLのデータベースに以下のようなテーブルが作成されます。
userテーブルはユーザの名前を管理するテーブル、moneyはユーザの所持金を管理するテーブルです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">desc</span> <span class="n">user</span><span class="p">;</span>
</span><span class='line'><span class="o">+----------+--------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Field</span>    <span class="o">|</span> <span class="n">Type</span>         <span class="o">|</span> <span class="n">Null</span> <span class="o">|</span> <span class="n">Key</span> <span class="o">|</span> <span class="n">Default</span> <span class="o">|</span> <span class="n">Extra</span>          <span class="o">|</span>
</span><span class='line'><span class="o">+----------+--------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">id</span>       <span class="o">|</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>      <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span> <span class="n">PRI</span> <span class="o">|</span> <span class="n">NULL</span>    <span class="o">|</span> <span class="n">auto_increment</span> <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">username</span> <span class="o">|</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="n">NULL</span>    <span class="o">|</span>                <span class="o">|</span>
</span><span class='line'><span class="o">+----------+--------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="mi">2</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">desc</span> <span class="n">money</span><span class="p">;</span>
</span><span class='line'><span class="o">+---------+---------+------+-----+---------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Field</span>   <span class="o">|</span> <span class="n">Type</span>    <span class="o">|</span> <span class="n">Null</span> <span class="o">|</span> <span class="n">Key</span> <span class="o">|</span> <span class="n">Default</span> <span class="o">|</span> <span class="n">Extra</span> <span class="o">|</span>
</span><span class='line'><span class="o">+---------+---------+------+-----+---------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">user_id</span> <span class="o">|</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span> <span class="n">PRI</span> <span class="o">|</span> <span class="n">NULL</span>    <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">yen</span>     <span class="o">|</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="n">NULL</span>    <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'><span class="o">+---------+---------+------+-----+---------+-------+</span>
</span><span class='line'><span class="mi">2</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>タイムアウトとロールバックの微妙な関係</h2>

<h3>ユーザの初期化プログラムを実装してみる</h3>

<p>テーブル作っただけではつまらないので、データを入れてみます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># スキーマ定義等略</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># ユーザ作成</span>
</span><span class='line'><span class="k">my</span> <span class="nv">$user_rs</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">resultset</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nb">eval</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
</span><span class='line'>        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># ユーザを初期化するためクエリ(ちょっと時間がかかる)</span>
</span><span class='line'>    <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({},</span> <span class="p">{</span><span class="nb">select</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="s">&#39;SLEEP(1)&#39;</span><span class="p">})</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;名前: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;所持金: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span><span class="o">-&gt;</span><span class="n">yen</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;ユーザが見つかりませんでした&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>実行してみると、1000円持ったユーザが作成されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ perl dbic-test.pl
</span><span class='line'>名前: ok_macopy
</span><span class='line'>所持金: 1000</span></code></pre></td></tr></table></div></figure>


<h3>タイムアウトと戦う</h3>

<p>一件上手く動いていそうに見えますが、上記コードを何回か実行すると、ときたま以下のように失敗します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ perl dbic-test.pl
</span><span class='line'>DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: Lost connection to MySQL server during query [for Statement "SELECT SLEEP(1) FROM user me"] at dbic-test.pl line 80
</span><span class='line'>名前: ok_macopy
</span><span class='line'>所持金: 0</span></code></pre></td></tr></table></div></figure>


<p>所持金が0円になってしまいました。
<code>SELECT SLEEP(1) FROM user me</code> という時間のかかるクエリを投げたので、コネクションがタイムアウトしてしまったようです。
データベースの状態を確認すると、userに行はあるけど、moneyは空っぽの状態です。
「userに対応するmoneyが必ず存在しなければならない」とスキーマで定義したのに、その条件を満たしていませんね。
たとえタイムアウトしたとしても、このような状態にはならないで欲しいです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; SELECT * FROM user;
</span><span class='line'>+----+-----------+
</span><span class='line'>| id | username  |
</span><span class='line'>+----+-----------+
</span><span class='line'>|  1 | ok_macopy |
</span><span class='line'>+----+-----------+
</span><span class='line'>1 row in set (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; SELECT * FROM money;
</span><span class='line'>Empty set (0.00 sec)</span></code></pre></td></tr></table></div></figure>


<h3>トランザクションを使ってみる</h3>

<p>リレーショナルデータベースにはこれを実現するためにトランザクションという便利なものがあります。
DBIx::Classから扱うにはいくつか方法がありますが、例えばガードオブジェクトを使って以下のように書けます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># ユーザ作成</span>
</span><span class='line'><span class="k">my</span> <span class="nv">$user_rs</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">resultset</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nb">eval</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
</span><span class='line'>        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># ユーザを初期化するためクエリ(ちょっと時間がかかる)</span>
</span><span class='line'>    <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({},</span> <span class="p">{</span><span class="nb">select</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="s">&#39;SLEEP(1)&#39;</span><span class="p">})</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;名前: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;所持金: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span> <span class="p">?</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span><span class="o">-&gt;</span><span class="n">yen</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;ユーザが見つかりませんでした&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>これで片一方だけ更新されるのが防げるはず！
ところが、片一方だけ更新自体は防げはするのですが、
今度は所持金を表示するところでコケてしまいます。
トランザクションを使っていないときは正常に表示できていたし、
表示部分は一切いじってないのに不思議ですね。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ perl dbic-test.pl
</span><span class='line'>Transaction aborted: DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: Lost connection to MySQL server during query [for Statement "SELECT SLEEP(1) FROM user me"] at dbic-test.pl line 80
</span><span class='line'> Rollback failed: DBIx::Class::Storage::DBI::_exec_txn_rollback(): DBI Exception: DBD::mysql::db rollback failed: Turning on AutoCommit failed at dbic-test.pl line 72
</span><span class='line'>DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: MySQL server has gone away [for Statement "SELECT me.id, me.username FROM user me WHERE ( id = ? )" with ParamValues: 0=1] at dbic-test.pl line 89
</span><span class='line'># ※「ユーザが見つかりませんでした」と表示されて欲しいがされない</span></code></pre></td></tr></table></div></figure>


<p>実はコネクションがタイムアウトしたとはMySQLとの再接続をする必要があるのですが、
DBIx::Classが裏で再接続処理を自動的にやってくれるので、普段は意識する必要はありません。
ただし例外があって、 <strong>トランザクションの中では再接続処理を行ってくれません</strong> 。</p>

<p>トランザクション内で勝手に再接続が行われると逆に困るので、この挙動自体は正しいのですが、
これにロールバックが絡むと少し不思議なことが起こります。
<strong>ロールバックしてトランザクションを抜けても、DBIx::Classはトランザクションの中にいると判断してしまうのです。</strong>
このことは<code>transaction_depth</code>を見ることで確認できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># ユーザ作成</span>
</span><span class='line'><span class="k">my</span> <span class="nv">$user_rs</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">resultset</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">);</span>
</span><span class='line'><span class="n">say</span> <span class="s">&#39;transaction_depth = &#39;</span><span class="p">,</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">storage</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">transaction_depth</span><span class="p">};</span>
</span><span class='line'><span class="nb">eval</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&#39;transaction_depth = &#39;</span><span class="p">,</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">storage</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">transaction_depth</span><span class="p">};</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
</span><span class='line'>        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># ユーザを初期化するためクエリ(ちょっと時間がかかる)</span>
</span><span class='line'>    <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({},</span> <span class="p">{</span><span class="nb">select</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="s">&#39;SLEEP(1)&#39;</span><span class="p">})</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">say</span> <span class="s">&#39;transaction_depth = &#39;</span><span class="p">,</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">storage</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">transaction_depth</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;名前: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;所持金: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span> <span class="p">?</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span><span class="o">-&gt;</span><span class="n">yen</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;ユーザが見つかりませんでした&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ perl dbic-test.pl
</span><span class='line'>transaction_depth = 0
</span><span class='line'>transaction_depth = 1
</span><span class='line'>Transaction aborted: DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: Lost connection to MySQL server during query [for Statement "SELECT SLEEP(1) FROM user me"] at dbic-test.pl line 82
</span><span class='line'> Rollback failed: DBIx::Class::Storage::DBI::_exec_txn_rollback(): DBI Exception: DBD::mysql::db rollback failed: Turning on AutoCommit failed at dbic-test.pl line 73
</span><span class='line'>transaction_depth = 1 # ※トランザクションの外なのに1になってる
</span><span class='line'>DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: MySQL server has gone away [for Statement "SELECT me.id, me.username FROM user me WHERE ( id = ? )" with ParamValues: 0=1] at dbic-test.pl line 92</span></code></pre></td></tr></table></div></figure>


<p>この状態になるといつまで経っても再接続は行われません。
都度接続なら大きな問題にはならないのですが、Webアプリでコネクションの永続化を行っている場合は深刻です。
一度タイムアウトすると以後のリクエストがすべて失敗してしまいます。</p>

<h3>確実に再接続を行う</h3>

<p>これを防ぐには確実に再接続をおこなって欲しいところで <code>$schema-&gt;storage-&gt;ensure_connected;</code> を実行します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># ユーザ作成</span>
</span><span class='line'><span class="k">my</span> <span class="nv">$user_rs</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">resultset</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nb">eval</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
</span><span class='line'>        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># ユーザを初期化するためクエリ(ちょっと時間がかかる)</span>
</span><span class='line'>    <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({},</span> <span class="p">{</span><span class="nb">select</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="s">&#39;SLEEP(1)&#39;</span><span class="p">})</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">ensure_connected</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;名前: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;所持金: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span> <span class="p">?</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span><span class="o">-&gt;</span><span class="n">yen</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;ユーザが見つかりませんでした&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>こうすることで、何度実行しても「所持金1000のユーザが作られる」or「ユーザが見つかりませんでした」の状態になり、
中途半端な状態のユーザが作られたり、再接続に失敗したりということはなくなります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ perl dbic-test.pl
</span><span class='line'>Transaction aborted: DBIx::Class::Storage::DBI::_dbh_execute(): DBI Exception: DBD::mysql::st execute failed: Lost connection to MySQL server during query [for Statement "SELECT SLEEP(1) FROM user me"] at dbic-test.pl line 80
</span><span class='line'> Rollback failed: DBIx::Class::Storage::DBI::_exec_txn_rollback(): DBI Exception: DBD::mysql::db rollback failed: Turning on AutoCommit failed at dbic-test.pl line 72
</span><span class='line'>        (in cleanup) {UNKNOWN}: DBI Exception: DBD::mysql::db DESTROY failed: MySQL server has gone away  at /home/ichinose/.plenv/versions/5.20.2/lib/perl5/site_perl/5.20.2/DBIx/Class/Schema.pm line 1077.
</span><span class='line'>        DBIx::Class::Schema::throw_exception(My::Schema=HASH(0x118d088), "DBI Exception: DBD::mysql::db DESTROY failed: MySQL server ha"...) called at /home/ichinose/.plenv/versions/5.20.2/lib/perl5/site_perl/5.20.2/DBIx/Class/Storage.pm line 113
</span><span class='line'>        DBIx::Class::Storage::throw_exception(DBIx::Class::Storage::DBI::mysql=HASH(0x118d718), "DBI Exception: DBD::mysql::db DESTROY failed: MySQL server ha"...) called at /home/ichinose/.plenv/versions/5.20.2/lib/perl5/site_perl/5.20.2/DBIx/Class/Storage/DBI.pm line 1473
</span><span class='line'>        DBIx::Class::Storage::DBI::__ANON__("DBD::mysql::db DESTROY failed: MySQL server has gone away", DBI::db=HASH(0x16efbb8), undef) called at dbic-test.pl line 91
</span><span class='line'>        eval {...} called at dbic-test.pl line 91
</span><span class='line'>
</span><span class='line'>ユーザが見つかりませんでした</span></code></pre></td></tr></table></div></figure>


<h2>ネストしたトランザクションとロールバックの微妙な関係</h2>

<h3>トランザクションをネストする</h3>

<p>キャンペーン期間中なので通常1000円のところ2000円で初期化してあげることになりました。
<strong>2000円への更新処理の途中で何かエラーが起こった場合は1000円で初期化して欲しい</strong> ので、
以下のようにトランザクションをネストしてみました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="nb">eval</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
</span><span class='line'>        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># ユーザを初期化するためクエリ</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$money</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># キャンペーン期間中なので2000円で初期化してげよう</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">my</span> <span class="nv">$txn2</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$money</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">({</span><span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">});</span>
</span><span class='line'>        <span class="nb">undef</span> <span class="nv">$txn2</span><span class="p">;</span> <span class="c1"># エラーが起こったのでロールバックして欲しい！1000円にもどって!!</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">ensure_connected</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;名前: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;所持金: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span><span class="o">-&gt;</span><span class="n">yen</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;ユーザが見つかりませんでした&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>わざとエラーが起こるようにして実行してみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ perl dbic-test.pl
</span><span class='line'>DBIx::Class::Storage::TxnScopeGuard::DESTROY(): A DBIx::Class::Storage::TxnScopeGuard went out of scope without explicit commit or error. Rolling back. at dbic-test.pl line 88
</span><span class='line'>名前: ok_macopy
</span><span class='line'>所持金: 2000</span></code></pre></td></tr></table></div></figure>


<p>2000円！</p>

<p><strong>「Rolling back」って出てるのに全然ロールバックされてない！</strong></p>

<h3>SAVE POINTを使う</h3>

<p>接続時に<code>auto_savepoint</code>オプションを有効にすると、<code>SAVE POINT</code>を使った部分的なロールバックが使用可能になります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">my</span> <span class="nv">$schema</span> <span class="o">=</span> <span class="nn">My::</span><span class="n">Schema</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="s">&#39;dbi:mysql:host=127.0.0.1;port=3306;database=test;mysql_write_timeout=1;mysql_read_timeout=1&#39;</span><span class="p">,</span> <span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">auto_savepoint</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ perl dbic-test.pl
</span><span class='line'>DBIx::Class::Storage::TxnScopeGuard::DESTROY(): A DBIx::Class::Storage::TxnScopeGuard went out of scope without explicit commit or error. Rolling back. at dbic-test.pl line 90
</span><span class='line'>名前: ok_macopy
</span><span class='line'>所持金: 1000</span></code></pre></td></tr></table></div></figure>


<h3>大人しく全部ロールバックする</h3>

<p>MySQLにはSAVE POINTという便利機能があるとはいえ、どこまでロールバックするべきかを管理するのはすごく大変です。
現実的には ALL or NOTHING、失敗したら全部ロールバックで十分なのではと思ってます。
このサンプルではdieしてしまえばいいですね。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="nb">eval</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">({</span>
</span><span class='line'>        <span class="n">id</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="n">username</span> <span class="o">=&gt;</span> <span class="s">&#39;ok_macopy&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># ユーザを初期化するためクエリ</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$money</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">create_related</span><span class="p">(</span><span class="n">money</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># キャンペーン期間中なので2000円で初期化してげよう</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">my</span> <span class="nv">$txn2</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">txn_scope_guard</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$money</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">({</span><span class="n">yen</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">});</span>
</span><span class='line'>        <span class="nb">die</span> <span class="s">&#39;something error!&#39;</span><span class="p">;</span> <span class="c1"># エラーが起こったのでロールバックして欲しい！1000円にもどって!!</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">warn</span> <span class="nv">$err</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$schema</span><span class="o">-&gt;</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">ensure_connected</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$user_rs</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;名前: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;所持金: &quot;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">money</span><span class="o">-&gt;</span><span class="n">yen</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">say</span> <span class="s">&quot;ユーザが見つかりませんでした&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>something error! at dbic-test.pl line 85.
</span><span class='line'>ユーザが見つかりませんでした</span></code></pre></td></tr></table></div></figure>


<p>途中で<code>eval</code>して例外キャッチしているとロールバックしたのにコミットされる現象が起こる
(その場合警告すら出ないっぽいので更に怖い)ので、例外握り潰していたら要注意です。</p>

<p>部分的なロールバックができない場合は、
「子トランザクションがロールバックされていたら親トランザクションのコミットが失敗する」
が安全だと思うんですが、なぜこんな挙動になっているんでしょうね。
誰か経緯についてご存知のかたは教えていただきたいです。</p>

<h2>まとめ</h2>

<ul>
<li>トランザクション外では自動的に再接続してくれるが、トランザクション内では行われない</li>
<li>必ず再接続して欲しいところで <code>$schema-&gt;storage-&gt;ensure_connected;</code></li>
<li>部分的なロールバックはやらないのが吉</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Shogo Ichinose</span></span>

      




<time class='entry-date' datetime='2015-12-17T18:35:00+09:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:35 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/perl/'>perl</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//b.hatena.ne.jp/entry/https://shogo82148.github.io/blog/2015/12/17/dbix-class/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"><img src="//b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="//b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://shogo82148.github.io/blog/2015/12/17/dbix-class/" data-via="shogo82148" data-counturl="https://shogo82148.github.io/blog/2015/12/17/dbix-class/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/12/16/customize-git-merge/" title="Previous Post: git-mergeの挙動をカスタマイズする">&laquo; git-mergeの挙動をカスタマイズする</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/12/20/mecab-in-python3-final/" title="Next Post: MeCabをPython3から使う(続報)">MeCabをPython3から使う(続報) &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/03/28/database-gis/">Redis、PostgreSQL、MySQLで近傍検索</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/17/how-many-chan-can-i-write-in-golang/">Go言語のchanはいったいいくつ付けられるのか試してみた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/11/go-webntp/">HTTP/WebSocketで時刻同期するWebNTPを書いた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/05/tune-up-go-jsonstore/">go-JSONStoreの高速化と機能追加</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/02/26/unique-id-supplier-using-redis/">Redisを使ってユニークなIDを配布する</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/shogo82148">@shogo82148</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'shogo82148',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Shogo Ichinose -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'shogosblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://shogo82148.github.io/blog/2015/12/17/dbix-class/';
        var disqus_url = 'https://shogo82148.github.io/blog/2015/12/17/dbix-class/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
