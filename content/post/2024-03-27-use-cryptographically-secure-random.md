---
layout: post
title: "éµç”Ÿæˆã«ã¯æš—å·è«–çš„ã«å®‰å…¨ãªä¹±æ•°ã‚’ä½¿ãŠã†"
slug: 2024-03-27-use-cryptographically-secure-random
date: 2024-03-27 21:24:00 +0900
comments: true
categories: []
---

SSHã®éµç”Ÿæˆã«ã¯æš—å·è«–çš„ã«å®‰å…¨ãªç–‘ä¼¼ä¹±æ•°ã‚’ä½¿ãŠã†ã¨ã„ã†è©±ã€‚
æš—å·è«–çš„ã«å®‰å…¨ã§ã¯ãªã„ç–‘ä¼¼ä¹±æ•°ãŒã©ã‚Œã ã‘å±é™ºã‹ã¨ã„ã†ã®ã‚’ã€ç°¡å˜ãªCTFã‚’è§£ãã“ã¨ã§æ¤œè¨¼ã—ã¦ã¿ã¾ã—ãŸã€‚

## èƒŒæ™¯

SSHå…¬é–‹éµã«è‡ªåˆ†ã®å¥½ããªæ–‡å­—åˆ—ã‚’å…¥ã‚Œã‚‹ã€ã¨ã„ã†è¨˜äº‹ã‚’èª­ã¿ã¾ã—ãŸã€‚

- [ã‹ã£ã“ã„ã„SSHéµãŒæ¬²ã—ã„](https://blog.akiym.com/entry/2024/03/24/210524)

> ä¾‹ãˆã°ã“ã®SSHå…¬é–‹éµã€æœ«å°¾ã«ç§ã®åå‰(akiym)ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚
>
> ```
> ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFC90x6FIu8iKzJzvGOYOn2WIrCPTbUYOE+eGi/akiym
> ```
>
> ãã‚“ãªã‹ã£ã“ã„ã„sshéµãŒæ¬²ã—ã„ã¨æ€ã„ã¾ã›ã‚“ã‹ï¼Ÿ

ã‹ã£ã“ã„ã„ï¼çœŸä¼¼ã—ã¦ã¿ãŸã„ï¼

ãã“ã¾ã§ã¯ã„ã„ã‚“ã§ã™ãŒã€å•é¡Œã¯å®Ÿè£…ã§ã™ã€‚

> ç§˜å¯†éµã‚’ç”Ÿæˆã™ã‚‹éš›ã®ä¹±æ•°ç”Ÿæˆã«ã¯é«˜é€ŸåŒ–ã®ãŸã‚ã« **Goã®math/rand**ã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã€ä¹±æ•°ãŒç”¨ã„ã‚‰ã‚Œã‚‹ã®ã¯å…¬é–‹ã—ãªã„ç§˜å¯†éµè‡ªä½“ã§ã‚ã‚Šã€ã“ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è‡ªä½“ã¯Lagged Fibonacci generatorã®ã‚ˆã†ãªã®ã§å¤‰ã«ä¹±æ•°ã«åã‚ŠãŒãªã„é™ã‚Šã¯å¤§ä¸ˆå¤«ã ã‚ã†ã¨æ€ã„ã¾ã™(è¿½è¨˜: ã“ã‚Œã¯ä¹±æ•°äºˆæ¸¬ã‚’ä¸»ã¨ã—ãŸè©±)ã€‚
> (**å¼·èª¿** ã¯ç­†è€…ã«ã‚ˆã‚‹ã‚‚ã®)

ãŠã£ã¨ãã‚Œã¯ã¾ãšã„ã€‚
Goã® [math/rand](https://pkg.go.dev/math/rand) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯æš—å·è«–çš„ã«å®‰å…¨ãªç–‘ä¼¼ä¹±æ•° **ã§ã¯ã‚ã‚Šã¾ã›ã‚“** ã€‚
SSHç§˜å¯†éµã®ã‚ˆã†ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ãŒé‡è¦ãªå ´é¢ã§ã¯ä½¿ç”¨ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚

## Capture the Flag Challenge

ãƒ–ãƒ­ã‚°è¨˜äº‹ã®ç­†è€…ã‚‚ math/rand ã‚’ä½¿ã£ãŸã‚‰ã¾ãšã„ã“ã¨ã¯èªè­˜ã—ãŸã‚ˆã†ã§ã€
ã‹ã£ã“ã„ã„SSHéµç”Ÿæˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®READMEã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¿½è¨˜ãŒã‚ã‚Šã¾ã—ãŸã€‚

- [A Small CTF Challenge](https://github.com/akiym/ed25519brute?tab=readme-ov-file#a-small-ctf-challenge)

> This is a joke software, but there was a serious bug in commit `7db96da05684a86bdbea18319ecc39097d0320d4`.
>
> Can you recover the private key generated by the following command? Of course, it can be recovered in about an hour.
>
> ```plain
> % git rev-parse HEAD
> 7db96da05684a86bdbea18319ecc39097d0320d4
> % go run ./main.go -authorized-key-suffix a
> 2024/03/25 23:51:08 start
> 2024/03/25 23:51:08 found
> % cat out.pub
> ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBVji5kBXa8PbDP1nk+nysVA89VMg27z98D4aVT/j4Fa
> ```

CTF(Capture the Flag)ã¨ã¯ä¸€èˆ¬çš„ã«ã¯æ——å–ã‚Šã‚²ãƒ¼ãƒ ã®ã“ã¨ã‚’ã„ã„ã¾ã™ã€‚
ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ã®æ–‡è„ˆã§ã¯ã€æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ã®çŸ¥è­˜ã‚’ç”¨ã„ã¦ã€èª²é¡Œã®ä¸­ã«éš ã•ã‚ŒãŸç§˜å¯†ã®æ–‡å­—åˆ—ã‚’è¦‹ã¤ã‘ã‚‹ç«¶æŠ€ã‚’æ„å‘³ã—ã¾ã™ã€‚

ã‚ˆã†ã™ã‚‹ã«ã€ä»¥ä¸‹ã®å…¬é–‹éµã«å¯¾å¿œã™ã‚‹ç§˜å¯†éµã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‚‚ã®ãªã‚‰è¦‹ã¤ã‘ã¦ã¿ã‚ã€ã¨ã„ã†ã‚ã‘ã§ã™ã€‚

```plain
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBVji5kBXa8PbDP1nk+nysVA89VMg27z98D4aVT/j4Fa
```

é¢ç™½ãã†ãªã®ã§è§£ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### è„†å¼±æ€§ã‚’æ¢ã™

ã•ã™ãŒã«å…¬é–‹éµã ã‘ã‹ã‚‰ç§˜å¯†éµã‚’è¦‹ã¤ã‘ã‚‹ã®ã¯å›°é›£ã§ã™ã€‚
ã—ã‹ã—ã€ç§˜å¯†éµç”Ÿæˆã«ä½¿ã‚ã‚ŒãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæ‰‹å…ƒã«ã‚ã‚Šã¾ã™ã€‚
ãƒã‚°ãŒåŸ‹ã‚è¾¼ã¾ã‚ŒãŸã¨ã„ã†ã‚³ãƒŸãƒƒãƒˆã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

- [akiym/ed25519brute@7db96da](https://github.com/akiym/ed25519brute/commit/7db96da05684a86bdbea18319ecc39097d0320d4)

è„†å¼±æ€§ãŒã‚ã‚‹ã®ã¯ã“ã“ã§ã™ã€‚

```go
// https://github.com/akiym/ed25519brute/blob/7db96da05684a86bdbea18319ecc39097d0320d4/main.go#L52
fastRandReader := &fastRandReaderImpl{rand.New(rand.NewSource(rand.Int63()))}
```

`math/rand.NewSource` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
ã“ã®å®Ÿè£…ã‚’è¿½ã£ã¦ã€Goã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ã¾ã—ã‚‡ã†ã€‚

ã™ã‚‹ã¨ `math/rand.rngSource` æ§‹é€ ä½“ã® `Seed` ãƒ¡ã‚½ãƒƒãƒ‰ã«ãŸã©ã‚Šç€ãã¾ã™ã€‚

```go
// https://github.com/golang/go/blob/50dcffb384cf1693fb113de01c8a36debc6086d1/src/math/rand/rng.go#L203-L214
func (rng *rngSource) Seed(seed int64) {
	rng.tap = 0
	rng.feed = rngLen - rngTap

	seed = seed % int32max
	if seed < 0 {
		seed += int32max
	}
	if seed == 0 {
		seed = 89482311
	}
```

`seed = seed % int32max` !!!

`int32max` ã¯ 2Â³Â¹-1 ã§ã™ã€‚ä»Šã©ãã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãªã‚‰å…¨æ•°æ¢ç´¢ã‚‚ãã†é›£ã—ã„ã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã‚¢ã‚¿ãƒƒã‚¯ã‚’ä»•æ›ã‘ã‚‹

å¤§ã¾ã‹ã«ä»¥ä¸‹ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™ã€‚

```go
func bruteAuthorizedKey(idx, total int) ed25519.PrivateKey {
    for i := 0; i < 1<<32; i++ {
        fastRandReader := &fastRandReaderImpl{rand.New(rand.NewSource(int64(i)))}

        for {
            // SSHéµã‚’ç”Ÿæˆã™ã‚‹ã€‚
            priv := generateKey(fastRandReader)

            // å…¬é–‹éµã®æœ«å°¾ãŒ a ã§çµ‚ã‚ã£ã¦ã„ã‚‹ã‹èª¿ã¹ã‚‹ã€‚
            if hasSuffix(priv) {

                // ãƒ•ãƒ©ã‚°ï¼ˆå•é¡Œã®ç­”ãˆï¼‰ã‚’è¦‹ã¤ã‘ãŸã‚‰çµ‚äº†ã€‚
                if isFlag(priv) {
                    return priv
                }

                // ã‹ã£ã“ã„ã„SSHéµç”Ÿæˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€
                // æœ€åˆã«è¦‹ã¤ã‘ãŸã‹ã£ã“ã„ã„SSHéµã‚’è¿”ã™ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã‚‹ã®ã§ã€
                // ã“ã“ã§æ¤œç´¢ã‚’æ‰“ã¡åˆ‡ã‚‹ã€‚
                break
            }
        }
    }
    return nil
}
```

å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã¯GitHubã«ã‚³ãƒŸãƒƒãƒˆã—ã¦ãŠãã¾ã—ãŸã€‚

- [shogo82148/ed25519brute-ctf](https://github.com/shogo82148/ed25519brute-ctf)

### çµæœ

æ‰‹å…ƒã® MacBook Pro (14-inch, 2021) Apple M1 Pro ã§å®Ÿè¡Œã—ã¦ã¿ã¾ã—ãŸã€‚

```plain
(snip)
2024/03/27 21:45:50 21b80800 Fq/+3V2o1CSI7qUuAzSzhc1otbnBjIqXiu+ybt2Zs82a
2024/03/27 21:45:50 21b1c807 IhlcF4+LUicBBOxQR7SjzUfq3PiddX/ulJde5iWoVnza
2024/03/27 21:45:51 21c07809 WTy/1TdGMGNQ3WAoMVD+BlOYW0HvvyvBAPKRNyhmOwba
2024/03/27 21:45:51 21afc004 ywYeAfpZxkGz+7py0ybhpsHNnk1UyDsRtCUtHQreg/xa
2024/03/27 21:45:51 21bee806 2kgEG+xcZyclfnmpdP9UuK5qKTNsaoHmDOQ3jKiIJVha
2024/03/27 21:45:51 21bad802 cUKSbvAl1on3L0GktTysP1or73hDdad5+5xqFnPCBCKa
2024/03/27 21:45:51 21b92001 1vz9ZFEIsUvg8G8GTcdK8X3sEkHDhyZK05yTHYM9pTHa
2024/03/27 21:45:51 21b74003 3dNasnfkkFUaHjk4ezn5bG+5H0UraPIAwf4/j4ax0gpa
2024/03/27 21:45:51 21bb0005 spI7VNXs8mPBVNKq8S6mS85Lpj583Bdp3HZJ3tKcGQ6a
2024/03/27 21:45:51 found
go run main.go  748204.48s user 2866.83s system 966% cpu 21:35:21.69 total
```

21æ™‚é–“ã‹ã‹ã£ãŸã‚ˆãƒ»ãƒ»ãƒ»
An hour ã¨ã¯è¡Œãã¾ã›ã‚“ã§ã—ãŸãŒã€ã¾ã‚ç¾å®Ÿçš„ãªæ™‚é–“ã§è§£ãã“ã¨ãŒã§ãã¾ã—ãŸã€‚

å¾—ã‚‰ã‚ŒãŸç§˜å¯†éµã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```plain
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtz
c2gtZWQyNTUxOQAAACAVY4uZAV2vD2wz9Z5Pp8rFQPPVTINu8/fA+GlU/4+BWgAA
AIhLwY9OS8GPTgAAAAtzc2gtZWQyNTUxOQAAACAVY4uZAV2vD2wz9Z5Pp8rFQPPV
TINu8/fA+GlU/4+BWgAAAEB7Gf+HiN78cWBrNra2Y712ZZz0Gcev7WqY2NMN0feG
5xVji5kBXa8PbDP1nk+nysVA89VMg27z98D4aVT/j4FaAAAAAAECAwQF
-----END OPENSSH PRIVATE KEY-----
```

`ssh-keygen` ã‚’ä½¿ãˆã°ã“ã‚ŒãŒç­”ãˆã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```
$ ssh-keygen -y -f out
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBVji5kBXa8PbDP1nk+nysVA89VMg27z98D4aVT/j4Fa
```

## ä½™è«‡

åŒã˜æ‰‹æ³•ã§å†’é ­ã®SSHéµã‚‚ç§˜å¯†éµã‚’è¨ˆç®—ã§ãã‚‹ã¯ãšã§ã™ã€‚
ãŸã ã—ã€å˜ç´”è¨ˆç®—ã§ä»Šå›è§£ã„ãŸCTFã®1700ä¸‡å€ã®è¨ˆç®—é‡ãŒå¿…è¦ã§ã™ã€‚
ç„¡é™ã«ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒªã‚½ãƒ¼ã‚¹ãŒä½¿ãˆã‚‹ãªã‚‰è¨ˆç®—ã§ããã†ã§ã™ãŒãƒ»ãƒ»ãƒ»äºˆç®—ã®éƒ½åˆã‹ã‚‰è«¦ã‚ã¾ã—ãŸã€‚

---

`math/rand` ã®ä»£ã‚ã‚Šã« `crypto/rand` ã‚’ä½¿ã†ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒ¼ã‚¸ã—ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚

- [use crypto/rand instead of math/rand #1](https://github.com/akiym/ed25519brute/pull/1)

åˆç‰ˆã‚ˆã‚Šã¯å¼·åŠ›ãªSSHéµã‚’ç”Ÿæˆã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

## ã¾ã¨ã‚

ç§˜å¯†éµã®ç”Ÿæˆã«ã¯ã€ãŠã¨ãªã—ã `ssh-keygen` ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

æš—å·è«–çš„ã«å®‰å…¨ã§ã¯ãªã„ç–‘ä¼¼ä¹±æ•°ã‚’ä½¿ã£ã¦ä½œæˆã•ã‚ŒãŸSSHéµã¯éå¸¸ã«å±é™ºã§ã™ã€‚
ãã®ã‚ˆã†ãªSSHéµã§ã¯ã€å…¬é–‹éµã‹ã‚‰ç§˜å¯†éµã‚’è¨ˆç®—ã§ãã‚‹ã“ã¨ã‚’å®Ÿéš›ã«ç¢ºã‹ã‚ã¦ã¿ã¾ã—ãŸã€‚

> ğŸ°âœ¨ 
> ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã«ã¯ã€ 
> å¼·å›ºãªéµãŒå¿…è¦ã€ 
> crypto/randã®å…‰ã«å°ã‹ã‚Œã€ 
> å®‰å…¨ãªé“ã‚’æ­©ã‚‚ã†ã€‚ 
> ğŸŒŸğŸ”‘ 
> by CodeRabbit

## å‚è€ƒæ–‡çŒ®

- [ã‹ã£ã“ã„ã„SSHéµãŒæ¬²ã—ã„](https://blog.akiym.com/entry/2024/03/24/210524)
- [akiym/ed25519brute](https://github.com/akiym/ed25519brute)
- [akiym/ed25519brute@7db96da](https://github.com/akiym/ed25519brute/commit/7db96da05684a86bdbea18319ecc39097d0320d4)
- [shogo82148/ed25519brute-ctf](https://github.com/shogo82148/ed25519brute-ctf)
- [use crypto/rand instead of math/rand #1](https://github.com/akiym/ed25519brute/pull/1)
