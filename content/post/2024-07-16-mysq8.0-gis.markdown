---
layout: post
title: "MySQL8.0ã§è¿‘å‚æ¤œç´¢"
slug: 2024-07-16-mysq8.0-gis
date: 2024-07-16 07:33:00 +0900
comments: true
categories: [mysql]
---

ã€Œ[Redisã€PostgreSQLã€MySQLã§è¿‘å‚æ¤œç´¢](https://shogo82148.github.io/blog/2017/03/28/database-gis/)ã€ã‚’å…¬é–‹ã—ãŸå½“æ™‚ã¯ã€
MySQL 5.7 ã§æ¤œè¨¼ã‚’è¡Œã„ã¾ã—ãŸã€‚
ã€ŒMySQL 8.0 ã§ã¯GISé–¢é€£ã‚‚å¼·åŒ–ã•ã‚Œã¦ã„ã‚‹ãï¼ã€ã¨ã„ã†è©±ã‚’èã„ã¦ã„ãŸã®ã§ã€MySQL 8.0ã§ã‚‚æ¤œè¨¼ã—ã¦ã¿ã¾ã™ã€‚
ï¼ˆMySQL 8.0ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ä½•å¹´çµŒã£ã¦ã‚‹ã‚“ã ã‚ˆã¨ã„ã†ãƒ„ãƒƒã‚³ãƒŸã¯ç½®ã„ã¦ãŠãï¼‰

## æ¤œè¨¼ç’°å¢ƒ

æ¤œè¨¼ç’°å¢ƒã¯Dockerä¸Šã§èµ·å‹•ã—ã¾ã—ãŸã€‚
ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯2024-07-16æ™‚ç‚¹ã§8.0ç³»åˆ—æœ€æ–°ã®8.0.38ã§ã™ã€‚

```plain
mysql> SELECT VERSION();
+-----------+
| VERSION() |
+-----------+
| 8.0.38    |
+-----------+
1 row in set (0.01 sec)
```

æœ€æ–°LTSã®8.4.1ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¾ã™ãŒã€Amazon RDSã§ã¯æœªã‚µãƒãƒ¼ãƒˆã§ã™ã€‚
ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ãŸã„ã®ã§ã€ã²ã¨ã¾ãš8.0ã§æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚

## ãƒ†ãƒ¼ãƒ–ãƒ«ã®æº–å‚™

ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã§SRIDã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ä½•ãŒå¬‰ã—ã„ã‹ã¨ã„ã†ã¨ MySQL ãŒã€Œåœ°çƒã¯ä¸¸ã„ã€ã¨ã„ã†ã“ã¨ã‚’ç†è§£ã—ã¦ãã‚Œã¾ã™ï¼

``` sql
CREATE DATABASE test;
USE test;
CREATE TABLE IF NOT EXISTS `geotable` (
  `id`   int(10) UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` VARCHAR (255) NOT NULL,
  `geom` POINT NOT NULL SRID 4326,
  PRIMARY KEY (`id`),
  SPATIAL KEY `geom` (`geom`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

SRIDã¯çœç•¥å¯èƒ½ã§ã™ãŒã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯å¿…é ˆã§ã™ã€‚
å¿˜ã‚Œãšã«æŒ‡å®šã—ã¾ã—ã‚‡ã†ã€‚


## ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™

ã€Œ[Redisã€PostgreSQLã€MySQLã§è¿‘å‚æ¤œç´¢](https://shogo82148.github.io/blog/2017/03/28/database-gis/)ã€ã—ãŸã¨ãã¨åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚

``` sql
INSERT INTO geotable (name, geom) VALUES
('ä¸Šé‡é§…', ST_GeomFromText('POINT(35.713768 139.777254)',4326)),
('è¥¿éƒ·éš†ç››åƒ', ST_GeomFromText('POINT(35.711846 139.774029)',4326)),
('ä¸Šé‡ã®æ£®ç¾è¡“é¤¨', ST_GeomFromText('POINT(35.712737 139.774744)',4326)),
('ä¸å¿æ± å¼è²¡å¤©', ST_GeomFromText('POINT(35.712351 139.770872)',4326)),
('é‡å£è‹±ä¸–åšå£«åƒ', ST_GeomFromText('POINT(35.716293 139.775696)',4326)),
('å›½ç«‹è¥¿æ´‹ç¾è¡“é¤¨', ST_GeomFromText('POINT(35.71542 139.775803)',4326)),
('å›½ç«‹ç§‘å­¦åšç‰©é¤¨', ST_GeomFromText('POINT(35.716319 139.776544)',4326)),
('æ±äº¬éƒ½ç¾è¡“é¤¨', ST_GeomFromText('POINT(35.717186 139.772776)',4326)),
('æ±äº¬å›½ç«‹åšç‰©é¤¨', ST_GeomFromText('POINT(35.718883 139.776462)',4326)),
('èŠ±ã‚„ã—ã', ST_GeomFromText('POINT(35.71528 139.794547)',4326)),
('é›·é–€', ST_GeomFromText('POINT(35.710635 139.792692)',4326));
```

æ³¨æ„ç‚¹ã¯2ã¤ã€‚

1ã¤ç›®ã¯æŒ¿å…¥æ™‚ã«ã‚‚SRIDã®æŒ‡å®šãŒå¿…è¦ãªã“ã¨ã€‚çœç•¥ã™ã‚‹ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®0ã¨ã¿ãªã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã¨æŒ¿å…¥ãƒ‡ãƒ¼ã‚¿ã®SRIDãŒåŒã˜ã§ãªã„ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã§æ³¨æ„ã§ã™ã€‚

```sql
INSERT INTO geotable (name, geom) VALUES ('ä¸Šé‡é§…', ST_GeomFromText('POINT(139.777254 35.713768)'));
```

```plain
ERROR 3643 (HY000): The SRID of the geometry does not match the SRID of the column 'geom'. The SRID of the geometry is 0, but the SRID of the column is 4326. Consider changing the SRID of the geometry or the SRID property of the column.
```

2ã¤ç›®ã¯ç·¯åº¦ã¨çµŒåº¦ã®é †ç•ªã€‚PostgreSQLã§ã¯ã€ŒçµŒåº¦ã€ç·¯åº¦ã€ã®é †ç•ªã§ã™ãŒã€MySQLã¯ã€Œç·¯åº¦ã€çµŒåº¦ã€ã®é †ç•ªã«ãªã‚Šã¾ã™ã€‚
é€†ã«ã™ã‚‹ã¨ç·¯åº¦ã®ç¯„å›²ãŒãŠã‹ã—ã„ã¨æ€’ã‚‰ã‚Œã¾ã™ï¼ˆæ—¥æœ¬ã®åº§æ¨™ã®å ´åˆï¼‰ã€‚

```sql
INSERT INTO geotable (name, geom) VALUES ('ä¸Šé‡é§…', ST_GeomFromText('POINT(139.777254 35.713768)',4326));
```

```plain
ERROR 3617 (22S03): Latitude 139.777254 is out of range in function st_geomfromtext. It must be within [-90.000000, 90.000000].
```


## Geohashã®è¨ˆç®—

Geohashã®è¨ˆç®—ã«ã¯å¼•ãç¶šã `ST_GeoHash` é–¢æ•°ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

``` sql
SELECT name, ST_AsText(geom), ST_GeoHash(geom, 11) FROM geotable;
```

``` plain
mysql> SELECT name, ST_AsText(geom), ST_GeoHash(geom, 11) FROM geotable;
+-----------------------+-----------------------------+----------------------+
| name                  | ST_AsText(geom)             | ST_GeoHash(geom, 11) |
+-----------------------+-----------------------------+----------------------+
| ä¸Šé‡é§…                | POINT(35.713768 139.777254) | xn77htqxy0f          |
| è¥¿éƒ·éš†ç››åƒ            | POINT(35.711846 139.774029) | xn77hthkdfw          |
| ä¸Šé‡ã®æ£®ç¾è¡“é¤¨        | POINT(35.712737 139.774744) | xn77htkcg8e          |
| ä¸å¿æ± å¼è²¡å¤©          | POINT(35.712351 139.770872) | xn77ht4p92s          |
| é‡å£è‹±ä¸–åšå£«åƒ        | POINT(35.716293 139.775696) | xn77htvw3z9          |
| å›½ç«‹è¥¿æ´‹ç¾è¡“é¤¨        | POINT(35.71542 139.775803)  | xn77htv9kkb          |
| å›½ç«‹ç§‘å­¦åšç‰©é¤¨        | POINT(35.716319 139.776544) | xn77htynts3          |
| æ±äº¬éƒ½ç¾è¡“é¤¨          | POINT(35.717186 139.772776) | xn77hw57twp          |
| æ±äº¬å›½ç«‹åšç‰©é¤¨        | POINT(35.718883 139.776462) | xn77hwqjedk          |
| èŠ±ã‚„ã—ã              | POINT(35.71528 139.794547)  | xn77jjg2949          |
| é›·é–€                  | POINT(35.710635 139.792692) | xn77jhcvtbf          |
+-----------------------+-----------------------------+----------------------+
11 rows in set (0.00 sec)
```

## è¿‘å‚æ¤œç´¢

ã€Œ[Redisã€PostgreSQLã€MySQLã§è¿‘å‚æ¤œç´¢](https://shogo82148.github.io/blog/2017/03/28/database-gis/)ã€ã§ã¯
ã€ŒçŸ©å½¢ã®ç¯„å›²æŒ‡å®šã§å¤§é›‘æŠŠã«çµã‚Šè¾¼ã‚“ã ã‚ã¨ã§ `ST_Distance_Sphere` ã‚’ä½¿ã£ã¦è©³ç´°ã«çµã‚Šè¾¼ã‚€ã€ã¨ã„ã†é¢å€’ãªãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ã„ã¾ã—ãŸã€‚

ã—ã‹ã— MySQL 8.0 ã§ã¯ `ST_Buffer` ãŒã€Œåœ°çƒã¯ä¸¸ã„ã€ã“ã¨ã‚’è€ƒæ…®ã—ã¦ãã‚Œã‚‹ã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ãŒä¸è¦ã«ãªã‚Šã¾ã™ï¼

åŒæ§˜ã« `ST_Distance` ã‚‚ã€Œåœ°çƒã¯ä¸¸ã„ã€ã¨ã„ã†äº‹å®Ÿã‚’èªè­˜ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼
`ST_Distance` ã¨ `ST_Distance_Sphere` ã¨ã§ã¯åŸºæº–ã¨ãªã‚‹åœ°ç†æ¸¬åœ°ç³»ãŒé•ã†ã®ã§ã€è‹¥å¹²ç•°ãªã£ãŸæ•°å€¤ã‚’è¿”ã—ã¾ã™ã€‚
è¤‡æ•°ã®åœ°ç†æ¸¬åœ°ç³»ãŒæ··åœ¨ã™ã‚‹ã¨æ··ä¹±ã®å…ƒã«ãªã‚‹ã®ã§ã€ `ST_Distance` ã«çµ±ä¸€ã—ãŸã»ã†ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

```sql
SET @ueno = ST_GeomFromText('POINT(35.713768 139.777254)',4326);
SELECT
    name,
    ST_AsText(geom),
    ST_Distance(@ueno, geom) as dist,
FROM geotable
WHERE ST_Within(geom, ST_Buffer(@ueno, 300))
ORDER BY dist;
```

## ã¾ã¨ã‚

MySQL 8.0 ã§ã®è¿‘å‚æ¤œç´¢ã‚’æ¤œè¨¼ã—ã¦ã¿ã¾ã—ãŸã€‚
MySQL 5.7 ã§å¿…è¦ã ã£ãŸãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ãŒä¸è¦ã«ãªã£ã¦ã€ç°¡å˜ã«ã‚¯ã‚¨ãƒªãƒ¼ãŒæ›¸ã‘ã¾ã™ã€‚

> æ–°ã—ã„ã‚¬ã‚¤ãƒ‰ãŒèˆã„é™ã‚Šã¦\
> MySQLã®GISãŒè¼ã\
> è¿‘æ¥æ¤œç´¢ã®é­”æ³•ã‚’è§£ã\
> åœ°å›³ã®ä¸–ç•ŒãŒåºƒãŒã‚‹ã‚ˆ\
> `ST_Buffer` ã¨ `ST_Distance`\
> ãƒ‡ãƒ¼ã‚¿ã®æ—…ã«å‡ºã‹ã‘ã‚ˆã†
> ğŸ‡âœ¨
>
> by [CodeRabbit](https://coderabbit.ai/)

## å‚è€ƒ

- [11.4.1 ç©ºé–“ãƒ‡ãƒ¼ã‚¿å‹ - MySQL 8.0 ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«](https://dev.mysql.com/doc/refman/8.0/ja/spatial-type-overview.html)([é­šæ‹“](https://megalodon.jp/2024-0716-0714-12/https://dev.mysql.com:443/doc/refman/8.0/ja/spatial-type-overview.html))
- [MySQLã§å‡¦ç†ã™ã‚‹GISã€œåœ°çƒãŒä¸¸ã„ã“ã¨ã‚’è¦šãˆãŸMySQLã€œ](https://speakerdeck.com/yoshiakiyamasaki/mysql-gis-foss4g-tokai-2023)
- [MySQLã§GISãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†](https://qiita.com/onunu/items/59ef2c050b35773ced0d)
- [Redisã€PostgreSQLã€MySQLã§è¿‘å‚æ¤œç´¢](https://shogo82148.github.io/blog/2017/03/28/database-gis/)
