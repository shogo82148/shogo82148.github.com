<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Shogo's Blog]]></title>
  <link href="https://shogo82148.github.io/atom.xml" rel="self"/>
  <link href="https://shogo82148.github.io/"/>
  <updated>2017-03-30T08:07:24+09:00</updated>
  <id>https://shogo82148.github.io/</id>
  <author>
    <name><![CDATA[Shogo Ichinose]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Redis、PostgreSQL、MySQLで近傍検索]]></title>
    <link href="https://shogo82148.github.io/blog/2017/03/28/database-gis/"/>
    <updated>2017-03-28T19:59:49+09:00</updated>
    <id>https://shogo82148.github.io/blog/2017/03/28/database-gis</id>
    <content type="html"><![CDATA[<p>「<a href="http://techblog.kayac.com/serverside-geohash">サーバーで付近の情報を通知するサービスのつくり方</a>」
という、Geohashを使って近傍検索を実現する記事をみつけました。
最近<a href="https://shogo82148.github.io/blog/2017/02/23/perl-webdb-vol97/">Redisに関する記事</a>を書いた関係で、
この記事をみて「GeohashはRedisと一緒に使うともっと便利だよ！」と思わず宣伝したくなったのですが、
MySQL5.7でInnoDBに空間インデックス(Spatial Index)のサポートが入ったので
「MySQLでももっと簡単にできるのでは？」と思い、
RedisやMySQLを含めたいろんなDBで近傍検索を実現する方法を調べてみました。</p>

<p>以前、<a href="https://shogo82148.github.io/blog/2012/08/02/fireworks/">スマートフォンのセンサを活用して花火の打ち上げ場所を推定するアプリ</a>を作った関係で、
地球上での距離計算の実装も気になったので、それについても調査してみました。</p>

<!-- More -->


<h2>関連知識</h2>

<h3>GeoHash</h3>

<p><a href="https://ja.wikipedia.org/wiki/%E3%82%B8%E3%82%AA%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5">Geohash（ジオハッシュ）</a>
は緯度・経度を短い文字列に変換する方法です。
距離が近い2地点のGeohashは似たような文字列になるという特徴があります(一部例外あり)。
この特徴を利用すると、文字列検索だけで近傍検索が実現できます。</p>

<h3>地球上の二点間の距離</h3>

<p>地球は完全な球体ではなく、回転楕円体であることが知られています。
地球の形がわからないと緯度・経度などを決められないので、
<a href="https://ja.wikipedia.org/wiki/%E5%9C%B0%E7%90%83%E6%A5%95%E5%86%86%E4%BD%93">地球楕円体</a>が定義されています。
近似方法によっていくつか種類があるのですが、GPSなどで使われているWGS84がよく使われているようです。</p>

<p>国土地理院が提供している<a href="http://vldb.gsi.go.jp/sokuchi/surveycalc/main.html">測量計算サイト</a>では
<a href="http://vldb.gsi.go.jp/sokuchi/surveycalc/surveycalc/bl2stf.html">距離と方位角の計算</a>を使って緯度・経度から距離を計算できます。
回転楕円体上の距離の厳密解は求められない(要出典)ので、
<a href="http://vldb.gsi.go.jp/sokuchi/surveycalc/surveycalc/algorithm/bl2st/bl2st.htm">数値計算</a>によって求めることになります。
計算式を見て分かる通り非常に複雑なので、なんらかの近似をしている実装がほとんどです。</p>

<h2>各種DBでの実現方法</h2>

<h3>Redis</h3>

<p>Redisでは3.2から<a href="https://redis.io/commands#geo">GEO</a>関連の機能をサポートしています。
ソート済みセットにGeohashを組み合わせて実現しています。</p>

<p>簡単に試してみました。データは以下の記事から拝借したものを使用します。</p>

<ul>
<li><a href="http://d.hatena.ne.jp/ilo/20090212/1234448136">MySQLで指定した緯度経度から半径nメートル内検索っぽいのを実現するSQL</a></li>
<li><a href="https://www.infoscoop.org/blogjp/2015/01/21/tutorial_for_geodb/">PostgreSQLとOracleで緯度経度から半径nメートル内検索を実行してみる。</a></li>
</ul>


<p><a href="https://redis.io/commands/geoadd"><code>GEOADD</code></a>でデータ挿入です。
ちなみにデータを削除する<code>GEODEL</code>は用意されていないとのこと。
中身はソート済みセットなので、<a href="https://redis.io/commands/zrem">ZREM</a>でいいんですね。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat command.txt
</span><span class='line'>GEOADD geotable 139.777254 35.713768 上野駅         139.774029 35.711846 西郷隆盛像
</span><span class='line'>GEOADD geotable 139.774744 35.712737 上野の森美術館 139.770872 35.712351 不忍池弁財天
</span><span class='line'>GEOADD geotable 139.775696 35.716293 野口英世博士像 139.775803 35.715420 国立西洋美術館
</span><span class='line'>GEOADD geotable 139.776544 35.716319 国立科学博物館 139.772776 35.717186 東京都美術館
</span><span class='line'>GEOADD geotable 139.776462 35.718883 東京国立博物館 139.794547 35.715280 花やしき
</span><span class='line'>GEOADD geotable 139.792692 35.710635 雷門
</span><span class='line'>$ redis-cli &lt; command.txt
</span><span class='line'>(integer) 2
</span><span class='line'>(integer) 2
</span><span class='line'>(integer) 2
</span><span class='line'>(integer) 2
</span><span class='line'>(integer) 2
</span><span class='line'>(integer) 1</span></code></pre></td></tr></table></div></figure>


<p><code>GEOHASH</code>で各地点のGeohashを取得できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ redis-cli
</span><span class='line'>127.0.0.1:6379&gt; GEOHASH geotable 上野駅 西郷隆盛像 上野の森美術館
</span><span class='line'>1) "xn77htqxy10"
</span><span class='line'>2) "xn77hthkdf0"
</span><span class='line'>3) "xn77htkcg80"</span></code></pre></td></tr></table></div></figure>


<p><code>GEORADIUS</code>で近傍検索ができます。
上野駅から半径300m以内の地点を求める例です。
データに日本語を使ったので非常にわかりにくいですが、
上野駅から近い順に「上野駅」「国立西洋美術館」「上野の森美術館」「国立科学博物館」の距離と座標を返してくれました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ redis-cli
</span><span class='line'>127.0.0.1:6379&gt; GEORADIUS geotable 139.777254 35.713768 300 m WITHCOORD WITHDIST ASC
</span><span class='line'>1) 1) "\xe4\xb8\x8a\xe9\x87\x8e\xe9\xa7\x85"
</span><span class='line'>   2) "0.1203"
</span><span class='line'>   3) 1) "139.77725297212600708"
</span><span class='line'>      2) "35.71376868735887911"
</span><span class='line'>2) 1) "\xe5\x9b\xbd\xe7\xab\x8b\xe8\xa5\xbf\xe6\xb4\x8b\xe7\xbe\x8e\xe8\xa1\x93\xe9\xa4\xa8"
</span><span class='line'>   2) "225.4920"
</span><span class='line'>   3) 1) "139.77580457925796509"
</span><span class='line'>      2) "35.71541879083360271"
</span><span class='line'>3) 1) "\xe4\xb8\x8a\xe9\x87\x8e\xe3\x81\xae\xe6\xa3\xae\xe7\xbe\x8e\xe8\xa1\x93\xe9\xa4\xa8"
</span><span class='line'>   2) "254.1580"
</span><span class='line'>   3) 1) "139.77474242448806763"
</span><span class='line'>      2) "35.71273705584702896"
</span><span class='line'>4) 1) "\xe5\x9b\xbd\xe7\xab\x8b\xe7\xa7\x91\xe5\xad\xa6\xe5\x8d\x9a\xe7\x89\xa9\xe9\xa4\xa8"
</span><span class='line'>   2) "290.8339"
</span><span class='line'>   3) 1) "139.77654486894607544"
</span><span class='line'>      2) "35.71631861684517872"</span></code></pre></td></tr></table></div></figure>


<p>上野駅と上野駅の距離は当然0mなはずですが、ちょっとだけズレてます。
これはソート済みセットの制約で緯度・経度それぞれ53bitを26bitにまるめているからです(たぶん)。
距離の計算は<a href="https://github.com/antirez/redis/blob/4.0/src/geohash_helper.c#L52">半径6372797.560856mの完全な球体</a>で近似し、
<a href="https://en.wikipedia.org/wiki/Haversine_formula">Haversine formula</a>というのを使っています。</p>

<p>ちなみに扱える緯度・経度には以下の制限があり、極付近の座標は扱えません。</p>

<ul>
<li>経度 -180度から180度</li>
<li>緯度 -85.05112878度から85.05112878度</li>
</ul>


<p>これは Spherical Mercator(球面メルカトル図法) の制限らしいです。
Google Maps, OpenStreetMap, Bing 等でよく見る地図は平面ですが、本来の地球は丸いので、うまく平面にマッピングする必要があります。
このときにどうしても本来の地形から歪んでしまうわけですが、
極付近では歪みが無限大になってしまいうまく平面の地図にできないのです。</p>

<p>ただ、Redis自体は平面へのマッピングをしないので、別にこの制限要らな気もします。
まあ、コーナーケースなので他にも問題がありそうですし、
そもそも北極・南極向けにサービス作らないので気にしないでおきましょう。</p>

<h3>PostgreSQL</h3>

<p>日本語で書かれた先行事例を見つけたので、PostgreSQLの紹介から。
以下の記事にあるように、PostGISというオプション機能をインストールすると簡単に実現できます。</p>

<ul>
<li><a href="https://www.infoscoop.org/blogjp/2015/01/21/tutorial_for_geodb/">PostgreSQLとOracleで緯度経度から半径nメートル内検索を実行してみる。</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- PostGISを有効化</span>
</span><span class='line'><span class="k">CREATE</span> <span class="n">EXTENSION</span> <span class="n">postgis</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- テーブルの作成</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">geotable</span> <span class="p">(</span>
</span><span class='line'>    <span class="n">id</span>   <span class="nb">SERIAL</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
</span><span class='line'>    <span class="n">name</span> <span class="nb">varchar</span> <span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>    <span class="n">geom</span> <span class="n">geography</span><span class="p">(</span><span class="n">POINT</span><span class="p">,</span> <span class="mi">4326</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- データの挿入</span>
</span><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">geotable</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span> <span class="k">VALUES</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;上野駅&#39;</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.777254 35.713768)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;西郷隆盛像&#39;</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.774029 35.711846)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;上野の森美術館&#39;</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.774744 35.712737)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;不忍池弁財天&#39;</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.770872 35.712351)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;野口英世博士像&#39;</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.775696 35.716293)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;国立西洋美術館&#39;</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.775803 35.71542)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;国立科学博物館&#39;</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.776544 35.716319)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;東京都美術館&#39;</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.772776 35.717186)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;東京国立博物館&#39;</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.776462 35.718883)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;花やしき&#39;</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.794547 35.71528)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;雷門&#39;</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.792692 35.710635)&#39;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- 空間インデックスの作成</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">gist_geotable</span> <span class="k">on</span> <span class="n">geotable</span> <span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ST_GeoHash</code>でGeohashを求めることができます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span> <span class="n">ST_GeoHash</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">geotable</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>     name          |          st_astext          |      st_geohash
</span><span class='line'>-----------------------+-----------------------------+----------------------
</span><span class='line'> 上野駅             | POINT(139.777254 35.713768) | xn77htqxy0fu2t0y69sv
</span><span class='line'> 西郷隆盛像       | POINT(139.774029 35.711846) | xn77hthkdfw51p8cmr68
</span><span class='line'> 上野の森美術館 | POINT(139.774744 35.712737) | xn77htkcg8enm86bp3j7
</span><span class='line'> 不忍池弁財天    | POINT(139.770872 35.712351) | xn77ht4p92sp8jdqkjzf
</span><span class='line'> 野口英世博士像 | POINT(139.775696 35.716293) | xn77htvw3z9495yr4dxd
</span><span class='line'> 国立西洋美術館 | POINT(139.775803 35.71542)  | xn77htv9kkbffr4ptjcy
</span><span class='line'> 国立科学博物館 | POINT(139.776544 35.716319) | xn77htynts3mer092t8v
</span><span class='line'> 東京都美術館    | POINT(139.772776 35.717186) | xn77hw57twp9x63n6vus
</span><span class='line'> 東京国立博物館 | POINT(139.776462 35.718883) | xn77hwqjedkhwdmmwp0n
</span><span class='line'> 花やしき          | POINT(139.794547 35.71528)  | xn77jjg2949rgdfxbrjp
</span><span class='line'> 雷門                | POINT(139.792692 35.710635) | xn77jhcvtbf5mdcexf85
</span><span class='line'>(11 rows)</span></code></pre></td></tr></table></div></figure>


<p>近傍検索には<a href="http://cse.naro.affrc.go.jp/yellow/pgisman/2.0.0/ST_DWithin.html"><code>ST_DWithin</code></a>を使います。
<a href="http://cse.naro.affrc.go.jp/yellow/pgisman/2.0.0/ST_Distance.html"><code>ST_Distance</code></a>や
<a href="http://cse.naro.affrc.go.jp/yellow/pgisman/2.0.0/ST_Distance_Sphere.html"><code>ST_Distance_Sphere</code></a>、
<a href="http://cse.naro.affrc.go.jp/yellow/pgisman/2.0.0/ST_Distance_Spheroid.html"><code>ST_Distance_Spheroid</code></a>等
を使って距離を計算して絞り込むことも出来ますが、これらの関数はインデックスを使ってくれません。
<code>ST_DWithin</code>は
<a href="http://cse.naro.affrc.go.jp/yellow/pgisman/2.0.0/using_postgis_dbmanagement.html#id286995989">GiSTインデックス</a>
を利用してくれるので高速に処理してくれます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span>
</span><span class='line'>    <span class="n">name</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span>
</span><span class='line'>    <span class="n">ST_Distance</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.777254 35.713768)&#39;</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span> <span class="k">as</span> <span class="n">dist</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">geotable</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(139.777254 35.713768)&#39;</span><span class="p">),</span> <span class="mi">300</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">dist</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>     name          |          st_astext          |     dist
</span><span class='line'>-----------------------+-----------------------------+---------------
</span><span class='line'> 上野駅             | POINT(139.777254 35.713768) |             0
</span><span class='line'> 国立西洋美術館 | POINT(139.775803 35.71542)  | 225.468916585
</span><span class='line'> 上野の森美術館 | POINT(139.774744 35.712737) | 254.308127877
</span><span class='line'> 国立科学博物館 | POINT(139.776544 35.716319) | 290.242707221</span></code></pre></td></tr></table></div></figure>


<p><code>ST_</code>で始まる関数は<a href="http://www.opengeospatial.org/standards/sfs">OpenGIS</a>やSQL/MMで標準化されているものらしいです。</p>

<h3>MySQL</h3>

<p>MySQLに関しては以下の記事を見つけました。
この記事が書かれた頃はMyISAMでしか空間インデックスをサポートしていませんでしたが、
5.7からInnoDBでもサポートされるようになったので、
InnoDBでも同様のことができるはずです。</p>

<ul>
<li><a href="http://qiita.com/kochizufan/items/a68b30ba74849483f75c">mysql空間テーブルの作り方</a></li>
</ul>


<p>MySQL5.7で入った機能についてはこちらを参照。
空間インデックス以外にも大量に変更があるので、アップグレードする人は確認をおすすめします。</p>

<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=shogo82148-22&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=B01LCJRCYE&linkId=ac9d8d9e348bd97dc858337c94e82696"></iframe>


<p>MySQLもPostgreSQLもOpenGISに準拠する方針みたいなので、
PostgreSQLと同じ感じでSQLが書けると信じたいところですが、
当然ながらそうは行きません。</p>

<p>一番大きな違いは<code>geography</code>型には対応しておらず<code>geometry</code>型しか使えないということです。
<code>geography</code>型は測地系の情報を持っている(つまり地球が回転楕円体だということを知っている)のですが、
<code>geometry</code>型は測地系の情報が無いため、平面しか扱えません。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">test</span><span class="p">;</span> <span class="c1">-- 5.6以前は勝手に作ってくれたけど、5.7からは無いらしい</span>
</span><span class='line'><span class="n">USE</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">geotable</span><span class="o">`</span> <span class="p">(</span>
</span><span class='line'>  <span class="o">`</span><span class="n">id</span><span class="o">`</span>   <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">UNSIGNED</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">VARCHAR</span> <span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">geom</span><span class="o">`</span> <span class="n">geometry</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
</span><span class='line'>  <span class="n">SPATIAL</span> <span class="k">KEY</span> <span class="o">`</span><span class="n">geom</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">geom</span><span class="o">`</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>座標の指定も<code>ST_GeographyFromText</code>ではなく<code>ST_GeomFromText</code>を使います。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">geotable</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span> <span class="k">VALUES</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;上野駅&#39;</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.777254 35.713768)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;西郷隆盛像&#39;</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.774029 35.711846)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;上野の森美術館&#39;</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.774744 35.712737)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;不忍池弁財天&#39;</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.770872 35.712351)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;野口英世博士像&#39;</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.775696 35.716293)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;国立西洋美術館&#39;</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.775803 35.71542)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;国立科学博物館&#39;</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.776544 35.716319)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;東京都美術館&#39;</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.772776 35.717186)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;東京国立博物館&#39;</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.776462 35.718883)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;花やしき&#39;</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.794547 35.71528)&#39;</span><span class="p">)),</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;雷門&#39;</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.792692 35.710635)&#39;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>PostgreSQLと同様にGeohashを求める<a href="https://dev.mysql.com/doc/refman/5.7/en/spatial-geohash-functions.html"><code>ST_GeoHash</code>があります</a>が、
桁数を指定する必要があるという違いがあります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span> <span class="n">ST_GeoHash</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">geotable</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+-----------------------+-----------------------------+----------------------+
</span><span class='line'>| name                  | ST_AsText(geom)             | ST_GeoHash(geom, 11) |
</span><span class='line'>+-----------------------+-----------------------------+----------------------+
</span><span class='line'>| 上野駅                | POINT(139.777254 35.713768) | xn77htqxy0f          |
</span><span class='line'>| 西郷隆盛像            | POINT(139.774029 35.711846) | xn77hthkdfw          |
</span><span class='line'>| 上野の森美術館        | POINT(139.774744 35.712737) | xn77htkcg8e          |
</span><span class='line'>| 不忍池弁財天          | POINT(139.770872 35.712351) | xn77ht4p92s          |
</span><span class='line'>| 野口英世博士像        | POINT(139.775696 35.716293) | xn77htvw3z9          |
</span><span class='line'>| 国立西洋美術館        | POINT(139.775803 35.71542)  | xn77htv9kkb          |
</span><span class='line'>| 国立科学博物館        | POINT(139.776544 35.716319) | xn77htynts3          |
</span><span class='line'>| 東京都美術館          | POINT(139.772776 35.717186) | xn77hw57twp          |
</span><span class='line'>| 東京国立博物館        | POINT(139.776462 35.718883) | xn77hwqjedk          |
</span><span class='line'>| 花やしき              | POINT(139.794547 35.71528)  | xn77jjg2949          |
</span><span class='line'>| 雷門                  | POINT(139.792692 35.710635) | xn77jhcvtbf          |
</span><span class='line'>+-----------------------+-----------------------------+----------------------+
</span><span class='line'>11 rows in set (0.00 sec)</span></code></pre></td></tr></table></div></figure>


<p>MySQLにも距離を求める<code>ST_Distance</code>はあるのですが、これは平面専用です。
地球上での距離を求めるには<a href="https://dev.mysql.com/doc/refman/5.7/en/spatial-convenience-functions.html"><code>ST_Distance_Sphere</code>を使います</a>。
MySQL5.7から追加された関数で、これを使うと半径6370986mの球体で近似したときの距離を計算できます。</p>

<p>そして残念なことにPostgreSQLにはあった<code>ST_DWithin</code>はMySQLにはありません。
<code>ST_Distance_Sphere</code>を使えばクエリは書けるのですが、インデックスを使ってくれないので非効率です。
そのため、矩形の範囲指定で大雑把に絞り込んだあとで<code>ST_Distance_Sphere</code>を使って詳細に絞り込むことになります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SET</span> <span class="o">@</span><span class="n">ueno</span> <span class="o">=</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(139.777254 35.713768)&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">SELECT</span>
</span><span class='line'>    <span class="n">name</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span>
</span><span class='line'>    <span class="n">ST_Distance_Sphere</span><span class="p">(</span><span class="o">@</span><span class="n">ueno</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dist</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">geotable</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">ST_Distance_Sphere</span><span class="p">(</span><span class="o">@</span><span class="n">ueno</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">300</span>
</span><span class='line'><span class="k">AND</span> <span class="n">ST_Within</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">ST_Buffer</span><span class="p">(</span><span class="o">@</span><span class="n">ueno</span><span class="p">,</span> <span class="n">DEGREES</span><span class="p">(</span><span class="mi">300</span><span class="o">/</span><span class="p">(</span><span class="mi">6370986</span><span class="o">*</span><span class="n">COS</span><span class="p">(</span><span class="n">RADIANS</span><span class="p">(</span><span class="n">ST_Y</span><span class="p">(</span><span class="o">@</span><span class="n">ueno</span><span class="p">))))),</span> <span class="n">ST_Buffer_Strategy</span><span class="p">(</span><span class="s1">&#39;point_square&#39;</span><span class="p">)))</span>
</span><span class='line'><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">dist</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+-----------------------+-----------------------------+--------------------+
</span><span class='line'>| name                  | ST_AsText(geom)             | dist               |
</span><span class='line'>+-----------------------+-----------------------------+--------------------+
</span><span class='line'>| 上野駅                | POINT(139.777254 35.713768) |                  0 |
</span><span class='line'>| 国立西洋美術館        | POINT(139.775803 35.71542)  | 225.62014319497658 |
</span><span class='line'>| 上野の森美術館        | POINT(139.774744 35.712737) | 253.96163316266237 |
</span><span class='line'>| 国立科学博物館        | POINT(139.776544 35.716319) | 290.81011310408957 |
</span><span class='line'>+-----------------------+-----------------------------+--------------------+
</span><span class='line'>4 rows in set (0.00 sec)</span></code></pre></td></tr></table></div></figure>


<p>緯度によって経度1度あたりの長さが違うので、矩形選択の範囲に補正を入れてあります。
本当は緯度の補正は無くても良いはずですが、広めならいいだろ！ってことで雑に書いています。
本番で使いたい人は補正＆バリデーション頑張ってください(特に極の辺りで大変なことになるので)。</p>

<h3>その他DB</h3>

<p>力尽きたので簡単に。</p>

<p>SQLiteは<a href="https://www.gaia-gis.it/fossil/libspatialite/index">SpatiaLite</a>という拡張モジュールで空間データを扱えるようです。</p>

<p>全文検索エンジンの<a href="http://groonga.org/ja/">Groonga</a>も近傍検索に対応していて、
距離の計算方法は以下の3つから選べるようです。
(<a href="http://groonga.org/ja/docs/reference/functions/geo_distance.html"><code>geo_distance</code></a>)</p>

<ul>
<li><code>rectangle</code>: 方形近似して距離を計算</li>
<li><code>sphere</code>: <a href="https://github.com/groonga/groonga/blob/v7.0.0/lib/grn_geo.h#L42">半径6357303m</a>の完全な球体と仮定して計算</li>
<li><code>ellipsoid</code>: WGS84地球楕円体を<a href="http://yamadarake.jp/trdi/report000001.html">ヒュベニの距離計算式</a>で近似</li>
</ul>


<p>ヒュベニの距離計算式というのが出てきましたが、<code>ellipsoid</code>で使っているのは簡易版で、
<a href="http://www.amano-tec.com/apps/paceruler.html">本来のヒュベニの距離計算式</a>は非常に複雑で難しい・・・。</p>

<h2>まとめ</h2>

<p>Redis、PostgreSQL、MySQLで近傍検索をやってみました。</p>

<ul>
<li>Redisは近傍検索だけならお手軽</li>
<li>PostgreSQL+PostGISは今回触った中では最強。地理データを真面目に扱うならいいかも</li>
<li>MySQLは5.6以前よりは扱いやすくなったものの、空間インデックスを効果的に使うには一工夫必要</li>
</ul>


<p>PostgreSQL+PostGISと比べると、どうしてもMySQL5.7は見劣りしますね。
しかし、検索をSQLで書けるという利点は大きいので、利用を検討する価値はあると思います。</p>

<p>ところで、大体のDBで地球を完全な球で近似する実装が入ってるんですが、
半径が微妙に違うんですよね。</p>

<ul>
<li>Redis: 6 372 797.560 856m</li>
<li>PostgreSQL: 6 370 986m</li>
<li>MySQL: 6 370 986m</li>
<li>Groonga: 6 357 303m</li>
<li>赤道半径: 6 378 137m</li>
<li>極半径: 6 356 752.314 245m</li>
</ul>


<p>0.24%しか違わないので、実用上は全く問題ないんですが、
出典がよくわからないし気になります。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Go言語のchanはいったいいくつ付けられるのか試してみた]]></title>
    <link href="https://shogo82148.github.io/blog/2017/03/17/how-many-chan-can-i-write-in-golang/"/>
    <updated>2017-03-17T21:10:25+09:00</updated>
    <id>https://shogo82148.github.io/blog/2017/03/17/how-many-chan-can-i-write-in-golang</id>
    <content type="html"><![CDATA[<p>pecoに入った修正をみて、果たして<code>chan</code>はいくつまで付けられるのか気になったので、
雑に試してみました。
先に断っておきますが、全く有用ではないですよ。</p>

<!-- More -->


<h2>背景</h2>

<p>pecoに入った修正はこちら(一部抜粋)。</p>

<ul>
<li><a href="https://github.com/peco/peco/pull/411">Make Resume a blocking operation #411</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/interface.go b/interface.go</span>
</span><span class='line'><span class="gh">index 3d4472f..fff446c 100644</span>
</span><span class='line'><span class="gd">--- a/interface.go</span>
</span><span class='line'><span class="gi">+++ b/interface.go</span>
</span><span class='line'><span class="gu">@@ -162,8 +162,8 @@ type Screen interface {</span>
</span><span class='line'> // Termbox just hands out the processing to the termbox library
</span><span class='line'> type Termbox struct {
</span><span class='line'>  mutex     sync.Mutex
</span><span class='line'><span class="gd">-    resumeCh  chan (struct{})</span>
</span><span class='line'><span class="gd">-    suspendCh chan (struct{})</span>
</span><span class='line'><span class="gi">+    resumeCh  chan chan struct{}</span>
</span><span class='line'><span class="gi">+    suspendCh chan struct{}</span>
</span><span class='line'> }
</span><span class='line'>
</span><span class='line'> // View handles the drawing/updating the screen
</span><span class='line'><span class="gh">diff --git a/screen.go b/screen.go</span>
</span><span class='line'><span class="gh">index edbce87..f6dd71e 100644</span>
</span><span class='line'><span class="gd">--- a/screen.go</span>
</span><span class='line'><span class="gi">+++ b/screen.go</span>
</span><span class='line'><span class="gu">@@ -21,7 +21,7 @@ func (t *Termbox) Init() error {</span>
</span><span class='line'> func NewTermbox() *Termbox {
</span><span class='line'>  return &amp;Termbox{
</span><span class='line'>      suspendCh: make(chan struct{}),
</span><span class='line'><span class="gd">-        resumeCh:  make(chan struct{}),</span>
</span><span class='line'><span class="gi">+        resumeCh:  make(chan chan struct{}),</span>
</span><span class='line'>  }
</span><span class='line'> }
</span></code></pre></td></tr></table></div></figure>


<p>channelを使ってchannelをやり取りすることができるので、
<code>chan struct{}</code>をやり取りする<code>chan chan struct{}</code>という型が使えます。
同じ要領で、channelをやり取りするchannelをやり取りするchannelをやり取り&hellip;するchannelが
無限に作れるはずです(少なくとも構文上は)。
ということで、実際にやってみました。</p>

<h2>実験</h2>

<p>雑なPerlスクリプトを準備して、大量の<code>chan</code>を付けたGoのコードを自動生成します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">print</span> <span class="s">&lt;&lt;EOF;</span>
</span><span class='line'><span class="s">package main</span>
</span><span class='line'>
</span><span class='line'><span class="s">import (</span>
</span><span class='line'><span class="s">    &quot;fmt&quot;</span>
</span><span class='line'><span class="s">)</span>
</span><span class='line'>
</span><span class='line'><span class="s">type Foo @{[&#39;chan &#39; x 4096]} struct{}</span>
</span><span class='line'>
</span><span class='line'><span class="s">func main() {</span>
</span><span class='line'><span class="s">    fmt.Printf(&quot;Hello, %#v\\n&quot;, make(Foo))</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>chan</code>の個数を変えて何度かビルドを繰り返します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">time </span>go build -o main main.go
</span></code></pre></td></tr></table></div></figure>


<h2>結果</h2>

<p>chanの個数とビルドにかかった時間をまとめてみました。</p>

<table>
    <tr><th>chanの個数</th><th>ビルド時間</th></tr>
    <tr><td>1</td><td>0.236s</td></tr>
    <tr><td>2</td><td>0.240s</td></tr>
    <tr><td>4</td><td>0.226s</td></tr>
    <tr><td>8</td><td>0.234s</td></tr>
    <tr><td>16</td><td>0.240s</td></tr>
    <tr><td>32</td><td>0.250s</td></tr>
    <tr><td>64</td><td>0.281s</td></tr>
    <tr><td>128</td><td>0.258s</td></tr>
    <tr><td>256</td><td>0.360s</td></tr>
    <tr><td>512</td><td>0.775s</td></tr>
    <tr><td>1024</td><td>3.228s</td></tr>
    <tr><td>2048</td><td>18.605s</td></tr>
    <tr><td>4096</td><td>1m53.614s</td></tr>
    <tr><td>8192</td><td>13m46.018s(ビルド失敗したので参考記録)</td></tr>
</table>


<p>8192個付けたら以下のようなエラーを吐いてビルドが失敗してしまったので、
8192個の時の記録は参考記録です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># command-line-arguments
</span><span class='line'>too much data in section SDWARFINFO (over 2000000000 bytes)</span></code></pre></td></tr></table></div></figure>


<p>何かビルドの設定をいじればもっと行けるかもしれませんが、
デフォルトの設定では4096から8192の間に限界があるようです。
4096個<code>chan</code>を付けたときのソースコードは20KB程度なのにバイナリサイズは524MBまで膨らんでいました。</p>

<p>256個当たりからビルド時間に影響が出ているので、
ビルド時間を考える256個以下に抑えるのがよさそうです。
それ以上だと <script type="math/tex">O(n^{2.6})</script> 程度のオーダーでビルド時間が延びます。
とはいえ、256個も<code>chan</code>を付いたコードを人間が読めるとは思えないので、
2個が限度でしょうね・・・。
3個以上必要になるケースは余りないと思います。</p>

<h2>型定義を再帰的にして無限chanを実現する</h2>

<p>そもそも、<code>chan</code>を大量に並べなくとも、
型定義を再帰的に行えば無限の<code>chan</code>を付けたときと同等のことができます。
例えば以下のコードで"Goroutine 1"と"Goroutine 2"を交互に表示することが可能です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">type</span> <span class="nx">Foo</span> <span class="kd">chan</span> <span class="nx">Foo</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">Foo</span><span class="p">)</span>
</span><span class='line'>  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">ch</span> <span class="o">:=</span> <span class="nx">ch</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">done</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch</span>
</span><span class='line'>          <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Goroutine 2&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nx">done</span> <span class="o">&lt;-</span> <span class="nx">ch</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}()</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Goroutine 1&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">Foo</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">done</span>
</span><span class='line'>      <span class="nx">ch</span> <span class="p">=</span> <span class="o">&lt;-</span><span class="nx">done</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Hello, playground&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>channelでのやり取りが複雑になるので実用性があるかは不明ですが・・・。
例えば先程の例だと、普通にループを書いたほうが圧倒的にシンプルです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Goroutine 1&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Goroutine 2&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Hello, playground&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>無限<code>chan</code>が必要になる多くのケースは、このような書き換えができるような気がします。
(そもそも必要になったことがない)</p>

<h2>まとめ</h2>

<ul>
<li><code>chan</code>の個数の上限は4096から8192の間のどこか</li>
<li>256個あたりからビルド時間に影響が出始める

<ul>
<li>プログラムを読む人の精神力に多大な影響を与えるので、実際は2個までに留めるべきだと思う</li>
</ul>
</li>
<li>再帰的に型を定義することで、無限に<code>chan</code>を付けた時と同等のことが可能</li>
</ul>


<p><code>chan</code>を大量に付けたいケースには今までに僕自身は遭遇したことがないです。
有用な例を見つけた人は教えてください。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[HTTP/WebSocketで時刻同期するWebNTPを書いた]]></title>
    <link href="https://shogo82148.github.io/blog/2017/03/11/go-webntp/"/>
    <updated>2017-03-11T18:48:09+09:00</updated>
    <id>https://shogo82148.github.io/blog/2017/03/11/go-webntp</id>
    <content type="html"><![CDATA[<p>Go1.8から<a href="https://golang.org/pkg/net/http/httptrace/">http/httpgtrace</a>が追加され、
HTTP通信にフックを差し込めるようになりました。
以前触った時は<a href="https://shogo82148.github.io/blog/2017/01/14/re-golang-dns-cache/">パフォーマンス測定に利用</a>しましたが、
他に面白い活用法はないかとWebNTPというのを作ってみました。</p>

<ul>
<li><a href="https://github.com/shogo82148/go-webntp">webntp</a></li>
</ul>


<p>HTTP/HTTPS/Websocket上でNTP(Network Time Protocol)っぽいことをするプログラムです。</p>

<!-- More -->


<h2>HTTP/HTTPSで時刻同期</h2>

<p>日本標準時はNICTの管理する原子時計が基準になっており、
NICTでは原子時計に直結したNTPサーバー(ntp.nict.jp)の提供を行っています。
それに加えて、<a href="http://www.nict.go.jp/JST/http.html">https/httpサービス</a>も提供しており、
ブラウザを使って現在時刻を取得できます。</p>

<p>APIは簡単でミリ秒単位のtimestampを返してくれるだけです。
その情報からサーバーとクライアント間の時間のズレを算出するわけですが、
HTTP通信では、DNSの名前解決、TCPハンドシェイク、TLSハンドシェイク等々の時間が入ってしまうため、
正確なズレを求めることは困難です。</p>

<p>そこでhttp/httpgtraceを使って、ハンドシェイクを除いたリクエストの送信時刻、レスポンスを最初に受信した時刻から、
より正確なズレを知ることができるのではと作ったのがWebNTPです。
NICTの<a href="https://ntp-a1.nict.go.jp/cgi-bin/json">JSON形式のAPI</a>に対応しており、
以下のように時刻を取得できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go get github.com/shogo82148/go-webntp/cmd/webntp
</span><span class='line'>$ webntp https://ntp-a1.nict.go.jp/cgi-bin/json
</span><span class='line'>server https://ntp-a1.nict.go.jp/cgi-bin/json, offset -0.006376, delay 0.024411
</span><span class='line'>2017-03-11 16:08:06.150393313 +0900 JST, server https://ntp-a1.nict.go.jp/cgi-bin/json, offset -0.006376</span></code></pre></td></tr></table></div></figure>


<p>WebNTPはNICTのAPIと同様の内容を返すサーバーにもなれます。
本家のフォーマットにしたがい、しっかりとうるう秒の情報も返すようになっているので、
ntpdのSLEWモードを切った状態でお試しください。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ webntp -serve :8080
</span><span class='line'>
</span><span class='line'>$ curl -s http://localhost:8080/ | jq .
</span><span class='line'>{
</span><span class='line'>  "id": "localhost:8080",
</span><span class='line'>  "it": 0,
</span><span class='line'>  "st": 1489217288.328757,
</span><span class='line'>  "time": 1489217288.328757,
</span><span class='line'>  "leap": 36,
</span><span class='line'>  "next": 1483228800, // 今年の1/1にあったうるう秒の情報
</span><span class='line'>  "step": 1
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ところで、URLにcgi-binが入っているのは、過去との互換性を保つためにそうなっているのか、
今もCGIで動いているのか、気になる・・・
(少なくとも初期実装はPerlのCGIだったみたいですね)。</p>

<h2>Websocketで時刻同期</h2>

<p>HTTPで取れるのは便利ですが、これではブラウザ等や他のクライアントで正確な時間を知るのが難しいです。
今ならWebSocketが使えるのでは？と、WebSocketにも対応してみました。
時刻取得時にws/wssスキーマを指定するとWebSocketモードになります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ webntp ws://localhost:8080/
</span><span class='line'>server ws://localhost:8080/, offset 0.000031, delay 0.000671
</span><span class='line'>2017-03-11 16:19:29.850452219 +0900 JST, server ws://localhost:8080/, offset 0.000031</span></code></pre></td></tr></table></div></figure>


<p>ブラウザからもJavaScriptを使ってアクセスできるというのが大きな利点ですね。
TCP上での通信のためNTPに比べればもちろん精度は落ちますが、
スプラトゥーンができる程度のネットワーク環境であれば±十数ミリ秒程度の誤差に収まるのではないでしょうか。</p>

<h2>ntpdの参照クロックとして使う</h2>

<p>実装している最中にいろいろと調べてみたところ、
ntpdはNTPでネットワークから時刻を取得する以外に、コンピュータに直結したデバイスからも時刻情報を取得できることがわかりました。
たとえばGPSモジュールを繋いで、GPSに積まれている原子時計と同期をとることができるらしいです。</p>

<p>同期方法はたくさんあるのですが、Shared Memory <a href="http://doc.ntp.org/4.2.8/drivers/driver28.html">driver28</a>というのが
比較的ポピュラーなようです。
Python+SWIGの実装(<a href="https://github.com/mjuenema/python-ntpdshm">python-ntpdshm</a>)があったので、
それを参考にGoに移植しました。</p>

<p><code>ntpd.conf</code>にShared Memoryと同期する設定を追加します。
アドレス部分に<code>127.127.28.x</code>を指定するとShared Memoryになるそうです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server 127.127.28.2 noselect
</span><span class='line'>fudge 127.127.28.2 refid PYTH stratum 10</span></code></pre></td></tr></table></div></figure>


<p><code>-shm x</code>をオプションにつけると、ntpdとの同期モードになり、
HTTP等で取得した時刻情報をntpdに送信します。
デフォルトだと4回連続でAPIを叩いて怒られそうなので、<code>-p 1</code>も一緒につけています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ webntp -p 1 -shm 2 https://ntp-a1.nict.go.jp/cgi-bin/json https://ntp-b1.nict.go.jp/cgi-bin/json
</span><span class='line'>server https://ntp-a1.nict.go.jp/cgi-bin/json, offset -0.003258, delay 0.018910
</span><span class='line'>server https://ntp-b1.nict.go.jp/cgi-bin/json, offset -0.003570, delay 0.021652</span></code></pre></td></tr></table></div></figure>


<p>しばらくしてから、ntpdのステータスを確認すると、
remote:SHM(2)にoffset情報が表示されるはずです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ntpq -p
</span><span class='line'>     remote           refid      st t when poll reach   delay   offset  jitter
</span><span class='line'>==============================================================================
</span><span class='line'> SHM(2)          .PYTH.          10 l    2   64   17    0.000   -3.331   0.384
</span><span class='line'>*ntp-a2.nict.go. .NICT.           1 u   58   64   37   10.280    1.494   2.028</span></code></pre></td></tr></table></div></figure>


<h2>その他類似プロジェクト</h2>

<p>HTTPで時刻同期というアイデア自体はすでにあったようで、
<a href="http://www.htptime.org/index.html">htptime</a>というものがありました。
WebNTPはhtptimeのサーバーとも同期できます。
AWS Lambdaで動いているhtptimeサーバーも公開されているのですが、Internal Server Errorしか帰ってこない・・・。</p>

<p><a href="http://www.vervest.org/htp/">htp</a>はhtptimeの元ネタらしいです。
HTTPのDateヘッダーで時刻合わせするので、秒単位でしか同期できません。
WebNTPでは未対応です。</p>

<h2>まとめ</h2>

<ul>
<li>http/httpgtraceの活用法としてWebNTPというのを作ってみた</li>
<li>HTTP/HTTPS/WebSocketでの同期が可能(UDP通信を禁止されている環境でも大丈夫！)</li>
<li>取得した時刻をntpdに反映することも可能</li>
</ul>


<p>UDP/123が禁止されている環境って今はどの程度あるんですかね？</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[go-JSONStoreの高速化と機能追加]]></title>
    <link href="https://shogo82148.github.io/blog/2017/03/05/tune-up-go-jsonstore/"/>
    <updated>2017-03-05T16:19:25+09:00</updated>
    <id>https://shogo82148.github.io/blog/2017/03/05/tune-up-go-jsonstore</id>
    <content type="html"><![CDATA[<p>以前mattnさんが紹介していた<a href="https://github.com/schollz/jsonstore">schollz/jsonstore</a>。
時間が経ってしまいましたが「ここは高速化できそうだなー」といじってみたので、
やってみたことをメモ。</p>

<p>本来は上流にフィードバックしたほうがよいのですが、
本家のほうも修正が入ってコンフリクトして面倒になったので、
フォーク版をそのまま置いておきます。</p>

<ul>
<li><a href="https://github.com/shogo82148/jsonstore">shogo82148/jsonstore</a></li>
</ul>


<!-- More -->


<h2>高速化</h2>

<p>まだまだ高速化できそうなところがあったので、いじってみた部分です。</p>

<h3>ロックの範囲を最小にする</h3>

<p>ロックの範囲を小さくすることで、並列処理時の性能が上がります。
例えば、jsonstoreに値を入れる<code>Set</code>メソッドは、
以下のように<code>Set</code>全体がロックの対象になっていました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">JSONStore</span><span class="p">)</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Set の中全体がロックの対象になっている</span>
</span><span class='line'>  <span class="nx">s</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</span><span class='line'>  <span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">err</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">s</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">)(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">nil</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>jsonのエンコード処理はjsonstoreの中身を触らないので並列実行可能です。
次のように <code>s.data</code> だけをロックの対象にすれば十分です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">JSONStore</span><span class="p">)</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// json.Marshal は並列実行可能</span>
</span><span class='line'>  <span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">err</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// s.data を触る直前でロック</span>
</span><span class='line'>  <span class="nx">s</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</span><span class='line'>  <span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">s</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">)(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">nil</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>デコード処理も同様に並列化が可能なので、<code>Get</code>にも同じ修正をいれました。
修正前後でベンチを取ってみたところ以下のようになりました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Before:
</span><span class='line'>BenchmarkGet-4                 1000000          1923 ns/op         272 B/op          5 allocs/op
</span><span class='line'>BenchmarkParaGet-4             1000000          1000 ns/op         272 B/op          5 allocs/op
</span><span class='line'>BenchmarkSet-4                 1000000          1159 ns/op         216 B/op          3 allocs/op
</span><span class='line'>BenchmarkParaSet-4             1000000          1974 ns/op         216 B/op          3 allocs/op
</span><span class='line'>
</span><span class='line'>After:
</span><span class='line'>BenchmarkGet-4             1000000          1793 ns/op         256 B/op          4 allocs/op
</span><span class='line'>BenchmarkParaGet-4         2000000           845 ns/op         256 B/op          4 allocs/op
</span><span class='line'>BenchmarkSet-4             1000000          1212 ns/op         248 B/op          4 allocs/op
</span><span class='line'>BenchmarkParaSet-4         2000000           686 ns/op         248 B/op          4 allocs/op</span></code></pre></td></tr></table></div></figure>


<p>Paraが付いているのが並列実行したとき、付いていないのが単一のgorotineで実行したときの結果です。
単一gorotineでは修正前後で余り大きな性能差はありませんが、
並列実行の性能が向上していることがわかりますね。</p>

<p>(他にも細々とした修正を入れたので、全部がロックの効果ではないと思いますが)</p>

<h3>ストリーミングAPIを利用する</h3>

<p>ファイル保存時にjsonのエンコーディングをしているのですが、
修正前のコードでは<code>json.MarshalIndent</code>を使用していました。
<code>json.MarshalIndent</code>は結果をメモリ上に出力するので、
メモリの消費量が増え、そのメモリをアロケーションする分だけ性能が劣化します。</p>

<p><code>io.Writer</code>に書き込むだけなら、以下のように<code>json.NewEncoder</code>を利用するのが効率的です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">enc</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewEncoder</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
</span><span class='line'><span class="k">return</span> <span class="nx">enc</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>不要な再エンコードを避ける</h3>

<p>元のコードでは一度jsonに変換した値を、ファイル保存時に<code>string</code>にキャストしていました。
そのため、出力されたjsonは以下のように文字列の中にjsonが入っている形になります。
この形式だと<code>"</code>のエスケープが必要になるので、
処理性能的にも、ファイル容量的にも不利です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;encoding/json&quot;</span>
</span><span class='line'>  <span class="s">&quot;os&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">b</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&quot;Name&quot;:&quot;Dante&quot;,&quot;Height&quot;:5.4}`</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">data</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;human:1&quot;</span><span class="p">:</span> <span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="c1">// ここでキャストしている</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">enc</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewEncoder</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">enc</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;human:1&quot;</span><span class="p">:</span> <span class="s2">&quot;{\&quot;Name\&quot;:\&quot;Dante\&quot;,\&quot;Height\&quot;:5.4}&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>値は既にjsonエンコード済みなので、ファイル出力時に手を加える必要はありません。
以下のように<code>*json.RawMessage</code>型に変換することで、
余計な再エンコードを避けることができます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;encoding/json&quot;</span>
</span><span class='line'>  <span class="s">&quot;os&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">b</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&quot;Name&quot;:&quot;Dante&quot;,&quot;Height&quot;:5.4}`</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">data</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;human:1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">)(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">),</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">enc</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewEncoder</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">enc</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;human:1&quot;</span><span class="p">:{</span><span class="nt">&quot;Name&quot;</span><span class="p">:</span><span class="s2">&quot;Dante&quot;</span><span class="p">,</span><span class="nt">&quot;Height&quot;</span><span class="p">:</span><span class="mf">5.4</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>json.RawMessage</code>でなく<code>*json.RawMessage</code>とポインタを使っているのがポイントです。
<code>json.RawMessage</code>だと<code>[]byte</code>とみなされてbase64エンコーディングされてしまうのです・・・。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;encoding/json&quot;</span>
</span><span class='line'>  <span class="s">&quot;os&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">b</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&quot;Name&quot;:&quot;Dante&quot;,&quot;Height&quot;:5.4}`</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">data</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;human:1&quot;</span><span class="p">:</span> <span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">enc</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewEncoder</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">enc</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">//</span> <span class="err">Go</span><span class="mf">1.7</span><span class="err">以下で実行時</span>
</span><span class='line'><span class="p">{</span><span class="nt">&quot;human:1&quot;</span><span class="p">:</span><span class="s2">&quot;eyJOYW1lIjoiRGFudGUiLCJIZWlnaHQiOjUuNH0=&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="err">//</span> <span class="err">Go</span><span class="mf">1.8</span><span class="err">で実行時</span>
</span><span class='line'><span class="p">{</span><span class="nt">&quot;human:1&quot;</span><span class="p">:{</span><span class="nt">&quot;Name&quot;</span><span class="p">:</span><span class="s2">&quot;Dante&quot;</span><span class="p">,</span><span class="nt">&quot;Height&quot;</span><span class="p">:</span><span class="mf">5.4</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ちなみにこの挙動、1.8で<code>json.RawMessage</code>も<code>*json.RawMessage</code>と同じ結果になる修正されたようです(この記事を書いていて気がついた)。
1.7以下を切り捨てるなら<code>json.RawMessage</code>の方が良さそうですね。</p>

<p>「ストリーミングAPIを利用する」「不要な再エンコードを避ける」をやった結果は以下のとおりです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Before:
</span><span class='line'>BenchmarkSave-4                    500       3324647 ns/op     1418718 B/op       3121 allocs/op
</span><span class='line'>
</span><span class='line'>After:
</span><span class='line'>BenchmarkSave-4                500       2455853 ns/op     1127372 B/op       3094 allocs/op</span></code></pre></td></tr></table></div></figure>


<h3>浅いコピーで並列処理性能を上げる</h3>

<p>一度<code>Set</code>で<code>json.RawMessage</code>に変換されたデータは書き換えられることがないので、
浅いコピーをするだけでスナップショットが簡単にとれます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">JSONStore</span><span class="p">)</span> <span class="nx">Snapshot</span><span class="p">()</span> <span class="o">*</span><span class="nx">JSONStore</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">s</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
</span><span class='line'>  <span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">results</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">)</span>
</span><span class='line'>  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">results</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">JSONStore</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">data</span><span class="p">:</span>     <span class="nx">results</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>一度スナップショットを取ってしまえば、ファイルへの書き込み時にはロックが不要になります。
ファイルの書き込みはI/Oを伴うとても重い処理なので、
この部分をロックの外側に出せるのは非常に効果大です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">JSONStore</span><span class="p">)</span> <span class="nx">Save</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">snapshot</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Snapshot</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// snapshotを取ったあとはLock不要</span>
</span><span class='line'>  <span class="nx">enc</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewEncoder</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">enc</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>別gorotineでひたすらSaveを繰り返しながらSetのベンチを取ってみた結果です。
修正前はSaveがほとんどの時間ロックを獲得していまうので、Saveと同程度の性能しか出ません。
修正後はSaveとSetを並列実行できるようになるので、大幅に性能が改善します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Before:
</span><span class='line'>BenchmarkSaveSet-4                 500       3260143 ns/op     1382516 B/op       3047 allocs/op
</span><span class='line'>
</span><span class='line'>After:
</span><span class='line'>BenchmarkSaveSet-4         1000000          1948 ns/op         914 B/op          5 allocs/op</span></code></pre></td></tr></table></div></figure>


<h3>正規表現をなるべく避ける</h3>

<p>元のjsonstoreには正規表現でキーを指定して値を取ってくる機能があります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">GetAll</span><span class="p">(</span><span class="nx">re</span> <span class="o">*</span><span class="nx">regexp</span><span class="p">.</span><span class="nx">Regexp</span><span class="p">)</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span>
</span></code></pre></td></tr></table></div></figure>


<p>Gopherのみなさんなら御存知の通り、Goの正規表現はとても遅いです。
stringsパッケージなどを使えるよう、関数を受け取るインターフェースの方がよいでしょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">GetAll</span><span class="p">(</span><span class="nx">matcher</span> <span class="kd">func</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span><span class="p">)</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span>
</span></code></pre></td></tr></table></div></figure>


<p>このインターフェースなら簡単なものであれば自分で関数をかけば良いし、
どうしても正規表現が必要な場合は<code>s.GetAll(re.MatchString)</code>とやればいいので大きな問題にはなりません。</p>

<p>以下ベンチマークの結果です。Afterの方は正規表現ではなくstringsパッケージを使用しています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Before:
</span><span class='line'>BenchmarkRegex-4                  3000        449209 ns/op      206954 B/op         67 allocs/op
</span><span class='line'>
</span><span class='line'>After:
</span><span class='line'>BenchmarkRegex-4              5000        251788 ns/op      124483 B/op         68 allocs/op</span></code></pre></td></tr></table></div></figure>


<h2>機能追加</h2>

<p>実際使うなら最低限こんな機能も必要だよな・・・
といくつか機能追加も行いました。</p>

<h3>アトミックなデータ保存</h3>

<p>例えば<code>humans.json.gz</code>に保存されたデータを書き換えることを考えます。
単純に書くと以下のようになるでしょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">ks</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">jsonstore</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;humans.json.gz&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ksに何か操作を行う</span>
</span><span class='line'>
</span><span class='line'><span class="k">go</span> <span class="nx">jsonstore</span><span class="p">.</span><span class="nx">Save</span><span class="p">(</span><span class="nx">ks</span><span class="p">,</span> <span class="s">&quot;humans.json.gz&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// もしpanicしたら・・・？</span>
</span><span class='line'><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;error!!&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ここでもしSaveの最中にプログラムが強制終了してしまったらどうなるでしょう。
書きかけの<code>humans.json.gz</code>だけが残り、元のデータが失われてしまう可能性があります。</p>

<p>それを避けるために、一度テンポラリファイルに書き出し、Renameするのが安全です。
たとえ途中でクラッシュしてしまっても、最悪変更前のデータは残ります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">ks</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">jsonstore</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;humans.json.gz&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ksに何か操作を行う</span>
</span><span class='line'>
</span><span class='line'><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">jsonstore</span><span class="p">.</span><span class="nx">Save</span><span class="p">(</span><span class="nx">ks</span><span class="p">,</span> <span class="s">&quot;humans.json.tmp.gz&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">os</span><span class="p">.</span><span class="nx">Rename</span><span class="p">(</span><span class="s">&quot;humans.json.tmp.gz&quot;</span><span class="p">,</span> <span class="s">&quot;humans.json.gz&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}()</span>
</span><span class='line'>
</span><span class='line'><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;error!!&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>これを勝手にやってくれる<code>SaveAndRename</code>という関数を追加しました。</p>

<p>Linuxの場合、Renameはアトミックに行われるので、
サーバを起動したままデータベースのバックアップを取るのも安全にできます。
しかしWindowsの場合、アトミック性は保証されていない模様・・・？
本当は<code>SafeSave</code>とかにしたかったけど、Windowsの事情がよくわからなったので、
やってることをそのまま名前にしました。</p>

<h3>自動保存機能</h3>

<p>変更のたびに毎回ファイルに書き込んでいたら、極端に性能が劣化してしまうので、
適当なタイミングで自動保存してくれる機能を追加しました。
次のようにすることで、1000回変更があるたびに保存、
変更回数が1000回に満たなくても最低60秒毎に保存してくれます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">ks</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">jsonstore</span><span class="p">.</span><span class="nx">JSONStore</span><span class="p">)</span>
</span><span class='line'><span class="nx">ks</span><span class="p">.</span><span class="nx">StartAutoSave</span><span class="p">(</span><span class="s">&quot;db.json.gz&quot;</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'><span class="k">defer</span> <span class="nx">ks</span><span class="p">.</span><span class="nx">StopAutoSave</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>以下の高速化を行いました。</p>

<ul>
<li>ロックの範囲を最小にする</li>
<li>ストリーミングAPIを利用する</li>
<li>不要な再エンコードを避ける</li>
<li>浅いコピーで並列処理性能を上げる</li>
<li>正規表現をなるべく避ける</li>
</ul>


<p>また、実際使う際に必要になるであろう、次の機能も追加しました。</p>

<ul>
<li>アトミックなデータ保存</li>
<li>自動保存機能</li>
</ul>


<p>これだけあれば、簡単なおもちゃを作るときのデータベースに使うくらいは出来るんじゃないですかね。</p>

<p>プロセス間でデータ共有できない問題はありますが・・・
まあ、そういうときは素直にRedisとかSQLiteとかboltdbとか使って下さい。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Redisを使ってユニークなIDを配布する]]></title>
    <link href="https://shogo82148.github.io/blog/2017/02/26/unique-id-supplier-using-redis/"/>
    <updated>2017-02-26T19:37:45+09:00</updated>
    <id>https://shogo82148.github.io/blog/2017/02/26/unique-id-supplier-using-redis</id>
    <content type="html"><![CDATA[<p>スケーラブルにIDを生成する方法として
Twitterの<a href="https://github.com/twitter/snowflake">snowflake</a>が有名です。
1024台までスケールすることが出来ますが、各snowflakeのサーバにユニークなWoker IDを割り振る必要があります。
IDを振るためのサーバにIDを振るのが問題になるとは難しいですね。</p>

<p>各snowflakeサーバにIDを振る親玉Worker ID配布サーバを作るというアイデアはあったのですが、
Worker IDサーバの可用性を考えるのが大変で手を付けていませんでした。
最近になってWorker IDサーバとしてRedisを使い、ソート済みセット型で管理すれば楽できるのでは？
と思いついたので、やってみたというお話です。</p>

<!-- More -->


<h2>概要</h2>

<p>レポジトリはこちらです。</p>

<ul>
<li><a href="https://github.com/shogo82148/yaraus">shogo82148/yaraus</a></li>
</ul>


<p>他の<a href="https://github.com/twitter/snowflake">snowflake</a>-likeなID発番サーバの実装として
<a href="http://techblog.kayac.com/katsubushi-introduction.html">katsubushi</a>や
<a href="https://github.com/sony/sonyflake">sonyflake</a>なんていうのもあります。
これらのID発番サーバにRedisを使ってWorker IDを割り振るコマンドです。
Redis3.2以上推奨です。</p>

<h2>使い方</h2>

<p>Go製なので<code>go get</code>でインストールできます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>go get github.com/shogo82148/yaraus/cmd/yaraus
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 1から1023までのIDが使えるようにRedisを初期化</span>
</span><span class='line'><span class="nv">$ </span>yaraus init -min <span class="m">1</span> -max 1023
</span><span class='line'>
</span><span class='line'><span class="c"># ユニークなIDが必要な処理を実行する</span>
</span><span class='line'><span class="nv">$ </span>yaraus run -- <span class="nb">echo</span> <span class="o">{}</span>
</span><span class='line'>2017/02/25 17:19:16 getting new id...
</span><span class='line'>2017/02/25 17:19:16 client id: YourHostName-1488010756.738-1, id: 1
</span><span class='line'>2017/02/25 17:19:16 sleep 2s <span class="k">for</span> making sure that other generates which has same id expire.
</span><span class='line'>2017/02/25 17:19:18 starting...
</span><span class='line'>1
</span><span class='line'>2017/02/25 17:19:18 releasing id...
</span><span class='line'>
</span><span class='line'><span class="c"># katsubushiと一緒に使う例</span>
</span><span class='line'><span class="nv">$ </span>yaraus run -- ./katsubushi -worker-id<span class="o">={}</span> -port<span class="o">=</span>7238
</span><span class='line'>
</span><span class='line'><span class="c"># ステータス情報もとれます</span>
</span><span class='line'><span class="nv">$ </span>yaraus stats
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;client_id_count&quot;</span>: 4,
</span><span class='line'>    <span class="s2">&quot;client_get_id_count&quot;</span>: 4,
</span><span class='line'>    <span class="s2">&quot;client_get_id_success&quot;</span>: 4,
</span><span class='line'>    <span class="s2">&quot;get_id_no_available_id&quot;</span>: 0,
</span><span class='line'>    <span class="s2">&quot;extend_ttl_count&quot;</span>: 8,
</span><span class='line'>    <span class="s2">&quot;extend_ttl_success&quot;</span>: 8,
</span><span class='line'>    <span class="s2">&quot;extend_ttl_ownership_error&quot;</span>: 0,
</span><span class='line'>    <span class="s2">&quot;extend_ttl_expire_warning&quot;</span>: 0,
</span><span class='line'>    <span class="s2">&quot;unusing_ids&quot;</span>: 1023,
</span><span class='line'>    <span class="s2">&quot;using_ids&quot;</span>: 0,
</span><span class='line'>    <span class="s2">&quot;using_ttl_max&quot;</span>: 0,
</span><span class='line'>    <span class="s2">&quot;using_ttl_mid&quot;</span>: 0,
</span><span class='line'>    <span class="s2">&quot;using_ttl_min&quot;</span>: 0
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ステータスの意味は以下の通りです。</p>

<ul>
<li><code>client_id_count</code>: 今までに接続してきたクライアントの延べ数</li>
<li><code>client_get_id_count</code>: ID取得を試みた回数</li>
<li><code>client_get_id_success</code>: ID取得に成功した回数</li>
<li><code>get_id_no_available_id</code>: 利用可能なIDが無くて失敗した回数</li>
<li><code>extend_ttl_count</code>: Expireを伸ばそうと試みた回数</li>
<li><code>extend_ttl_success</code>: Expireを伸ばすのに成功した回数</li>
<li><code>extend_ttl_ownership_error</code>: IDが横取りされた回数</li>
<li><code>extend_ttl_expire_warning</code>: IDが横取りされそうだったのを防いだ回数</li>
<li><code>unusing_ids</code>: 未使用のIDの数</li>
<li><code>using_ids</code>: 使用中のIDの数</li>
<li><code>using_ttl_max</code>: IDの寿命の最大値(秒単位)</li>
<li><code>using_ttl_mid</code>: IDの寿命の中央値(秒単位)</li>
<li><code>using_ttl_min</code>: IDの寿命の最小値(秒単位)</li>
</ul>


<h2>実装アイデア</h2>

<p>Redisのセット型を使えば、ID配布自体は簡単です。
Perlでの実装は以下のようになります。(Go実装なのに例がPerlなのは、僕が一番慣れているので・・・)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># あらかじめPoolにIDを蓄えておく</span>
</span><span class='line'><span class="nv">$redis</span><span class="o">-&gt;</span><span class="n">sadd</span><span class="p">(</span><span class="s">&#39;pool&#39;</span><span class="p">,</span> <span class="s">&quot;id$_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># ランダムに選ぶ</span>
</span><span class='line'><span class="k">my</span> <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$redis</span><span class="o">-&gt;</span><span class="n">spop</span><span class="p">(</span><span class="s">&#39;pool&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 使い終わったら戻す</span>
</span><span class='line'><span class="nv">$redis</span><span class="o">-&gt;</span><span class="n">sadd</span><span class="p">(</span><span class="s">&#39;pool&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>多めに見積もって1IDあたり1kB使うと仮定しても、1000個のIDで約1MBです。
余裕で全部メモリにのるので、オンメモリのRedisでも全く問題ありません。</p>

<p>しかし、この方法では、IDを受け取ったクライアントが突然死してしまった場合に
永遠にIDが開放されないため、そのうちIDが枯渇してしまいます。</p>

<p>そこで思いついたのが、ソート済みセット型を使ったExpire付き機能付きID配布です。
「ソート済みセットのスコアにExpireの予定時刻を入れる」というルールでIDを管理します。
ソート済みセットを使えば、「スコアが一番小さいID＝Expireしている可能性が一番高いID」
を簡単に取得できます。
現在時刻と比較して実際にExpireしているかをチェックし、ExpireしていたらID取得成功です。
Perlのコードに起こすと以下のようになります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># PoolにID追加</span>
</span><span class='line'><span class="nv">$redis</span><span class="o">-&gt;</span><span class="n">zadd</span><span class="p">(</span><span class="s">&#39;pool&#39;</span><span class="p">,</span> <span class="nb">time</span><span class="p">,</span> <span class="s">&quot;id$_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># IDを取得</span>
</span><span class='line'><span class="n">RETRY:</span>
</span><span class='line'><span class="k">my</span> <span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$score</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$redis</span><span class="o">-&gt;</span><span class="n">zrange</span><span class="p">(</span><span class="s">&#39;pool&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;WITHSCORE&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># expireしているかチェック</span>
</span><span class='line'><span class="k">if</span> <span class="nv">$score</span> <span class="o">&lt;</span> <span class="nb">time</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1"># ID取得失敗、しばらく待ってID取得やり直し</span>
</span><span class='line'>    <span class="nb">sleep</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="nb">goto</span> <span class="n">RETRY</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># expireの期間延長</span>
</span><span class='line'><span class="k">my</span> <span class="nv">$expire</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1"># 10秒でexpire</span>
</span><span class='line'><span class="nv">$redis</span><span class="o">-&gt;</span><span class="n">zadd</span><span class="p">(</span><span class="s">&#39;pool&#39;</span><span class="p">,</span> <span class="nb">time</span> <span class="o">+</span> <span class="nv">$expire</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># $idを使ったなにかの処理</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 使い終わったらExpire扱い</span>
</span><span class='line'><span class="nv">$redis</span><span class="o">-&gt;</span><span class="n">zadd</span><span class="p">(</span><span class="s">&#39;pool&#39;</span><span class="p">,</span> <span class="nb">time</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>クライアントが突然死していまうと、Expireが更新されないため
どんどんRankがあがっていき、最終的には別のクライアントに再利用されます。</p>

<p>この方法であれば、Expireしてからの期間が長いIDから再利用されるというのも利点です。
どうしてもサーバとクライアントで時刻のズレが生じてしまうので、
サーバはExpireした！と思っても、クライアントがまだ使用中ということは十分に考えられます。
そのためExpireしたIDをすぐに再利用してしまうと、多重使用になってしまう可能性があります。
Expireしてからの期間が長いIDから再利用することで、この問題を緩和できるというわけです。</p>

<p>(Googleさんみたいに分散データベース管理に原子時計を導入していれば話は別ですが・・・)</p>

<p>ソート済みセット型のScoreは64bitの浮動小数点型なので、
scoreにunix timestampを使うとマイクロ秒程度の精度になってしまいますが、
この用途であれば十分足りるでしょう。</p>

<h2>実装上の工夫</h2>

<p>このアイデアなら楽できる！と思ったものの、
実際にコードに起こすとなると考慮すべきことがたくさんあって大変でした。</p>

<h3>ID取得とExpire期間延長をアトミックにする</h3>

<p>先のコード例をそのまま実装すると同時アクセスがあった場合にIDプールが壊れます。
それを防ぐために
「IDを取得」「expireしているかチェック」「expireの期間延長」はアトミックに実行する必要があります。</p>

<p>Redisの場合、Luaスクリプトを使えば簡単ですね。
慣れないLuaに少し手こずりましたが、一度覚えてしまうと全部Luaにしたくなってしまう麻薬ですね、あれは。</p>

<h3>Luaスクリプト内で時刻を取得する</h3>

<p>このアイデアは時刻が肝なので、可能であれば時刻の管理もRedisサーバに一任したいところです。
しかし、Luaスクリプト内ではOS機能のモジュールが無効化されており、時刻の取得はできません。
ファイルもいじれる危ないモジュールなので仕方ないですね。</p>

<p>ではどうするかというと、LuaからRedisのTIMEコマンドを呼び出して時刻を取得します。
しかしながら、この方法も一筋縄ではいかず、何もせずに呼び出すとコマンドの実行に失敗してしまいます。</p>

<p>TIMEコマンドが失敗する原因はLuaスクリプトのレプリケーションの方法にあります。
Redisのレプリケーション方法は、マスターからスクリプトをまるごとスレーブに送り、スレーブ側でスクリプト再実行する方式です。
そのため、TIMEコマンドのように実行するタイミングによって結果が変わるコマンドは、
マスターとスレーブで不整合が起きてしまう可能性があるため実行できないのです。</p>

<p>この問題を解決するため、Redis3.2から <code>redis.replicate_commands</code> が追加されました。
この関数を呼び出すと、Luaスクリプト内で実行したRedisへの書き込みコマンドを転送するレプリケーション方式に変わります。
実行結果だけを送るのでTIMEコマンドも安全に実行できるというわけです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='lua'><span class='line'><span class="n">redis</span><span class="p">.</span><span class="n">replicate_commands</span><span class="p">()</span>
</span><span class='line'><span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">TIME&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">time</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-6</span> <span class="c1">-- 秒単位に変換</span>
</span></code></pre></td></tr></table></div></figure>


<p>なお、<code>redis.replicate_commands</code>が使えない場合は、クライアントの時刻を使うようフォールバックするので、
3.2よりまえのRedisでも動作はします。</p>

<p>ちなみにレプリケーションの挙動を変えるコマンドは他にもあって、
<code>redis.set_repl</code>を使うとレプリケーション自体を止めることも出来るらしいです。
怖い。</p>

<h3>若い番号のIDから配布する</h3>

<p>これはあまり重要ではないんですが、Expireまでの期間が同じだった場合、
若い番号のIDから順に配布するようにしました。
「エライ人順にIPアドレスを設定しろ」みたいなアレなので、
別に考慮しなくてもいいんですが、数字を見ると順番に並べたくなってしまうのが人間というものです。</p>

<p>Redisのソート済みセットはスコアが同じ場合、メンバーの辞書順に並びます。
<code>Itoa(id)</code>した結果をそのまま辞書順ソートすると</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1, 10, 11, 12, ..., 2, 20, 21, ...</span></code></pre></td></tr></table></div></figure>


<p>のようなおかしな順番になってしまいます。
そこで、「1桁のときは頭にAを付ける」「2桁のときはB」「3桁のときはC」&hellip;
と先頭の文字で数字の桁数が分かるようにしました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>A1, A2, A3, ..., A9, B10, B11, B12, ... B99, C100, C101, C102, ...</span></code></pre></td></tr></table></div></figure>


<p>この規則はRFC2550をヒントにしました。
RFC2550にはZまで使い切ったあとのことも書いてあるんですが、そこまではしていません。
可読性にこだわらなければ他にも方法はあるのですが、redis-cliで見れたほうが嬉しいじゃないですか。</p>

<ul>
<li><a href="https://tools.ietf.org/html/rfc2550">RFC 2550 Y10K and Beyond</a></li>
<li><a href="http://www.cam.hi-ho.ne.jp/mendoxi/rfc/rfc2550j.html">参考日本語訳 RFC 2550 Y10K とその先</a></li>
</ul>


<h3>レプリケーション完了を待つ</h3>

<p>可用性を求めるならば、Redisサーバー自体が突然死する可能性も考えなければなりません。
この問題に対応するにはマスタースレーブ構成を取るのが一般的でしょう。
マスタースレーブ構成ではフェールオーバー時に多少のデータ消失が起こる可能性があります。
レプリケーションが終わっていない分のデータが消失するためです。</p>

<p>キャッシュ用途であれば許容できるかもしれませんが、
ID配布でこれが起こるのは致命的です。
配布したIDをもとにデータベースへの書き込みを行うので、整合性が崩れ、修復困難なダメージを与えてしまう可能性があります。</p>

<p>この問題を最小限に抑えるために、2.8からWAITコマンドが追加されています。
WAITコマンドを使うと、今まで書き込んだデータがレプリケーションされたかを検出できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ROLEコマンドでスレーブの台数を確認
</span><span class='line'>127.0.0.1:6379&gt; ROLE
</span><span class='line'>1) "master"
</span><span class='line'>2) (integer) 83
</span><span class='line'>3) 1) 1) "::1"     # 一台スレーブ
</span><span class='line'>      2) "6378"
</span><span class='line'>      3) "83"
</span><span class='line'>
</span><span class='line'># 適当に書き込み
</span><span class='line'>127.0.0.1:6379&gt; SET foo bar
</span><span class='line'>OK
</span><span class='line'>
</span><span class='line'># 1つのスレーブのレプリケーションが完了するのを待つ(Timeout 1000ms)
</span><span class='line'>127.0.0.1:6379&gt; WAIT 1 1000
</span><span class='line'>(integer) 1 # レプリケーションが完了したスレーブの台数</span></code></pre></td></tr></table></div></figure>


<p>レプリケーションの完了＝コマンドの実行完了と解釈すれば、
データの消失を最小限に抑えることができます。</p>

<p>ちなみに、WAITコマンドのtimeoutはミリ秒ですが、今回使用した<a href="https://godoc.org/gopkg.in/redis.v5">go-redis/redis</a>は
これを秒として扱っていました。
(こういうのRedis::Fast開発時にもあった気がする)
単位重要ですね。
time.ParseDurationで時間指定をすると、毎回単位指定が必要になって面倒ですが、
こういうミスを防ぐためには有用そうです。
積極的に使っていきたい。</p>

<h3>横取り検出</h3>

<p>WAITコマンドでデータの消失を最小限にしたとしても、0にできるわけではありません。
消失が起こった場合の対応も必要です。
ID配布した記録が消えて横取りが出来る可能性があるので、
IDに所有者(貸出先の方が正しかったかも)を一緒に記録しておくことにしました。</p>

<p>各クライアントにクライアントIDを付与しておきます。(現状の実装はhostname+timestamp+連番)
横取りされた方は、自分のクライアントIDとIDの所有者を比較し、横取りが分かった時点で速やかにID開放します。
横取りした方は、ID取得からID使用までしばらく時間を開けます(-delayでこの時間は変更可能)
これは横取りされた方のID開放が終わるまで、猶予時間を与えるためです。</p>

<h2>動作条件等</h2>

<p>何度か書いていますが、このアイデアは時刻が肝です。
各サーバ間の時刻同期が正しく行われている必要があります。
普通にNTPを使っていればmsのオーダーで同期が取れるので問題ないでしょう。</p>

<p>・・・ただし、みんな大嫌いなうるう秒があります。
うるう秒の対応の仕方がまちまちなので、ことなった対応方針が適用されたサーバーが混ざると大変です。</p>

<p>例えば、マネージドなRedisとしてElastiCacheを使うと、
うるう秒挿入のタイミングでElastiCacheは<a href="http://aws.typepad.com/aws_japan/2015/05/look-before-you-leap-the-coming-leap-second-and-aws.html">AWS調整時刻</a>で動作します。
残念ながらAWS調整時刻を返すNTPは提供されていないようです。</p>

<p>デフォルトの設定はこの辺を考慮してマージンを取っているので大丈夫なはず・・・。
使う人がいるかはわかりませんが、検証頑張って！</p>

<h2>名前について</h2>

<p>「Yet Another Ranged Unique id Supplier」の略です。
いい名前が思いつかなかったので、fujiwaraさん製のRanged Unique id Supplierが既にあったのでそこから拝借しました。
Yet Anatherは、こう付けると流行ると「言語のしくみ」に書いてあったからです。</p>

<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=shogo82148-22&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=B01N7JZXMD&linkId=8ee3d3dfb649430b1d0abd35881e5f56"></iframe>


<h2>まとめ</h2>

<ul>
<li>RedisをID発番サーバID配布サーバとして活用する方法を考えてみました</li>
<li>可用性を求めていったらレプリケーションの高度な使い方がわかってきた

<ul>
<li><code>redis.replicate_commands</code>でスクリプトのレプリケーション方式を変更する</li>
<li>WAITコマンドでレプリケーションを待つ</li>
</ul>
</li>
<li>フェールオーバのこととか考えると全然楽じゃなかった・・・</li>
</ul>


<p>思いつきを試したかっただけなのですが、勉強になったので良しとしましょう。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rust vs Go の終戦へ向けてPolyglotを作ってみた]]></title>
    <link href="https://shogo82148.github.io/blog/2017/02/25/rust-and-go-ploygolot/"/>
    <updated>2017-02-25T16:58:27+09:00</updated>
    <id>https://shogo82148.github.io/blog/2017/02/25/rust-and-go-ploygolot</id>
    <content type="html"><![CDATA[<p>「Golang Rust」とググると、関連項目は「Rust vs Go」のように
GolangとRustが対立しているような項目ばかりです。
まあまあ、もっと仲良くやろうじゃないですか、ということで、
どうしたら仲良くなれるかを考えました。
Polyglotにして同じソースコードの中に閉じ込めてやれば、
そのうち仲良くなるのではないかと考え、
RustとGoのPloyglotを作ってみました。</p>

<!-- More -->


<h2>結果</h2>

<figure class='code'><figcaption><span>polyglot.rs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cm">/*/*/</span>
</span><span class='line'><span class="n">package</span> <span class="n">main</span>
</span><span class='line'>
</span><span class='line'><span class="n">import</span> <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">fmt</span><span class="p">.</span><span class="n">Print</span><span class="p">(</span><span class="s">&quot;Hello Go!!&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">_</span> <span class="o">=</span> <span class="err">`</span><span class="o">*/*/</span>
</span><span class='line'><span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello Rust!!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="c1">//`</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>polyglot.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="cm">/*/*/</span>
</span><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&quot;Hello Go!!&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">_</span> <span class="p">=</span> <span class="s">`*/*/</span>
</span><span class='line'><span class="s">fn main() {</span>
</span><span class='line'><span class="s">    println!(&quot;Hello Rust!!&quot;);</span>
</span><span class='line'><span class="s">//`</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>仕組み</h2>

<p>一番のポイントは最初の行の <code>/*/*/</code> です。
RustもGoも<code>/* */</code>形式の複数行コメントに対応していますが、
Rustはネストに対応しており、Goはネストはできないという違いがあります。
この違いにより、Rustは<code>/*/*/</code>を<code>/* /* /</code>のように「二重にネストしたコメントの開始部分」として扱いますが、
Goは<code>/* / */</code>のように「<code>/</code>をコメントアウトしたもの」と見なします。
これにより2行目<code>package main</code>以降はGoには普通のコードに見えますが、
Rustからは単なるコメントとして認識されます。</p>

<p>次はGoからRustへの切り替えです。
Goではバッククオートで複数行文字列を定義できるので、その中にRustのコードを書きます。
この中ではバッククオートさえ使わなければ自由にRustのコードを書くことが出来るので、
あとはGoのコードだけ上手くコメントアウトされるよう調整すれば完成です。</p>

<h2>せっかくなのでリンクしてみた</h2>

<p>GoからRustのコードを呼び出すサンプルコードを見つけたので、
せっかくなのでリンクしてみました。</p>

<ul>
<li><a href="https://github.com/medimatrix/rust-plus-golang">medimatrix/rust-plus-golang</a></li>
</ul>


<p><code>main.go</code>と<code>lib.go</code>を以下のように置き換えます。
内容は一緒なので、シンボリックリンクにすると編集が楽でいいかもしれませんね。</p>

<figure class='code'><figcaption><span>main.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="cm">/*golang code starts from here/*/</span>
</span><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">#cgo LDFLAGS: -L./lib -lhello</span>
</span><span class='line'><span class="cm">void hello(char *name);</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;C&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">C</span><span class="p">.</span><span class="nx">hello</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">CString</span><span class="p">(</span><span class="s">&quot;John Smith&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">_</span> <span class="p">=</span> <span class="s">`rustlang code starts from here */*/</span>
</span><span class='line'><span class="s">extern crate libc;</span>
</span><span class='line'><span class="s">use std::ffi::CStr;</span>
</span><span class='line'>
</span><span class='line'><span class="s">#[no_mangle]</span>
</span><span class='line'><span class="s">pub extern &quot;C&quot; fn hello(name: *const libc::c_char) {</span>
</span><span class='line'><span class="s">    let buf_name = unsafe { CStr::from_ptr(name).to_bytes() };</span>
</span><span class='line'><span class="s">    let str_name = String::from_utf8(buf_name.to_vec()).unwrap();</span>
</span><span class='line'><span class="s">    println!(&quot;Hello {}!&quot;, str_name);</span>
</span><span class='line'><span class="s">//`</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>lib.rs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cm">/*golang code starts from here/*/</span>
</span><span class='line'><span class="n">package</span> <span class="n">main</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">#cgo LDFLAGS: -L./lib -lhello</span>
</span><span class='line'><span class="cm">void hello(char *name);</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="n">import</span> <span class="s">&quot;C&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">C</span><span class="p">.</span><span class="n">hello</span><span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">CString</span><span class="p">(</span><span class="s">&quot;John Smith&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">_</span> <span class="o">=</span> <span class="err">`</span><span class="n">rustlang</span> <span class="n">code</span> <span class="n">starts</span> <span class="n">from</span> <span class="n">here</span> <span class="o">*/*/</span>
</span><span class='line'><span class="k">extern</span> <span class="n">crate</span> <span class="n">libc</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">ffi</span><span class="o">::</span><span class="n">CStr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#[no_mangle]</span>
</span><span class='line'><span class="k">pub</span> <span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="k">fn</span> <span class="n">hello</span><span class="p">(</span><span class="n">name</span><span class="o">:</span> <span class="o">*</span><span class="kr">const</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_char</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">buf_name</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="n">CStr</span><span class="o">::</span><span class="n">from_ptr</span><span class="p">(</span><span class="n">name</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">()</span> <span class="p">};</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">str_name</span> <span class="o">=</span> <span class="n">String</span><span class="o">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">buf_name</span><span class="p">.</span><span class="n">to_vec</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>    <span class="nb">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello {}!&quot;</span><span class="p">,</span> <span class="n">str_name</span><span class="p">);</span>
</span><span class='line'><span class="c1">//`</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>呼び出し元と呼び出し先のコードが一度に確認できて便利(？)</p>

<h2>まとめ</h2>

<p>Goの最初に<code>package main</code>を書かなければいけない制限が意外と厳しいため、
Polyglotにする言語には相性があります。
つまりRustとGoは相性バツグンということですね！(？？？)
みなさんもRustとGoを仲良く使っていきましょう！！！！！</p>

<p>(※ジョークなので本気にしないでくださいね、念のため)</p>

<h2>参考</h2>

<ul>
<li><a href="https://doc.rust-lang.org/reference.html#comments">The Rust Reference#comment</a></li>
<li><a href="https://shogo82148.github.io/blog/2016/04/05/polyglot-of-perl-and-golang/">PerlとGolangで実行できるPolyglot書いてみた</a>

<ul>
<li>どうやらGoはPerlとも相性がいいようです</li>
</ul>
</li>
<li><a href="https://github.com/medimatrix/rust-plus-golang">medimatrix/rust-plus-golang</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[WEB+DB PRESS Vol.97にPerlとRedisの記事を寄稿しました]]></title>
    <link href="https://shogo82148.github.io/blog/2017/02/23/perl-webdb-vol97/"/>
    <updated>2017-02-23T18:27:53+09:00</updated>
    <id>https://shogo82148.github.io/blog/2017/02/23/perl-webdb-vol97</id>
    <content type="html"><![CDATA[<p>昨年末に<a href="https://twitter.com/songmu">Songmu</a>さんからお話を頂き、
<a href="http://gihyo.jp/magazine/wdpress/archive/2017/vol97">WEB+DB PRESS Vol.97</a>内の連載「第43回Perl Hackers Hub」に
「PerlでのRedis活用法」というタイトルで寄稿しました。
発売日は<strong>2月24日</strong>です。</p>

<!-- More -->


<h2>内容</h2>

<p>簡単に内容を紹介しておきます。
Perl使いではじめてRedisを使う人向けに書いたつもりです。</p>

<h3>Redisの簡単な説明</h3>

<p>Redisのインストール方と、Perlからの接続方法、そしてRedisの型の説明です。
記事の中でも紹介していますが、Redisはその豊富な型が特長です。
読者はきっとPerl使いだろうということで、Perlの型(Perlにも型はあるんだよ！！)と
比較しながら簡単に紹介しています。</p>

<h3>Redisの応用例とCPANモジュールの紹介</h3>

<p>Redisを使うとこんなことができるよ、という紹介です。
CPANで公開されているRedis関連のモジュールも合わせて紹介しています。</p>

<h3>Redis自体の注意点</h3>

<p>以前Redisを使ったサービスの運用に携わっていたのですが、
そのなかで実際に起きたことを元に、Redisの注意点について書きました。
さいわいサービスが停止するような事故にはありませんでしたが、
メトリックスを眺めながらエンジニア勢でヤバイヤバイ騒いでましたね・・・。
みなさんも気をつけて下さい。</p>

<h2>執筆してみての感想</h2>

<p>昔から文章を書くのにはだいぶ苦手意識があり、
今回の執筆も非常に苦労しました。
一文の前半を書いた時点で
「今から書こうとしている情報は本当に必要なのか」
「自分の記憶違いで間違った情報なのでは」と不安になり、
色々考えているうちに、何書こうとしてたのかわからなくなるんですよね。
まずは適当に書き上げて、後からちゃんと推敲しよう、
とは思いつつもなかなか進められず・・・。
スループットを上げたい。</p>

<p>細かい表現とかも気になってなかなか進まないので、
こういうの入れて頑張ろうと思います！</p>

<ul>
<li><a href="http://qiita.com/azu/items/2c565a38df5ed4c9f4e1">VS Codeでtextlintを使って文章をチェックする</a></li>
<li><a href="http://takemikami.com/2017/02/14/gitbook.html">gitbookで技術書を書く環境の構築手順</a></li>
</ul>


<p>(執筆が進まないと、こういう環境構築に時間をかけてしまうのもよくないと思うんだ・・・)</p>

<h2>余談</h2>

<p>ところで、<strong>Vol.97</strong>と<strong>第43回</strong>ってどっちも<strong>素数</strong>ですね！
雑なプログラムを書いて調べてみたところ、
両方素数になるのはVol.83, 第29回以来、<strong>7回目</strong>(これも<strong>素数</strong>だ！)。
次はVol.101, 第47回です。
そのときのPerl Hackerは誰になるのでしょうか。楽しみですね！</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">sub </span><span class="nf">is_prime</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$n</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="nv">$n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="nv">$i</span><span class="o">*</span><span class="nv">$i</span><span class="o">&lt;=</span><span class="nv">$n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="nv">$n</span> <span class="nv">%</span> <span class="err">$</span><span class="nv">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="k">my</span> <span class="nv">$n</span><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$m</span> <span class="o">=</span> <span class="nv">$n</span><span class="o">-</span><span class="mi">43</span><span class="o">+</span><span class="mi">97</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">is_prime</span><span class="p">(</span><span class="nv">$n</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_prime</span><span class="p">(</span><span class="nv">$m</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">printf</span> <span class="s">&quot;%3d: Vol.%3d, No.%3d\n&quot;</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="nv">$m</span><span class="p">,</span> <span class="nv">$n</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Go言語でコンパイル時フィボナッチ数列計算]]></title>
    <link href="https://shogo82148.github.io/blog/2017/02/19/golang-compile-time-fib/"/>
    <updated>2017-02-19T09:06:05+09:00</updated>
    <id>https://shogo82148.github.io/blog/2017/02/19/golang-compile-time-fib</id>
    <content type="html"><![CDATA[<p><a href="http://postd.cc/fibonacci/">整数の公式でフィボナッチ数列を求める</a>という記事を読んで、
「これコンパイル時ならGoでも簡単に計算できるのでは？」と思いやってみたメモ。</p>

<!-- More -->


<h2>背景</h2>

<p>みんな大好きフィボナッチ数列(要出典)。
漸化式で定義されているため、再帰やループを使って書くことが多いと思いますが、
閉じた式で書くことが知られています。
ただし、この一般式には無理数の演算が入るので、コンピュータで厳密に扱うことはできません。
ところが、さきほど紹介した記事で紹介された方法を使うと、整数の演算のみで実現できるそうです。</p>

<p>原理などはネタ元の記事を参照してもらうとして、
Python3では以下のように書けるらしいです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">n</span><span class="p">))</span> <span class="o">//</span> <span class="p">((</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ある程度大きなフィボナッチ数を求める場合、
計算途中の値が非常に大きくなるため、多倍長整数が必要となります。
Python3は多倍長整数に組み込みで対応していますが、
Goでは<a href="https://golang.org/pkg/math/big/">math/bigパッケージ</a>を利用する必要があります。</p>

<p>なんか面倒だなGolangと思っていたのですが、
<a href="http://qiita.com/sonatard/items/464a9d45c689386edfe1">Better C - Go言語と整数 #golang</a>を読んで、
「Goの定数には型がない(場合がある)」「任意の精度で計算してくれる」ということを知り、
「つまりコンパイル時に定数として計算すれば楽にいけるのでは！！」と考えたわけです。</p>

<h2>結果</h2>

<p>ちょっと複雑な式ですが、個々の演算自体はPython3もGoも変わらないので、
翻訳は簡単ですね。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">const</span> <span class="nx">Fib0</span> <span class="p">=</span> <span class="mi">1</span> <span class="c1">// 0だけはうまくいかない</span>
</span><span class='line'>
</span><span class='line'><span class="kd">const</span> <span class="p">(</span>
</span><span class='line'>  <span class="nx">_</span>    <span class="p">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="kc">iota</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="kc">iota</span><span class="p">)))</span> <span class="o">/</span> <span class="p">((</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="kc">iota</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="kc">iota</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="kc">iota</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">Fib1</span>
</span><span class='line'>  <span class="nx">Fib2</span>
</span><span class='line'>  <span class="nx">Fib3</span>
</span><span class='line'>  <span class="nx">Fib4</span>
</span><span class='line'>  <span class="nx">Fib5</span>
</span><span class='line'>  <span class="nx">Fib6</span>
</span><span class='line'>  <span class="nx">Fib7</span>
</span><span class='line'>  <span class="nx">Fib8</span>
</span><span class='line'>  <span class="nx">Fib9</span>
</span><span class='line'>  <span class="nx">Fib10</span>
</span><span class='line'>  <span class="nx">Fib11</span>
</span><span class='line'>  <span class="nx">Fib12</span>
</span><span class='line'>  <span class="nx">Fib13</span>
</span><span class='line'>  <span class="nx">Fib14</span>
</span><span class='line'>  <span class="nx">Fib15</span>
</span><span class='line'>  <span class="nx">Fib16</span>
</span><span class='line'>  <span class="nx">Fib17</span>
</span><span class='line'>  <span class="nx">Fib18</span>
</span><span class='line'>  <span class="nx">Fib19</span>
</span><span class='line'>  <span class="nx">Fib20</span>
</span><span class='line'>  <span class="nx">Fib21</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">fibs</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">Fib0</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib1</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib2</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib3</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib4</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib5</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib6</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib7</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib8</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib9</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib10</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib11</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib12</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib13</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib14</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib15</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib16</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib17</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib18</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib19</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib20</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Fib21</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">fib</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">fibs</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">fib</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>実行結果です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go run fibconst.go
</span><span class='line'>0 1
</span><span class='line'>1 1
</span><span class='line'>2 2
</span><span class='line'>3 3
</span><span class='line'>4 5
</span><span class='line'>5 8
</span><span class='line'>6 13
</span><span class='line'>7 21
</span><span class='line'>8 34
</span><span class='line'>9 55
</span><span class='line'>10 89
</span><span class='line'>11 144
</span><span class='line'>12 233
</span><span class='line'>13 377
</span><span class='line'>14 610
</span><span class='line'>15 987
</span><span class='line'>16 1597
</span><span class='line'>17 2584
</span><span class='line'>18 4181
</span><span class='line'>19 6765
</span><span class='line'>20 10946
</span><span class='line'>21 17711</span></code></pre></td></tr></table></div></figure>


<p><code>Fibxxx</code>をたくさん書くのはつらかったので、ソースコードはPerlで自動生成しました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">print</span> <span class="s">&lt;&lt;EOF;</span>
</span><span class='line'><span class="s">package main</span>
</span><span class='line'>
</span><span class='line'><span class="s">import &quot;fmt&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">const Fib0 = 1</span>
</span><span class='line'>
</span><span class='line'><span class="s">const (</span>
</span><span class='line'><span class="s">    _    = (4 &lt;&lt; (iota * (3 + iota))) / ((4 &lt;&lt; (2 * iota)) - (2 &lt;&lt; iota) - 1) &amp; ((2 &lt;&lt; iota) - 1)</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;    Fib$_\n&quot;</span> <span class="k">for</span> <span class="mi">1</span><span class="o">..</span><span class="mi">21</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&lt;&lt;EOF;</span>
</span><span class='line'><span class="s">)</span>
</span><span class='line'>
</span><span class='line'><span class="s">func main() {</span>
</span><span class='line'><span class="s">    fibs := []int{</span>
</span><span class='line'><span class="s">        Fib0,</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;        Fib$_,\n&quot;</span> <span class="k">for</span> <span class="mi">1</span><span class="o">..</span><span class="mi">21</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&lt;&lt;EOF</span>
</span><span class='line'><span class="s">    }</span>
</span><span class='line'><span class="s">    for i, fib := range fibs {</span>
</span><span class='line'><span class="s">        fmt.Println(i, fib)</span>
</span><span class='line'><span class="s">    }</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>21までしかないのは、
22以降を求めようとしたらコンパイルが通らなかったためです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go run fibconst.go
</span><span class='line'># command-line-arguments
</span><span class='line'>./fibconst.go:29: shift count too large: 550</span></code></pre></td></tr></table></div></figure>


<p>どうやら512bitまでしか扱えないらしい。
任意精度扱えるって書いてあったのに！！！</p>

<ul>
<li><a href="https://github.com/golang/go/blob/go1.8/src/cmd/compile/internal/gc/mpint.go#L211">mpint.go</a></li>
<li><a href="https://github.com/golang/go/blob/go1.8/src/cmd/compile/internal/gc/mpfloat.go#L18">mpfloat.go</a></li>
</ul>


<p>おとなしく多倍長整数が組込の言語でやれっている話ではありますが、
なんとなくやってみたかったんです。</p>

<h2>参考</h2>

<ul>
<li><a href="http://postd.cc/fibonacci/">整数の公式でフィボナッチ数列を求める</a>

<ul>
<li>Source: <a href="http://paulhankin.github.io/Fibonacci/">An integer formula for Fibonacci numbers</a></li>
</ul>
</li>
<li><a href="http://qiita.com/sonatard/items/464a9d45c689386edfe1">Better C - Go言語と整数 #golang</a></li>
</ul>


<p>ネタ元にある「母関数」という概念は、数学ガールを読んで知りました。</p>

<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=shogo82148-22&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4797341378&linkId=be2c6011ca1a5f15d96c370e494b0f95"></iframe>


<p>フィボナッチ数列に触れている部分はWebでも公開されているので、そちらもどうぞ(<a href="http://www.hyuki.com/story/genfunc.html">ミルカさんとフィボナッチ数列</a>)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Go-sql-proxyがcontextに対応しました]]></title>
    <link href="https://shogo82148.github.io/blog/2017/02/16/go-sql-proxy-in-go18/"/>
    <updated>2017-02-16T07:16:44+09:00</updated>
    <id>https://shogo82148.github.io/blog/2017/02/16/go-sql-proxy-in-go18</id>
    <content type="html"><![CDATA[<p>Go1.8ではdatabase/sqlのcontextサポートが入ります。
(きっと今日の<a href="https://eventdots.jp/event/611405">Go 1.8 Release Party</a>で詳しく説明があるはず、たぶん)
それにともない<a href="https://shogo82148.github.io/blog/2015/05/13/golang-sql-proxy/">Go言語でSQLのトレースをする</a>で紹介した
<a href="https://github.com/shogo82148/go-sql-proxy">shogo82148/go-sql-proxy</a>でもcontextを扱えるようにしました。</p>

<!-- More -->


<h2>Go1.8新機能のサポート</h2>

<p><a href="http://mattn.kaoriya.net/software/lang/go/20161106232834.htm">Golang 1.8 でやってくる database/sql の変更点</a>で
mattnさんが紹介しているように、Go1.8ではdatabase/sqlにいくつか新機能が追加されます。
(mattnさんの対応が早すぎて、メソッド名とか微妙に変更が入っているので注意)</p>

<p>特に大きなのがcontextのサポートでしょう。以下のようなコードでクエリのキャンセルが可能になります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
</span><span class='line'><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1秒待ってからキャンセル</span>
</span><span class='line'>    <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">cancel</span><span class="p">()</span>
</span><span class='line'><span class="p">}()</span>
</span><span class='line'>
</span><span class='line'><span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">QueryContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&quot;SELECT name FROM test where id = ?&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span><span class='line'><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>go-sql-proxyでもcontext対応を行ったので、
proxyを経由した場合でも、キャンセルが可能になります。
(もちろん、originとなるドライバの対応も必要です)</p>

<p>Go1.8ではcontextサポート以外にもいくつか新機能が追加される予定です。
これらについても、originとなるドライバが対応していれば、go-sql-proxy経由でも全く同じように扱えます。</p>

<h2>contextとHookの関連付け</h2>

<p>contextにHookを関連付けて、一部のクエリにだけHookを付けることができるようになりました。
例えば以下のようなコードでctxに関連したクエリだけログを出力できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;context&quot;</span>
</span><span class='line'>  <span class="s">&quot;database/sql&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="s">&quot;github.com/shogo82148/go-sql-proxy&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">tracer</span> <span class="p">=</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">NewTraceHooks</span><span class="p">(</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">TracerOptions</span><span class="p">{})</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 何もしないproxyをインストール</span>
</span><span class='line'>  <span class="nx">proxy</span><span class="p">.</span><span class="nx">RegisterProxy</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 末尾に&quot;:proxy&quot;がついた名前でアクセス</span>
</span><span class='line'>  <span class="nx">db</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;origin:proxy&quot;</span><span class="p">,</span> <span class="s">&quot;data source&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// このコンテキストに関連したクエリだけでログが有効になります</span>
</span><span class='line'>  <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">WithHooks</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span> <span class="nx">tracer</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">db</span><span class="p">.</span><span class="nx">ExecContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&quot;CREATE TABLE t1 (id INTEGER PRIMARY KEY)&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>グローバルなproxyに既にHookが設定してあった場合は上書きされます。
上書きされたHookは実行されないので注意してください。</p>

<p>「トレースの負荷が気になるから、全体の1%だけ出力したい！」とか
「このAPIだけ重たいから、この部分だけトレースしたい！」とか
そういう場合に便利ではないでしょうか。</p>

<h2>トレースオプションの追加</h2>

<p>Tracerに色々オプションをつけたいなと思ったので、<code>proxy.TracerOptions</code>を追加しました。
例えばSlowQueryに時間を設定すると、この時間以上経ったクエリだけ表示されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">var</span> <span class="nx">tracer</span> <span class="p">=</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">NewTraceHooks</span><span class="p">(</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">TracerOptions</span><span class="p">{</span>
</span><span class='line'>  <span class="nx">SlowQuery</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに初期のトレーサーは<code>logger.Output(6, "Begin")</code>みたいな感じで書いてたので、
案の定Go1.8の変更でぶっ壊れました。
頑張ってスタックトレースを辿って、関数名をパースしてパッケージ名を取得(ダイレクトにパッケージ名だけ取る機能は見つからなかった)して、
フィルタリングするようにしたので、もう大丈夫なはず。
その代わりにパフォーマンスが犠牲になったので、
あまり高負荷のところに突っ込まないでくださいね。</p>

<h2>フック関数の変更</h2>

<p>context対応に伴い、Hookの差し込み方も変わっています。
<code>proxy.Hooks</code>は非推奨の扱いで、<code>proxy.HooksContext</code>を使って下さい。
以下の例のようにcontext.Contextが第一引数に追加されています。
デバッグ情報の受け渡しに使えるかも？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;database/sql&quot;</span>
</span><span class='line'>  <span class="s">&quot;database/sql/driver&quot;</span>
</span><span class='line'>  <span class="s">&quot;log&quot;</span>
</span><span class='line'>  <span class="s">&quot;time&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="s">&quot;github.com/mattn/go-sqlite3&quot;</span>
</span><span class='line'>  <span class="s">&quot;github.com/shogo82148/go-sql-proxy&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">sql</span><span class="p">.</span><span class="nx">Register</span><span class="p">(</span><span class="s">&quot;sqlite3-proxy&quot;</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">NewProxyContext</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sqlite3</span><span class="p">.</span><span class="nx">SQLiteDriver</span><span class="p">{},</span> <span class="o">&amp;</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">HooksContext</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">PreExec</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">_</span> <span class="o">*</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">Stmt</span><span class="p">,</span> <span class="nx">_</span> <span class="p">[]</span><span class="nx">driver</span><span class="p">.</span><span class="nx">NamedValue</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// The first return value(time.Now()) is passed to both `Hooks.Exec` and `Hook.ExecPost` callbacks.</span>
</span><span class='line'>          <span class="k">return</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span> <span class="kc">nil</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nx">PostExec</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">ctx</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">stmt</span> <span class="o">*</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">Stmt</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="nx">driver</span><span class="p">.</span><span class="nx">NamedValue</span><span class="p">,</span> <span class="nx">_</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span> <span class="nx">_</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// The `ctx` parameter is the return value supplied from the `Hooks.PreExec` method, and may be nil.</span>
</span><span class='line'>          <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Query: %s; args = %v (%s)\n&quot;</span><span class="p">,</span> <span class="nx">stmt</span><span class="p">.</span><span class="nx">QueryString</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Since</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)))</span>
</span><span class='line'>          <span class="k">return</span> <span class="kc">nil</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>  <span class="p">}))</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;sqlite3-proxy&quot;</span><span class="p">,</span> <span class="s">&quot;:memory:&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Open filed: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span>
</span><span class='line'>      <span class="s">&quot;CREATE TABLE t1 (id INTEGER PRIMARY KEY)&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Go1.8のGraceful Shutdownとgo-gracedownの対応]]></title>
    <link href="https://shogo82148.github.io/blog/2017/01/21/golang-1-dot-8-graceful-shutdown/"/>
    <updated>2017-01-21T12:44:32+09:00</updated>
    <id>https://shogo82148.github.io/blog/2017/01/21/golang-1-dot-8-graceful-shutdown</id>
    <content type="html"><![CDATA[<p>Go1.8beta1が出た時に、Go1.8で追加される予定のGraceful Shutdownについて書く！
とTwitterに書き込んで早1ヶ月。
この前の金曜日に<a href="https://twitter.com/golang/status/822201571928731648">Go1.8rc2がリリースされ</a>、正式リリースも間近になってきて、
さすがに書かねばという気持ちになって来たので、がんばって検証してみます。</p>

<!-- More -->


<h2>公式サポートで増える予定の機能</h2>

<p>以前<a href="https://shogo82148.github.io/blog/2015/11/23/golang-graceful-restart-2nd/">Go言語でGraceful Restartをするときに取りこぼしを少なくする</a>で
紹介したように<a href="https://github.com/shogo82148/go-gracedown">shogo82148/go-gracedown</a>というものを書きました。
あれから時は経ち、ついにGo1.8からは<a href="https://github.com/golang/go/issues/4674">Graceful Shudownがbuild-inの機能として提供</a>される予定です。
公式サポートが入ることによって、以下のような機能を使えるようになります。</p>

<h3>HTTP/2のGraceful Shutdownができる</h3>

<p>HTTP/2ではGOAWAYフレームという接続を切ることを通知する機能があります。
Go1.8からはシャットダウン時にこのGOAWAYフレームを送ってくれるようになります。
GOAWAYフレームはサーバ側から任意のタイミングで送ることができ、
どこまで正常に処理できたかをクライアントに伝えられるという利点があります。</p>

<p>余談ですが、この機能は<a href="https://github.com/golang/go/issues/18471">x/net/http2を利用している場合は動かない</a>らしいです。
<a href="https://github.com/golang/net/blob/8fd7f25955530b92e73e9e1932a41b522b22ccd9/http2/server.go#L2716-L2736">importしたときには動かないけどbundleしたときにだけ動く黒魔術</a>が使われているためです。
覚えておいても今後絶対使うことはなさそう。というか使いたくない・・・。</p>

<h3>contextが使える</h3>

<p>go-gracedownを作った頃は、contextはまだ標準パッケージに取り込まれていなかったので対応していませんでした。
(1.7のリリース時に対応を怠っていただけとも言える)
net/httpのシャットダウンはもちろんcontextに対応しています。
これにより、Graceful Shutdownを中断して強制終了する、
ということが簡単にできるようになります。</p>

<h2>公式サポートで変更になる予定の挙動</h2>

<p>Keep-Aliveでのリクエストの挙動が少し変わります。
1.7以前のgo-gracedownでは、クライアントにKeep-Aliveが無効になったのを伝え、
クライアント側から接続を切るのを待つように実装してしました。
多少接続時間が延びたとしてもクライアント側でよくわからないエラーになるよりはマシだろ、との考えからです。</p>

<p>1.8からはシャットダウン時にIdle状態(TCP接続は有効だけど、リクエストは処理していない状態)な接続は切断されます。
内部で使っている<a href="https://golang.org/pkg/net/http/#Server.SetKeepAlivesEnabled">Server.SetKeepAlivesEnabled</a>の
挙動が<a href="https://github.com/golang/go/issues/9478">変更になった</a>ためです。</p>

<p>Goの中の人的には「この挙動が原因で万が一トラブルになっても、クライアントがリトライしてくれるから大丈夫でしょ」とのことのようです。
サーバシャットダウン以外にもネットワークトラブル等でも接続は切れるので、
クライアント側で頑張ってというのは正論ですが、
どの程度エラーが増えるのかは気になるところです。</p>

<h3>go-gracedownの対応</h3>

<p>go-gracedownはGo1.8でコンパイルされたときはbuild-inの機能を直接使うようになります。
中身はほとんどがインターフェースの互換性を保つためのコードなので、
機能的なメリットは完全になくなってしまいました・・・。
HTTP/2サポートも問題なく動くはずです。
逆にパッケージの依存が増えること以外はデメリットはないともいえます。</p>

<p>Go1.7以下では今までの方法にフォールバックしてくれます。
というわけで、以下のような人には有用です。</p>

<ul>
<li>深淵な理由でGo1.7以下しか使えない人</li>
<li>Go1.8とGo1.7以下のサポートがどうしても必要な人</li>
<li>Go1.8にアップグレードしたけど、graceful shutdownの処理を書き換えるのがめんどくさい人</li>
</ul>


<p>ところで、環境が悪いときに性能を落としたり機能を制限することをフォールバック(fall back)というわけですが、
逆に環境が良いときに性能を上げたり機能を拡張することはなんていうんですかね？
モデムでは通信環境が良いときに高速な通信方式に切り変えることを「フォールフォワード(fall forward)」というらしいです。
「Go1.8ではbild-inのGraceful Shutdownにフォールフォワードする」で使い方あってます？</p>

<h2>使い方</h2>

<h3>Server.Shutdownを使う</h3>

<p><a href="http://qiita.com/advent-calendar/2016/go3">Go(その3) Advent Calendar</a>の
<a href="http://qiita.com/najeira/items/806cacb9bba96ff06ec4">最終日の記事</a>でも扱ってますが改めて。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;context&quot;</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>  <span class="s">&quot;log&quot;</span>
</span><span class='line'>  <span class="s">&quot;net&quot;</span>
</span><span class='line'>  <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>  <span class="s">&quot;os&quot;</span>
</span><span class='line'>  <span class="s">&quot;os/signal&quot;</span>
</span><span class='line'>  <span class="s">&quot;syscall&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="s">&quot;github.com/lestrrat/go-server-starter/listener&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;start pid %d\n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">listeners</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">ListenAll</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">ErrNoListeningTarget</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">ErrNoListeningTarget</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Fallback if not running under Server::Starter</span>
</span><span class='line'>      <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:8080&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Failed to listen to port 8080&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">l</span> <span class="p">=</span> <span class="nx">listeners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 別goroutineでServeしていることに注意！</span>
</span><span class='line'>  <span class="nx">srv</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span><span class="nx">Handler</span><span class="p">:</span> <span class="nx">newHandler</span><span class="p">()}</span>
</span><span class='line'>  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">srv</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// mainの中でシグナルの待受をしていることに注意！</span>
</span><span class='line'>  <span class="nx">signal_chan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">signal</span><span class="p">.</span><span class="nx">Notify</span><span class="p">(</span><span class="nx">signal_chan</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">)</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">s</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">signal_chan</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">s</span> <span class="o">==</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;SIGTERM!!!!\n&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nx">srv</span><span class="p">.</span><span class="nx">Shutdown</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">newHandler</span><span class="p">()</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewServeMux</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">mux</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;from pid %d.\n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">mux</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>go-gracedownからの移行するさいの注意点は以下の通りです。</p>

<ul>
<li><code>Server.Shutdown</code>を使う(<code>Serer.Close</code>もあるけど、そっちはGracefulではない)</li>
<li><code>Server.Serve</code>は<strong>シャットダウンが始まる</strong>とすぐに制御を返す(<strong>シャットダウンが終わる</strong>とではない)</li>
<li><code>Server.Shutdown</code>は<strong>シャットダウンが終わる</strong>と制御を返す(<strong>シャットダウンが始まる</strong>とではない)</li>
</ul>


<h3>go-gracedownを使う</h3>

<p>go-gracedownの使い方も再掲しておきます。
Go1.6から利用方法は一切変更はないですが、
Go1.8でコンパイルすると<code>Server.Shutdown</code>を利用してくれます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>  <span class="s">&quot;log&quot;</span>
</span><span class='line'>  <span class="s">&quot;net&quot;</span>
</span><span class='line'>  <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>  <span class="s">&quot;os&quot;</span>
</span><span class='line'>  <span class="s">&quot;os/signal&quot;</span>
</span><span class='line'>  <span class="s">&quot;syscall&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="s">&quot;github.com/lestrrat/go-server-starter/listener&quot;</span>
</span><span class='line'>  <span class="s">&quot;github.com/shogo82148/go-gracedown&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;start pid %d\n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">signal_chan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">signal</span><span class="p">.</span><span class="nx">Notify</span><span class="p">(</span><span class="nx">signal_chan</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">)</span>
</span><span class='line'>  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">s</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">signal_chan</span>
</span><span class='line'>          <span class="k">if</span> <span class="nx">s</span> <span class="o">==</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;SIGTERM!!!!\n&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nx">gracedown</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}()</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">listeners</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">ListenAll</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">ErrNoListeningTarget</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">ErrNoListeningTarget</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Fallback if not running under Server::Starter</span>
</span><span class='line'>      <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:8080&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Failed to listen to port 8080&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">l</span> <span class="p">=</span> <span class="nx">listeners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">gracedown</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">newHandler</span><span class="p">())</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">newHandler</span><span class="p">()</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewServeMux</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">mux</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;from pid %d.\n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">mux</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>HTTP/2を使う</h3>

<p>せっかくHTTP/2にも対応したことなので、
Server::Starterを使ってHTTP/2サーバのGraceful Restartをする例も書いてみました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;context&quot;</span>
</span><span class='line'>  <span class="s">&quot;crypto/tls&quot;</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>  <span class="s">&quot;log&quot;</span>
</span><span class='line'>  <span class="s">&quot;net&quot;</span>
</span><span class='line'>  <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>  <span class="s">&quot;os&quot;</span>
</span><span class='line'>  <span class="s">&quot;os/signal&quot;</span>
</span><span class='line'>  <span class="s">&quot;syscall&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="s">&quot;github.com/lestrrat/go-server-starter/listener&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// net/http/internal/testcert.go から拝借</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">localhostCert</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`-----BEGIN CERTIFICATE-----</span>
</span><span class='line'><span class="s">MIICEzCCAXygAwIBAgIQMIMChMLGrR+QvmQvpwAU6zANBgkqhkiG9w0BAQsFADAS</span>
</span><span class='line'><span class="s">MRAwDgYDVQQKEwdBY21lIENvMCAXDTcwMDEwMTAwMDAwMFoYDzIwODQwMTI5MTYw</span>
</span><span class='line'><span class="s">MDAwWjASMRAwDgYDVQQKEwdBY21lIENvMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCB</span>
</span><span class='line'><span class="s">iQKBgQDuLnQAI3mDgey3VBzWnB2L39JUU4txjeVE6myuDqkM/uGlfjb9SjY1bIw4</span>
</span><span class='line'><span class="s">iA5sBBZzHi3z0h1YV8QPuxEbi4nW91IJm2gsvvZhIrCHS3l6afab4pZBl2+XsDul</span>
</span><span class='line'><span class="s">rKBxKKtD1rGxlG4LjncdabFn9gvLZad2bSysqz/qTAUStTvqJQIDAQABo2gwZjAO</span>
</span><span class='line'><span class="s">BgNVHQ8BAf8EBAMCAqQwEwYDVR0lBAwwCgYIKwYBBQUHAwEwDwYDVR0TAQH/BAUw</span>
</span><span class='line'><span class="s">AwEB/zAuBgNVHREEJzAlggtleGFtcGxlLmNvbYcEfwAAAYcQAAAAAAAAAAAAAAAA</span>
</span><span class='line'><span class="s">AAAAATANBgkqhkiG9w0BAQsFAAOBgQCEcetwO59EWk7WiJsG4x8SY+UIAA+flUI9</span>
</span><span class='line'><span class="s">tyC4lNhbcF2Idq9greZwbYCqTTTr2XiRNSMLCOjKyI7ukPoPjo16ocHj+P3vZGfs</span>
</span><span class='line'><span class="s">h1fIw3cSS2OolhloGw/XM6RWPWtPAlGykKLciQrBru5NAPvCMsb/I1DAceTiotQM</span>
</span><span class='line'><span class="s">fblo6RBxUQ==</span>
</span><span class='line'><span class="s">-----END CERTIFICATE-----`</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">localhostKey</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`-----BEGIN RSA PRIVATE KEY-----</span>
</span><span class='line'><span class="s">MIICXgIBAAKBgQDuLnQAI3mDgey3VBzWnB2L39JUU4txjeVE6myuDqkM/uGlfjb9</span>
</span><span class='line'><span class="s">SjY1bIw4iA5sBBZzHi3z0h1YV8QPuxEbi4nW91IJm2gsvvZhIrCHS3l6afab4pZB</span>
</span><span class='line'><span class="s">l2+XsDulrKBxKKtD1rGxlG4LjncdabFn9gvLZad2bSysqz/qTAUStTvqJQIDAQAB</span>
</span><span class='line'><span class="s">AoGAGRzwwir7XvBOAy5tM/uV6e+Zf6anZzus1s1Y1ClbjbE6HXbnWWF/wbZGOpet</span>
</span><span class='line'><span class="s">3Zm4vD6MXc7jpTLryzTQIvVdfQbRc6+MUVeLKwZatTXtdZrhu+Jk7hx0nTPy8Jcb</span>
</span><span class='line'><span class="s">uJqFk541aEw+mMogY/xEcfbWd6IOkp+4xqjlFLBEDytgbIECQQDvH/E6nk+hgN4H</span>
</span><span class='line'><span class="s">qzzVtxxr397vWrjrIgPbJpQvBsafG7b0dA4AFjwVbFLmQcj2PprIMmPcQrooz8vp</span>
</span><span class='line'><span class="s">jy4SHEg1AkEA/v13/5M47K9vCxmb8QeD/asydfsgS5TeuNi8DoUBEmiSJwma7FXY</span>
</span><span class='line'><span class="s">fFUtxuvL7XvjwjN5B30pNEbc6Iuyt7y4MQJBAIt21su4b3sjXNueLKH85Q+phy2U</span>
</span><span class='line'><span class="s">fQtuUE9txblTu14q3N7gHRZB4ZMhFYyDy8CKrN2cPg/Fvyt0Xlp/DoCzjA0CQQDU</span>
</span><span class='line'><span class="s">y2ptGsuSmgUtWj3NM9xuwYPm+Z/F84K6+ARYiZ6PYj013sovGKUFfYAqVXVlxtIX</span>
</span><span class='line'><span class="s">qyUBnu3X9ps8ZfjLZO7BAkEAlT4R5Yl6cGhaJQYZHOde3JEMhNRcVFMO8dJDaFeo</span>
</span><span class='line'><span class="s">f9Oeos0UUothgiDktdQHxdNEwLjQf7lJJBzV+5OtwswCWA==</span>
</span><span class='line'><span class="s">-----END RSA PRIVATE KEY-----`</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;start pid %d\n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">listeners</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">ListenAll</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">ErrNoListeningTarget</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">ErrNoListeningTarget</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Fallback if not running under Server::Starter</span>
</span><span class='line'>      <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:8080&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Failed to listen to port 8080&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">l</span> <span class="p">=</span> <span class="nx">listeners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">cert</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tls</span><span class="p">.</span><span class="nx">X509KeyPair</span><span class="p">(</span><span class="nx">localhostCert</span><span class="p">,</span> <span class="nx">localhostKey</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">tlsConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">NextProtos</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;h2&quot;</span><span class="p">},</span>
</span><span class='line'>      <span class="nx">Certificates</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">{</span><span class="nx">cert</span><span class="p">},</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">srv</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">Handler</span><span class="p">:</span>   <span class="nx">newHandler</span><span class="p">(),</span>
</span><span class='line'>      <span class="nx">TLSConfig</span><span class="p">:</span> <span class="nx">tlsConfig</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">l</span> <span class="p">=</span> <span class="nx">tls</span><span class="p">.</span><span class="nx">NewListener</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">tlsConfig</span><span class="p">)</span>
</span><span class='line'>  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">srv</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}()</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">signal_chan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">signal</span><span class="p">.</span><span class="nx">Notify</span><span class="p">(</span><span class="nx">signal_chan</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">)</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">s</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">signal_chan</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">s</span> <span class="o">==</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;SIGTERM!!!!\n&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nx">srv</span><span class="p">.</span><span class="nx">Shutdown</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">newHandler</span><span class="p">()</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewServeMux</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">mux</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;from pid %d.\n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">mux</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>NextProtos</code>へ明示的に<code>h2</code>を指定する必要があるのがポイントです。
net/httpはデフォルトでHTTP/2を有効にしてくれますが、
<code>TLSConfig</code>が指定されているときは自前でやる必要があります。</p>

<h2>実験</h2>

<p>HTTP/2に対応していて証明書の検証もスキップできて・・・という条件で
ベンチマークソフトを探すのが面倒だったので、Goで自作です。
あまり詳しい統計情報は要らないので、負荷をかけるのにリソースを割きたかったというのもあります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;crypto/tls&quot;</span>
</span><span class='line'>  <span class="s">&quot;flag&quot;</span>
</span><span class='line'>  <span class="s">&quot;io&quot;</span>
</span><span class='line'>  <span class="s">&quot;io/ioutil&quot;</span>
</span><span class='line'>  <span class="s">&quot;log&quot;</span>
</span><span class='line'>  <span class="s">&quot;net&quot;</span>
</span><span class='line'>  <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>  <span class="s">&quot;time&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="s">&quot;github.com/kayac/parallel-benchmark/benchmark&quot;</span>
</span><span class='line'>  <span class="s">&quot;golang.org/x/net/http2&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">type</span> <span class="nx">myWorker</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">URL</span>    <span class="kt">string</span>
</span><span class='line'>  <span class="nx">client</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span>
</span><span class='line'>  <span class="nx">buf</span>    <span class="p">[]</span><span class="kt">byte</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">myWorker</span><span class="p">)</span> <span class="nx">Setup</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">tr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">Proxy</span><span class="p">:</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ProxyFromEnvironment</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">DialContext</span><span class="p">:</span> <span class="p">(</span><span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">Dialer</span><span class="p">{</span>
</span><span class='line'>          <span class="nx">Timeout</span><span class="p">:</span>   <span class="mi">30</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">KeepAlive</span><span class="p">:</span> <span class="mi">30</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}).</span><span class="nx">DialContext</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">MaxIdleConns</span><span class="p">:</span>        <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">IdleConnTimeout</span><span class="p">:</span>     <span class="mi">90</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">TLSHandshakeTimeout</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">TLSClientConfig</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span><span class='line'>          <span class="c1">// テストなので証明書の検証はスキップ</span>
</span><span class='line'>          <span class="c1">// プロダクションでは必ず有効にしてください！</span>
</span><span class='line'>          <span class="nx">InsecureSkipVerify</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nx">ExpectContinueTimeout</span><span class="p">:</span> <span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http2</span><span class="p">.</span><span class="nx">ConfigureTransport</span><span class="p">(</span><span class="nx">tr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">w</span><span class="p">.</span><span class="nx">client</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">Transport</span><span class="p">:</span> <span class="nx">tr</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">w</span><span class="p">.</span><span class="nx">buf</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">myWorker</span><span class="p">)</span> <span class="nx">Teardown</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">myWorker</span><span class="p">)</span> <span class="nx">Process</span><span class="p">()</span> <span class="p">(</span><span class="nx">subscore</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;ERROR: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">CopyBuffer</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">Discard</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">buf</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;ERROR: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="o">!=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Invalid Status: %d&quot;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">1</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="p">(</span>
</span><span class='line'>      <span class="nx">conn</span>     <span class="kt">int</span>
</span><span class='line'>      <span class="nx">duration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="nx">flag</span><span class="p">.</span><span class="nx">IntVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">conn</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;connections to keep open&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">flag</span><span class="p">.</span><span class="nx">DurationVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">duration</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="s">&quot;duration of benchmark&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">url</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Args</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="nx">workers</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">benchmark</span><span class="p">.</span><span class="nx">Worker</span><span class="p">,</span> <span class="nx">conn</span><span class="p">)</span>
</span><span class='line'>  <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">workers</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">workers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">myWorker</span><span class="p">{</span><span class="nx">URL</span><span class="p">:</span> <span class="nx">url</span><span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">benchmark</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">workers</span><span class="p">,</span> <span class="nx">duration</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>前回記事同様、Server::Starterを使って1秒毎に再起動を繰り返しながらベンチを回します。
AWSのc4.largeインスタンス上で実行しました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>start_server --port <span class="m">8080</span> --pid-file app.pid -- ./main
</span><span class='line'><span class="nv">$ </span><span class="k">while</span> <span class="nb">true</span><span class="p">;</span> <span class="k">do</span> <span class="nb">kill</span> -HUP <span class="sb">`</span>cat app.pid<span class="sb">`</span><span class="p">;</span> sleep 1<span class="p">;</span> <span class="k">done</span>
</span><span class='line'><span class="nv">$ </span>./bin/bench -c <span class="m">10</span> -d<span class="o">=</span>1m http://localhost:8080/
</span></code></pre></td></tr></table></div></figure>


<h2>結果</h2>

<h3>Server.Shutdownを使った場合</h3>

<p>Server.Shutdownを使った場合の結果です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./bin/bench -c 10 -d=1m http://localhost:8080/
</span><span class='line'>2017/01/22 12:20:51 starting benchmark: concurrency: 10, time: 1m0s, GOMAXPROCS: 2
</span><span class='line'>2017/01/22 12:21:51 done benchmark: score 1174412, elapsed 1m0.002557914s = 19572.698912 / sec</span></code></pre></td></tr></table></div></figure>


<p>先程紹介したKeepAliveの挙動変更の影響で多少はエラーがでるのでは？と予想していたものの、
まったく影響はありませんでした。</p>

<h3>go-gracedownを使った場合</h3>

<p>go-gracedownを使った場合の結果です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./bin/bench -c 10 -d=1m http://localhost:8080/
</span><span class='line'>2017/01/22 12:22:26 starting benchmark: concurrency: 10, time: 1m0s, GOMAXPROCS: 2
</span><span class='line'>2017/01/22 12:23:26 done benchmark: score 1160878, elapsed 1m0.009764419s = 19344.818485 / sec</span></code></pre></td></tr></table></div></figure>


<p>中身は<code>Server.Shutdown</code>なので、当然ながら同じ結果です。</p>

<h3>HTTP/2でアクセスした場合</h3>

<p>HTTP/2でアクセスした場合の結果です。
GoのHTTP/2サポートはHTTPSで通信したときにしか有効にならないので、他のベンチとURLが違うことに注意。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./bin/bench -c 10 -d=1m https://localhost:8080/
</span><span class='line'>2017/01/22 12:30:04 starting benchmark: concurrency: 10, time: 1m0s, GOMAXPROCS: 2
</span><span class='line'>2017/01/22 12:31:04 done benchmark: score 666801, elapsed 1m0.001842465s = 11113.008745 / sec</span></code></pre></td></tr></table></div></figure>


<p>特にエラーもなく、全く問題ありませんでした。</p>

<h2>まとめ</h2>

<ul>
<li>Go1.8からサポートされる予定のHTTPサーバのGraceful Shutdownについて検証しました

<ul>
<li>HTTP/1.1とHTTP/2で検証しましたが、特に問題は見つかりませんでした</li>
</ul>
</li>
<li>go-gracedownはGo1.8でコンパイルされたときはbuild-inの機能を使うようになります

<ul>
<li>機能的にはbuild-inの機能を直接使う場合とまったく変わりありません</li>
</ul>
</li>
</ul>


<p>Go1.8の正式リリース楽しみですね！</p>

<h2>参考</h2>

<ul>
<li><a href="https://shogo82148.github.io/blog/2015/05/03/golang-graceful-restart/">Go言語でGraceful Restartをする</a></li>
<li><a href="https://shogo82148.github.io/blog/2015/11/23/golang-graceful-restart-2nd/">Go言語でGraceful Restartをするときに取りこぼしを少なくする</a></li>
<li><a href="https://github.com/golang/go/issues/4674">net/http: add built-in graceful shutdown support to Server #4674</a></li>
<li><a href="https://github.com/golang/go/issues/9478">net/http: make Server.SetKeepAlivesEnabled(false) drop currently-open connections #9478</a></li>
<li><a href="http://qiita.com/najeira/items/806cacb9bba96ff06ec4">Go 1.8 の HTTP Server Graceful Shutdown を試す</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Re:golang の http.Client を速くする]]></title>
    <link href="https://shogo82148.github.io/blog/2017/01/14/re-golang-dns-cache/"/>
    <updated>2017-01-14T17:02:12+09:00</updated>
    <id>https://shogo82148.github.io/blog/2017/01/14/re-golang-dns-cache</id>
    <content type="html"><![CDATA[<p>先日<a href="https://twitter.com/mattn_jp">mattn</a>さんの記事を読みました。</p>

<ul>
<li><a href="http://mattn.kaoriya.net/software/lang/go/20170112181052.htm">golang の http.Client を速くする</a></li>
</ul>


<p><a href="https://github.com/abursavich/nett">nett</a>というパッケージを使って
名前解決の結果をキャッシュすることで、<code>http.Client</code>を早くするというものです。
この記事に関して、ちょっと疑問に思ったことがあったので、検証してみました。</p>

<!-- More -->


<h2>疑問</h2>

<p>疑問に思ったのは以下の点です。</p>

<h3>名前解決遅すぎでは？</h3>

<p>ベンチマークの結果を見ると5億ns(=500ms)ほど速度が改善しています。
3つのURLに対してリクエストを投げているので、初回を除く2回DNSのキャッシュがヒットし、
名前解決2回分の速度改善になるはずです。
と、いうことは、名前解決1回あたり250msかかっている計算になります。
googleのsearchは302でリダイレクトがかかるので、<code>Client.Get</code>の呼び出し1回あたり2回リクエストが飛ぶ、
ということを計算に入れても100msほどかかる計算です。</p>

<p>Google先生の謎テクノロジーによってかなりの最適化がされているはずですし、
ネットワークプロバイダのDNSキャッシュにヒットする可能性も高いでしょう。
<strong>名前解決程度にこんなに時間がかかっていたらスプラトゥーンが出来ない！</strong>
(mattnさんがスプラトゥーンをプレイしているかは知らない)</p>

<p><strong>2017/01/16追記:</strong>
mattnさんはスプラトゥーンをプレイしていないそうです。残念。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr"><a href="https://twitter.com/shogo82148">@shogo82148</a> あとスプラトゥーンしてません。。。</p>&mdash; おののいも夫 (@mattn_jp) <a href="https://twitter.com/mattn_jp/status/820236711149981696">January 14, 2017</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>もちろん、ネットワークが混雑していたり、
モバイルネットワークを利用していたり、という可能性もありますが、
ちょっと不自然な印象を受けました。</p>

<h3>Keep-Aliveされてるのでは？</h3>

<p>スキーマがhttpsになっているので、Google先生相手ならHTTP2で通信していてもおかしくありません。
HTTP2は基本的にドメイン毎にコネクションを1つだけ張って、それを使いまわします。
もし仮にHTTP1.1で通信していたとしても、<code>http.Client</code>はデフォルトでKeep-Aliveが有効になっているので、
普通に使うとコネクションを再利用してくれます。</p>

<p>そういうわけで、名前解決以前にそもそもTCPのコネクション確立もスキップされている可能性が高いのでは？
と思ったわけです。
この予想が正しければ、名前解決は初回リクエストでしか行われないので、ベンチマークに差はでないはずです。</p>

<h2>HTTPリクエストの様子をトレースしてみる</h2>

<p>これらの疑問を解消するために、HTTPリクエストの様子をさらに詳細に解析してみることにしました。</p>

<h3>DNSキャッシュなし版をトレースする</h3>

<p>Go1.7から<a href="https://golang.org/pkg/net/http/httptrace/">net/http/httptrace</a>というパッケージが追加され、
名前解決やコネクション確立etcのタイミングにフックを仕込めるようになりました。
これを利用すれば各段階でどの程度時間がかかっているかが具体的に分かるはずです。</p>

<p>頑張って自前でフックを差し込んでもよいのですが、
<a href="https://twitter.com/deeeet">deeeet</a>さんの<a href="https://github.com/tcnksm/go-httpstat">go-httpstat</a>という便利パッケージがあるので、
これをありがたく利用させていただきます。
go-httpstatを使うと時間計測を行うコードを簡単に差し込むことができます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;io&quot;</span>
</span><span class='line'>  <span class="s">&quot;io/ioutil&quot;</span>
</span><span class='line'>  <span class="s">&quot;log&quot;</span>
</span><span class='line'>  <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>  <span class="s">&quot;time&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="s">&quot;github.com/tcnksm/go-httpstat&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="p">(</span>
</span><span class='line'>  <span class="nx">urls</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;https://shogo82148.github.io/blog/2016/12/20/redis-fast-0-dot-19-released/&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;https://shogo82148.github.io/blog/2016/12/15/leap-second-in-datetime-dot-pm/&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;https://shogo82148.github.io/blog/2016/11/23/qr-code/&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">Transport</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">{</span>
</span><span class='line'>          <span class="nx">Proxy</span><span class="p">:</span>             <span class="nx">http</span><span class="p">.</span><span class="nx">ProxyFromEnvironment</span><span class="p">,</span>
</span><span class='line'>          <span class="c1">// DisableKeepAlives: true,</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">urls</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;GET %s&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">req</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewRequest</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">result</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">httpstat</span><span class="p">.</span><span class="nx">Result</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">httpstat</span><span class="p">.</span><span class="nx">WithHTTPStat</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Context</span><span class="p">(),</span> <span class="nx">result</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">req</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">WithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Do</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">io</span><span class="p">.</span><span class="nx">Copy</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">Discard</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">result</span><span class="p">.</span><span class="nx">End</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">())</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%+v\n&quot;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>元記事はGoogleを叩いていましたが、あのURLだとリダイレクトが発生して考えることが増えそうなので、
このブログのURLに変更してあります。
あと静的ページなら相手に余計な負荷をかけることも無いですしね。</p>

<p>さっそく実行してみましょう。
<strong>Keep-Aliveを有効</strong>にした場合の結果です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2017/01/14 16:14:10 GET https://shogo82148.github.io/blog/2016/12/20/redis-fast-0-dot-19-released/
</span><span class='line'>2017/01/14 16:14:10 DNS lookup:          30 ms
</span><span class='line'>TCP connection:      16 ms
</span><span class='line'>TLS handshake:      130 ms
</span><span class='line'>Server processing:   17 ms
</span><span class='line'>Content transfer:     1 ms
</span><span class='line'>Name Lookup:      30 ms
</span><span class='line'>Connect:          47 ms
</span><span class='line'>Pre Transfer:    177 ms
</span><span class='line'>Start Transfer:  195 ms
</span><span class='line'>Total:           197 ms
</span><span class='line'>2017/01/14 16:14:10 GET https://shogo82148.github.io/blog/2016/12/15/leap-second-in-datetime-dot-pm/
</span><span class='line'>2017/01/14 16:14:10 DNS lookup:           0 ms
</span><span class='line'>TCP connection:       0 ms
</span><span class='line'>TLS handshake:        0 ms
</span><span class='line'>Server processing:   17 ms
</span><span class='line'>Content transfer:     2 ms
</span><span class='line'>Name Lookup:       0 ms
</span><span class='line'>Connect:           0 ms
</span><span class='line'>Pre Transfer:      0 ms
</span><span class='line'>Start Transfer:   17 ms
</span><span class='line'>Total:            19 ms
</span><span class='line'>2017/01/14 16:14:10 GET https://shogo82148.github.io/blog/2016/11/23/qr-code/
</span><span class='line'>2017/01/14 16:14:10 DNS lookup:           0 ms
</span><span class='line'>TCP connection:       0 ms
</span><span class='line'>TLS handshake:        0 ms
</span><span class='line'>Server processing:   17 ms
</span><span class='line'>Content transfer:     4 ms
</span><span class='line'>Name Lookup:       0 ms
</span><span class='line'>Connect:           0 ms
</span><span class='line'>Pre Transfer:      0 ms
</span><span class='line'>Start Transfer:   17 ms
</span><span class='line'>Total:            22 ms</span></code></pre></td></tr></table></div></figure>


<p>二回目以降のDNS lookupやTCP connectionが0msになっています。
予想通りコネクションが再利用され、名前解決やコネクション確立がスキップされているようです。</p>

<p>次に<strong>Keep-Aliveを無効</strong>にした状態で実行してみます。
コード中の<code>DisableKeepAlives</code>のコメントを外すと都度接続になります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2017/01/14 16:14:33 GET https://shogo82148.github.io/blog/2016/12/20/redis-fast-0-dot-19-released/
</span><span class='line'>2017/01/14 16:14:33 DNS lookup:          21 ms
</span><span class='line'>TCP connection:      18 ms
</span><span class='line'>TLS handshake:      131 ms
</span><span class='line'>Server processing:   15 ms
</span><span class='line'>Content transfer:     1 ms
</span><span class='line'>Name Lookup:      21 ms
</span><span class='line'>Connect:          40 ms
</span><span class='line'>Pre Transfer:    171 ms
</span><span class='line'>Start Transfer:  187 ms
</span><span class='line'>Total:           188 ms
</span><span class='line'>2017/01/14 16:14:33 GET https://shogo82148.github.io/blog/2016/12/15/leap-second-in-datetime-dot-pm/
</span><span class='line'>2017/01/14 16:14:33 DNS lookup:           1 ms
</span><span class='line'>TCP connection:      15 ms
</span><span class='line'>TLS handshake:       33 ms
</span><span class='line'>Server processing:   14 ms
</span><span class='line'>Content transfer:     1 ms
</span><span class='line'>Name Lookup:       1 ms
</span><span class='line'>Connect:          16 ms
</span><span class='line'>Pre Transfer:     49 ms
</span><span class='line'>Start Transfer:   64 ms
</span><span class='line'>Total:            65 ms
</span><span class='line'>2017/01/14 16:14:33 GET https://shogo82148.github.io/blog/2016/11/23/qr-code/
</span><span class='line'>2017/01/14 16:14:33 DNS lookup:           0 ms
</span><span class='line'>TCP connection:      17 ms
</span><span class='line'>TLS handshake:       35 ms
</span><span class='line'>Server processing:   19 ms
</span><span class='line'>Content transfer:     3 ms
</span><span class='line'>Name Lookup:       0 ms
</span><span class='line'>Connect:          18 ms
</span><span class='line'>Pre Transfer:     54 ms
</span><span class='line'>Start Transfer:   73 ms
</span><span class='line'>Total:            76 ms</span></code></pre></td></tr></table></div></figure>


<p>リクエスト毎に名前解決が行われるようになりました。
ですが、初回に比べて異様に速いですね。
OS側でキャッシュされてるんでしょうか。</p>

<p><code>GODEBUG=netdns=go</code>と環境変数を設定すると、Pure Golangで名前解決が行われるらしいので、
その場合の結果も貼っておきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2017/01/14 16:15:03 GET https://shogo82148.github.io/blog/2016/12/20/redis-fast-0-dot-19-released/
</span><span class='line'>2017/01/14 16:15:03 DNS lookup:          33 ms
</span><span class='line'>TCP connection:      15 ms
</span><span class='line'>TLS handshake:      133 ms
</span><span class='line'>Server processing:   16 ms
</span><span class='line'>Content transfer:     0 ms
</span><span class='line'>Name Lookup:      33 ms
</span><span class='line'>Connect:          48 ms
</span><span class='line'>Pre Transfer:    181 ms
</span><span class='line'>Start Transfer:  197 ms
</span><span class='line'>Total:           198 ms
</span><span class='line'>2017/01/14 16:15:03 GET https://shogo82148.github.io/blog/2016/12/15/leap-second-in-datetime-dot-pm/
</span><span class='line'>2017/01/14 16:15:03 DNS lookup:          17 ms
</span><span class='line'>TCP connection:      14 ms
</span><span class='line'>TLS handshake:       32 ms
</span><span class='line'>Server processing:   19 ms
</span><span class='line'>Content transfer:     0 ms
</span><span class='line'>Name Lookup:      17 ms
</span><span class='line'>Connect:          31 ms
</span><span class='line'>Pre Transfer:     63 ms
</span><span class='line'>Start Transfer:   82 ms
</span><span class='line'>Total:            83 ms
</span><span class='line'>2017/01/14 16:15:03 GET https://shogo82148.github.io/blog/2016/11/23/qr-code/
</span><span class='line'>2017/01/14 16:15:03 DNS lookup:          18 ms
</span><span class='line'>TCP connection:      15 ms
</span><span class='line'>TLS handshake:       36 ms
</span><span class='line'>Server processing:   18 ms
</span><span class='line'>Content transfer:     2 ms
</span><span class='line'>Name Lookup:      18 ms
</span><span class='line'>Connect:          34 ms
</span><span class='line'>Pre Transfer:     70 ms
</span><span class='line'>Start Transfer:   89 ms
</span><span class='line'>Total:            91 ms</span></code></pre></td></tr></table></div></figure>


<h3>DNSキャッシュあり版をトレースする</h3>

<p>DNSキャッシュありも同様にトレースしようと思ったのですが、
残念ながら<a href="https://github.com/abursavich/nett">nett</a>は<code>context.Context</code>を引数に持つインターフェースをサポートしていません。
httptraceを利用するにはcontextが必要なので、同じ方法は使えません。</p>

<p>仕方がないので、頑張ってResolverを自作して、
時間計測するコードを埋め込んでいきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;io&quot;</span>
</span><span class='line'>  <span class="s">&quot;io/ioutil&quot;</span>
</span><span class='line'>  <span class="s">&quot;log&quot;</span>
</span><span class='line'>  <span class="s">&quot;net&quot;</span>
</span><span class='line'>  <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>  <span class="s">&quot;time&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="s">&quot;github.com/abursavich/nett&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="p">(</span>
</span><span class='line'>  <span class="nx">urls</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;https://shogo82148.github.io/blog/2016/12/20/redis-fast-0-dot-19-released/&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;https://shogo82148.github.io/blog/2016/12/15/leap-second-in-datetime-dot-pm/&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;https://shogo82148.github.io/blog/2016/11/23/qr-code/&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">type</span> <span class="nx">MyResolver</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">Resolver</span> <span class="nx">nett</span><span class="p">.</span><span class="nx">Resolver</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">MyResolver</span><span class="p">)</span> <span class="nx">Resolve</span><span class="p">(</span><span class="nx">host</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="nx">net</span><span class="p">.</span><span class="nx">IP</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">ips</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Resolver</span><span class="p">.</span><span class="nx">Resolve</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Name Lookup: %s&quot;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Sub</span><span class="p">(</span><span class="nx">start</span><span class="p">))</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">ips</span><span class="p">,</span> <span class="nx">err</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">dialer</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">nett</span><span class="p">.</span><span class="nx">Dialer</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">Resolver</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">MyResolver</span><span class="p">{</span>
</span><span class='line'>          <span class="o">&amp;</span><span class="nx">nett</span><span class="p">.</span><span class="nx">CacheResolver</span><span class="p">{</span><span class="nx">TTL</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">},</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nx">IPFilter</span><span class="p">:</span> <span class="nx">nett</span><span class="p">.</span><span class="nx">DualStack</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Timeout</span><span class="p">:</span>  <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">Transport</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">{</span>
</span><span class='line'>          <span class="nx">Dial</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">network</span><span class="p">,</span> <span class="nx">address</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
</span><span class='line'>              <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dialer</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="nx">network</span><span class="p">,</span> <span class="nx">address</span><span class="p">)</span>
</span><span class='line'>              <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Connect: %s&quot;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Sub</span><span class="p">(</span><span class="nx">start</span><span class="p">))</span>
</span><span class='line'>              <span class="k">return</span> <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="nx">Proxy</span><span class="p">:</span>             <span class="nx">http</span><span class="p">.</span><span class="nx">ProxyFromEnvironment</span><span class="p">,</span>
</span><span class='line'>          <span class="c1">// DisableKeepAlives: true,</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">urls</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;GET %s&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">io</span><span class="p">.</span><span class="nx">Copy</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">Discard</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>こちらのコードも実行してみます。
<strong>Keep-Aliveを有効</strong>にした場合の結果です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2017/01/14 16:29:19 GET https://shogo82148.github.io/blog/2016/12/20/redis-fast-0-dot-19-released/
</span><span class='line'>2017/01/14 16:29:19 Name Lookup: 22.239218ms
</span><span class='line'>2017/01/14 16:29:19 Connect: 39.364428ms
</span><span class='line'>2017/01/14 16:29:19 GET https://shogo82148.github.io/blog/2016/12/15/leap-second-in-datetime-dot-pm/
</span><span class='line'>2017/01/14 16:29:19 GET https://shogo82148.github.io/blog/2016/11/23/qr-code/</span></code></pre></td></tr></table></div></figure>


<p>こちらも予想通り名前解決とコネクション確立が初回しか行われないので、
最初の一回だけ時間計測のログが出力されています。</p>

<p>次に、<strong>Keep-Aliveを無効</strong>にした場合の結果です。
DNSキャッシュなし版と同様に<code>DisableKeepAlives</code>のコメントを外すと無効にできます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2017/01/14 16:29:41 GET https://shogo82148.github.io/blog/2016/12/20/redis-fast-0-dot-19-released/
</span><span class='line'>2017/01/14 16:29:41 Name Lookup: 27.337342ms
</span><span class='line'>2017/01/14 16:29:41 Connect: 44.552754ms
</span><span class='line'>2017/01/14 16:29:41 GET https://shogo82148.github.io/blog/2016/12/15/leap-second-in-datetime-dot-pm/
</span><span class='line'>2017/01/14 16:29:41 Name Lookup: 1.991µs
</span><span class='line'>2017/01/14 16:29:41 Connect: 14.964222ms
</span><span class='line'>2017/01/14 16:29:41 GET https://shogo82148.github.io/blog/2016/11/23/qr-code/
</span><span class='line'>2017/01/14 16:29:41 Name Lookup: 2.024µs
</span><span class='line'>2017/01/14 16:29:41 Connect: 22.782755ms</span></code></pre></td></tr></table></div></figure>


<p>二回目以降の名前解決が一瞬で終わっており、キャッシュされている様子が確認できますね。</p>

<p>最後に名前解決にPure Golangを使った結果です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2017/01/14 16:30:04 GET https://shogo82148.github.io/blog/2016/12/20/redis-fast-0-dot-19-released/
</span><span class='line'>2017/01/14 16:30:04 Name Lookup: 18.279786ms
</span><span class='line'>2017/01/14 16:30:04 Connect: 35.113831ms
</span><span class='line'>2017/01/14 16:30:04 GET https://shogo82148.github.io/blog/2016/12/15/leap-second-in-datetime-dot-pm/
</span><span class='line'>2017/01/14 16:30:04 Name Lookup: 1.628µs
</span><span class='line'>2017/01/14 16:30:04 Connect: 16.364037ms
</span><span class='line'>2017/01/14 16:30:04 GET https://shogo82148.github.io/blog/2016/11/23/qr-code/
</span><span class='line'>2017/01/14 16:30:04 Name Lookup: 1.77µs
</span><span class='line'>2017/01/14 16:30:04 Connect: 16.048895ms</span></code></pre></td></tr></table></div></figure>


<h2>異様な高速化の理由</h2>

<p>さて、ここまでの結果で、たしかにDNSキャッシュの効果があることは確認できました。
しかし、デフォルトの状態ではKeep-Aliveが有効になっているため、
事前の予想の通り<strong>名前解決が行われるのは初回のみ</strong>ということがわかりました。
mattnさんのベンチマークにはKeep-Alive無効化処理は入っていないので、
DNSキャッシュの有無で差はでないはずです。</p>

<p>思うに、<code>for i := 0; i &lt; b.N; i++ {}</code>がないのが原因なのではないかと・・・。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;testing&quot;</span>
</span><span class='line'>  <span class="s">&quot;time&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">BenchmarkHoge1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1100</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">BenchmarkHoge2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">997</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">BenchmarkFuga1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1100</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">BenchmarkFuga2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">997</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>僕の手元では以下のような結果になりました。
(タイミングの問題なので、再現させるには数値の微調整が必要かも)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>BenchmarkHoge1-4            1    1104960703 ns/op
</span><span class='line'>BenchmarkHoge2-4             2     500677841 ns/op
</span><span class='line'>BenchmarkFuga1-4             1    1103413336 ns/op
</span><span class='line'>BenchmarkFuga2-4             1    1001147782 ns/op
</span><span class='line'>PASS</span></code></pre></td></tr></table></div></figure>


<h2>nettの問題点</h2>

<p><a href="https://github.com/abursavich/nett">nett</a>の効果も確認できたし、
ベンチマークが異様に良い理由もわかったので、
ここで検証終了・・・といきたいところですが、
nettはあまりおすすめできないというのが僕の意見です。</p>

<h3>古い</h3>

<p>最終コミットが2年前と古いです。
まだGo1.7が出てないころなので、当然<code>context.Context</code>にも対応していないわけです。
そのため名前解決のタイムアウトやキャンセルを制御できません。
また、この検証でもhttptraceが使えなくて悲しい思いをしたので、
contextをサポートして欲しい・・・。</p>

<h3>DNSレコードのTTLを無視している</h3>

<p><code>nett.CacheResolver</code>のTTLには固定の時間しか設定できないようです。
DNSレコード自体にTTLが設定されているはずなので、本来であればそれを尊重するべきです。
短い時間のキャッシュであれば問題ないかもしれないですが、
アクセスした相手をDNS浸透問題(浸透いうな！)で悩ませてしまう可能性があるので、
できれば相手の意向を尊重したいところです。</p>

<h3>キャッシュクリアが無い</h3>

<p><code>nett.CacheResolver</code>のTTLの実装は
「前回の名前解決からの経過時間を見て再取得」という単純なものです。
ようするにガーベージコレクションがない状態です。
TTLが過ぎてもキャッシュから本当に消えるわけではないので、
多くのドメインを相手にする場合、メモリを食い尽くす可能性があります。</p>

<h3>2017/01/16追記: 同一ホストの名前解決の排他制御が甘い</h3>

<p>fujiwaraさんからの返信を受けて、ちょっと考えたことがあったので追記。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">この前Goのhttp clientで名前解決結果をキャッシュしたかったの、ベンチマークしててシナリオ的に新規接続が多かったのとローカルに立てたdnsmasqの負荷が気になるほど名前引いてからなので、キャッシュするにしても数秒で実用的には充分だった(TTLの心配するほどではない</p>&mdash; fujiwara (@fujiwara) <a href="https://twitter.com/fujiwara/status/820232828231163904">January 14, 2017</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>




<blockquote class="twitter-tweet"><p lang="ja" dir="ltr"><a href="https://twitter.com/shogo82148">@shogo82148</a> アプリのcacheは(dnsが1段目として)2段目のcacheになるから、dnsに負荷掛けないためにするだけなら数秒で問題ないはずなので、そこまで短くするならちゃんとやる意味がなくて、TTLは専門家(dns)に任せるべきかなあと</p>&mdash; fujiwara (@fujiwara) <a href="https://twitter.com/fujiwara/status/820255789944143876">January 14, 2017</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>名前解決をキャッシュしたい理由は「用途はベンチマーク」「キャッシュは数秒で充分」とのことです。</p>

<p>ちょっとここからは推測になりますが・・・
リソースを徐々に消費してしばらくして突然死というパターンもあるので、
ベンチマークは短くとも1分以上続けるのが普通だと思います(Mackerel等の監視間隔も最小1分ですしね)。
にも関わらず、名前解決の負荷が数秒で落ち着くということは、Keep-Aliveは有効になっていたと推測できます。
それでも名前解決の負荷が問題になるということは、それなりに高い並列度だったのではないかと。</p>

<p>ここで問題になってくるのが、<strong>nettは同一ホストの問い合わせを排他制御していない</strong>という点です。
複数クライアントが同時にキャッシュの有無を確認→ほぼ同時にDNSに問い合わせ→キャッシュ更新(ここだけは排他制御される)
というケースが考えられます。
通常用途ならさほど問題にならないかなーと思ったのですが、
ベンチマークのように極端に並列度が高い場合、TTLが切れた瞬間だけDNSの負荷があがることになります。</p>

<p>ここは、<a href="https://twitter.com/methane">methane</a>さんがGo Conference 2016 Springで発表されていた
<a href="https://docs.google.com/presentation/d/1pSywpKera0huKCHDVGPVA2jQMvy-Pk8IR9s7AAVojDM/edit#slide=id.p">zero time cache pattern</a>
を使うのが賢い気がします。
(同じくmethaneさんの<a href="http://dsas.blog.klab.org/archives/cat_50043510.html">ISUCON6の予選参戦記事</a>も参照)</p>

<p>・・・と書きましたが、あくまでも推測です。
本来はnettを導入する前後でベンチマークを取って検証するべきなのですが、
さすがにこれをpublicなネットワークでやるとDOS攻撃になってしまいます。
DNSよくわからない・・・検証環境構築つらい・・・ので、とりあえずメモとして残しておきます。
だれか詳しい人の検証求む。</p>

<p>(以上、追記終わり)</p>

<h2>解決策は？</h2>

<p>mattnさんの記事には「Go 1.8 からは Resolver提供されるので、自前で簡単に名前引きのキャッシュを実装出来る」とありますが、
<strong>1.8にはユーザがResolverの動作をカスタマイズする機能はありません</strong>。
<a href="https://github.com/golang/go/blob/ecc4474341504f5893c8333dbb68c520dbe93ca5/src/net/lookup.go#L100">TODO: optional interface impl override hook</a>
な状態です。
マイルストーンをみる限り<a href="https://github.com/golang/go/issues/12503">1.9で入るらしい</a>(？)ので、それを待ちましょう・・・。</p>

<p>また、現時点では、netパッケージにDNSレコードのTTLを取得する機能はありません。
つまり先に挙げたnettの欠点をすべて補うには、<strong>「Pure GolangなDNSクライアントの独自実装」</strong>が必要となります。
<a href="https://github.com/golang/go/issues/16218">golang.org/x/net/dnsが入る予定</a>はあるようですが、
実装は未だ存在せず、入るバージョンも決まっていないようです。</p>

<p>つらい。どう考えても「楽な方法」ではない・・・。</p>

<p>Consulにも使われているという<a href="https://github.com/miekg/dns">miekg/dns</a>は見つけたので、誰か強い人よろしくお願いします。
(ちなみにgolang.org/x/net/dnsの候補として一度は挙がったものの、別実装で行くらしい)</p>

<h2>まとめ</h2>

<ul>
<li><a href="https://github.com/abursavich/nett">nett</a>は名前解決キャッシュに効果あり

<ul>
<li>しかしコードが古いので、Go1.7が出ている現状ではおすすめできない</li>
</ul>
</li>
<li>ResolverのカスタマイズはGo1.9かららしい(Go1.8ではまだ入らない)</li>
<li>暫定的な解決策は

<ul>
<li><a href="https://github.com/abursavich/nett">nett</a>を突っついてGo1.7対応をしてもらう(ただし、DNS浸透問題(浸透いうな！)解決にはDNSクライアントの実装が必要)</li>
<li><a href="https://github.com/miekg/dns">miekg/dns</a>を使ってDNSクライアントを頑張って独自実装(つらい)</li>
</ul>
</li>
<li>ベンチの際には<code>for i := 0; i &lt; b.N; i++ {}</code>をわすれずに</li>
</ul>


<p>http.Clientで名前解決結果cacheする楽な方法、現在も絶賛募集中です。</p>

<h2>おまけ</h2>

<p>この記事書くのにnetパッケージの中を探っていたら、
ソースコードの中に<a href="https://github.com/golang/go/blob/ecc4474341504f5893c8333dbb68c520dbe93ca5/src/net/lookup.go#L39">Gopher君を見つけた</a>。</p>

<p>ʕ◔ϖ◔ʔʕ◔ϖ◔ʔʕ◔ϖ◔ʔ</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Redis::Fast 0.19リリースのお知らせ]]></title>
    <link href="https://shogo82148.github.io/blog/2016/12/20/redis-fast-0-dot-19-released/"/>
    <updated>2016-12-20T22:38:27+09:00</updated>
    <id>https://shogo82148.github.io/blog/2016/12/20/redis-fast-0-dot-19-released</id>
    <content type="html"><![CDATA[<p><a href="https://metacpan.org/pod/Redis::Fast">Redis::Fast 0.19</a> をリリースしました。
主な変更点は以下の通りです。</p>

<ul>
<li><code>reconnect_on_error</code> オプションの追加</li>
<li>Sentinelのノード一覧が更新されない不具合の修正</li>
<li>IPv6の実験的サポート</li>
</ul>


<!-- More -->


<h2><code>reconnect_on_error</code> オプションの追加</h2>

<p><a href="https://github.com/yoheimuta">@yoheimuta</a>さんからのプルリクエストです。
今まではネットワークエラーが発生した時のみ再接続処理が走っていましたが、
Redisがエラーを返した場合にも再接続を行うようになります。
マスタースレーブ構成をしているときに、
何らかの原因によりRedis::Fastからのコネクションを維持したまま、
マスターがスレーブに降格してしまった場合に対処するための機能です。
以下のように設定することで、新しいマスターに再接続を行うことが可能になります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">my</span> <span class="nv">$r</span> <span class="o">=</span> <span class="nn">Redis::</span><span class="n">Fast</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
</span><span class='line'>    <span class="n">reconnect</span>          <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># 0以上で再接続有効</span>
</span><span class='line'>    <span class="n">reconnect_on_error</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
</span><span class='line'>        <span class="k">my</span> <span class="p">(</span><span class="nv">$error</span><span class="p">,</span> <span class="nv">$ret</span><span class="p">,</span> <span class="nv">$command</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$error</span> <span class="o">=~</span><span class="sr"> /READONLY You can&#39;t write against a read only slave/</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="c1"># 再接続を行う。次の再接続まで最低1秒空ける</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1"># 再接続は行わない</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Sentinelのノード一覧が更新されない不具合の修正</h2>

<p>Redis::FastにはどれかひとつのSentinelノードに接続すると、
他のノードの情報を自動的に収集する機能があります。
この機能が最新のRedisでは動いていなかったので修正しました。
具体的にいつからなのかまでは追ってないのですが、
Redisのバージョン3.0.6から3.2.6の間のどこかで
ノード一覧の形式が変わってしまったようです。</p>

<p>(最近Sentinelの話題を聞かないけど、みんな使ってるのかな・・・)</p>

<h2>IPv6の実験的サポート</h2>

<p>サーバの指定にIPv6のアドレスが使えるようになりました。
<code>Redis::Fast-&gt;new(server =&gt; "[::1]:6379")</code> のような指定ができます。</p>

<p>バックエンドのhiredis自体は以前からIPv6に対応していたのですが、
今までRedis::Fastでは正しく動きませんでした。</p>

<p>とりあえずlocalhostに接続できることは確認しましたが、
手元にIPv6のネットワークがなくて検証もできていないため、
実験的サポートという扱いで・・・。
 誰かIPv6に詳しい方、検証お願いします。</p>

<h2>感想</h2>

<ul>
<li>テストがなかなか通らず辛かった</li>
<li>CPAN Autherを変な幾何学模様から変えたい</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[DateTime.pmにうるう秒の修正が入った話]]></title>
    <link href="https://shogo82148.github.io/blog/2016/12/15/leap-second-in-datetime-dot-pm/"/>
    <updated>2016-12-15T22:17:47+09:00</updated>
    <id>https://shogo82148.github.io/blog/2016/12/15/leap-second-in-datetime-dot-pm</id>
    <content type="html"><![CDATA[<p>こんにちは、<a href="https://metacpan.org/pod/DateTime">DateTime.pm</a> Watcherのいっちーです。
本日面白いパッチがDateTime.pmに取り込まれたので、ご紹介したいと思います。</p>

<!-- More -->


<p>そのpullreqがこちらです。Closedになっていますが、該当コミットはmasterに取り込まれています。</p>

<ul>
<li><a href="https://github.com/houseabsolute/DateTime.pm/pull/48">The leap second in 2012 was on 2012-07-01 not 2012-06-01. #48</a></li>
</ul>


<blockquote><p>per <a href="https://confluence.qps.nl/display/KBE/UTC+to+GPS+Time+Correction">https://confluence.qps.nl/display/KBE/UTC+to+GPS+Time+Correction</a> the leap second in 2012 was on 2012-07-01 not 2012-06-01. It&rsquo;s is well known that leap seconds only occur directly before Jan 1st or July 1st.</p></blockquote>

<p>適当な和訳「2012年に挿入されたうるう秒は2012年6月1日ではなく2012年7月1日です。よく知られているように、今までに挿入されたうるう秒は1月1日と7月1日の直前だけです。」</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/lib/DateTime/LeapSecond.pm b/lib/DateTime/LeapSecond.pm</span>
</span><span class='line'><span class="gh">index 66e1b2b..4a38be2 100644</span>
</span><span class='line'><span class="gd">--- a/lib/DateTime/LeapSecond.pm</span>
</span><span class='line'><span class="gi">+++ b/lib/DateTime/LeapSecond.pm</span>
</span><span class='line'><span class="gu">@@ -108,7 +108,7 @@ sub _initialize {</span>
</span><span class='line'>             1999  Jan. 1  +1
</span><span class='line'>             2006  Jan. 1  +1
</span><span class='line'>             2009  Jan. 1  +1
</span><span class='line'><span class="gd">-            2012  Jun. 1  +1</span>
</span><span class='line'><span class="gi">+            2012  Jul. 1  +1</span>
</span><span class='line'>             2015  Jul. 1  +1
</span><span class='line'>             2017  Jan. 1  +1
</span><span class='line'>             )
</span></code></pre></td></tr></table></div></figure>


<p>なぜ4年間誰も気が付かなかった。</p>

<h2>このバグの影響</h2>

<p>結論から言うと、<strong>この修正によるDateTime.pmの挙動への影響はありません</strong>。
これを書いている時点で最新版のver1.41には、上記の修正は取り込まれていませんが、
うるう秒は2012年7月1日に正しく挿入されます。</p>

<p>以前<a href="//shogo82148.github.io/blog/2015/12/09/perl-datetime/">Perl の DateTime 利用上の注意点</a>で
うるう秒の確認をしたときと同様に検証してみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">use</span> <span class="n">feature</span> <span class="sx">qw(say)</span><span class="p">;</span>
</span><span class='line'><span class="k">my</span> <span class="nv">$dt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="n">DateTime</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$dt</span> <span class="o">=</span> <span class="n">DateTime</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">year</span> <span class="o">=&gt;</span> <span class="mi">2012</span><span class="p">,</span> <span class="n">month</span> <span class="o">=&gt;</span> <span class="mi">7</span><span class="p">,</span> <span class="n">day</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hour</span> <span class="o">=&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="n">time_zone</span> <span class="o">=&gt;</span> <span class="s">&#39;Asia/Tokyo&#39;</span> <span class="p">);</span>
</span><span class='line'><span class="n">say</span> <span class="nv">$dt</span><span class="o">-&gt;</span><span class="n">subtract</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$dt</span> <span class="o">=</span> <span class="n">DateTime</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">year</span> <span class="o">=&gt;</span> <span class="mi">2012</span><span class="p">,</span> <span class="n">month</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span> <span class="n">day</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hour</span> <span class="o">=&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="n">time_zone</span> <span class="o">=&gt;</span> <span class="s">&#39;Asia/Tokyo&#39;</span> <span class="p">);</span>
</span><span class='line'><span class="n">say</span> <span class="nv">$dt</span><span class="o">-&gt;</span><span class="n">subtract</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ perl datetime.pl
</span><span class='line'>2012-07-01T08:59:60
</span><span class='line'>2012-06-01T08:59:59
</span><span class='line'>
</span><span class='line'>$ PERL_DATETIME_PP=1 perl datetime.pl
</span><span class='line'>2012-07-01T08:59:60
</span><span class='line'>2012-06-01T08:59:59</span></code></pre></td></tr></table></div></figure>


<p>DateTime.pmにはXSの実装とPurePerlの実装が含まれていますが、
どちらの実装でも2012年7月1日に正しくうるう秒が挿入され、2012年6月1日にはうるう秒はありません。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">プログラム書いてると「書いたとおりに動くんじゃなくて思った通りに動けよ」って思うけど、たまに「コード見たら絶対動かないはずなのになぜか思った通りにちゃんと動く」みたいな奴に出くわすと恐ろしくて夜も眠れなくなるのでやっぱり書いたとおりに動いて欲しい</p>&mdash; かずー (@kazoo04) <a href="https://twitter.com/kazoo04/status/808195587518578688">December 12, 2016</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>まさに、「コード見たら絶対動かないはずなのになぜか思った通りにちゃんと動く」といった感じです。</p>

<h2>なぜ正しく動くのか</h2>

<p>なぜ正しく動くのか、その答えはうるう秒一覧の解析を行う部分にありました。</p>

<ul>
<li><a href="https://github.com/houseabsolute/DateTime.pm/blob/ff0e3780ea1c841eb17a0245f5f8061cf10c28d3/lib/DateTime/LeapSecond.pm#L40-L41">DateTime.pm/lib/DateTime/LeapSecond.pm</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">my</span> <span class="nv">$utc_epoch</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">DateTime</span><span class="o">-&gt;</span><span class="n">_ymd2rd</span><span class="p">(</span> <span class="nv">$year</span><span class="p">,</span> <span class="p">(</span> <span class="nv">$mon</span> <span class="o">=~</span><span class="sr"> /Jan/i</span> <span class="p">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">7</span> <span class="p">),</span> <span class="nv">$mday</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Jan.(1月)以外はすべて7月として扱っている！</strong></p>

<p>Janか否かが重要なので、JunだろうがJulだろうが7月として扱われるので、結果的に正しく動くわけです。
「バグを埋め込んでいたけど、実装が適当でたまたま動いていた」というよくあるパターンですね。
将来3月末や9月末に挿入されるようになったとき大丈夫なんでしょうか・・・。
まあ、必要になるのは数百年後とかなので、僕には関係ない・・・そう、関係ないのです・・・。</p>

<h2>まとめ</h2>

<ul>
<li>DateTime.pmのうるう秒一覧にbug fix</li>
<li>動作に影響は無いので、ユーザ側では特に気にする必要はない

<ul>
<li>うるう秒自体を気にしないといけないのは仕方がない・・・</li>
</ul>
</li>
<li>JanとかJunとかJulとか似てて紛らわしいんだよ！！数字書け！！</li>
</ul>


<h2>ちなみに</h2>

<p>最新版のver1.41は来年(2017年)の1月1日のうるう秒に対応済みです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">use</span> <span class="n">feature</span> <span class="sx">qw(say)</span><span class="p">;</span>
</span><span class='line'><span class="k">my</span> <span class="nv">$dt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="n">DateTime</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$dt</span> <span class="o">=</span> <span class="n">DateTime</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="n">year</span> <span class="o">=&gt;</span> <span class="mi">2017</span><span class="p">,</span> <span class="n">month</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">day</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hour</span> <span class="o">=&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="n">time_zone</span> <span class="o">=&gt;</span> <span class="s">&#39;Asia/Tokyo&#39;</span> <span class="p">);</span>
</span><span class='line'><span class="n">say</span> <span class="nv">$dt</span><span class="o">-&gt;</span><span class="n">subtract</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ perl datetime.pl
</span><span class='line'>2017-01-01T08:59:60</span></code></pre></td></tr></table></div></figure>


<p>みなさん準備は出来ていますか 😇</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Twitterの二次元コード問題と、QRコード・フレームQRの見分け方]]></title>
    <link href="https://shogo82148.github.io/blog/2016/11/23/qr-code/"/>
    <updated>2016-11-23T10:32:43+09:00</updated>
    <id>https://shogo82148.github.io/blog/2016/11/23/qr-code</id>
    <content type="html"><![CDATA[<p>先日Twitterの公式アプリがQRコード®
(<a href="https://blog.twitter.com/ja/2016/1117qrcode">お店やお友達を簡単にフォローするために</a>)
の作成と読み取りに対応しました。
しかし、生成されるQRコードが標準規格に準拠していないため、
「他のリーダーで読めない」「法的に問題があるのでは？」等々の指摘が出ていました。
人事ながらTwitterさんのことが心配になったので少し調べてみました。</p>

<p>なお、僕は法律の専門家ではないため、本記事の正確性は保証できません。
あくまで個人的な見解なので、
実際にQRコード®を使用するさいは各自の判断でお願いします。</p>

<!-- More -->


<h2>指摘ツイート</h2>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Twitterが生成するQRコード、規格(JIS X 0510・ISO/IEC 18004)を大幅に逸脱しているので「QRコード®」を名乗ること自体に法的なリスクがある。</p>&mdash; 祥太(2日目 東Q30a) (@shota_) <a href="https://twitter.com/shota_/status/799066842694197248">November 17, 2016</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>




<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">「デンソーウェーブは、JIS、ISOの規格に沿ったQRコードに限っては特許権を行使しませんが、規格を逸脱したQRコードについてはこの限りではございませんので、特許権を行使させていただくこともございます。」<br><br>(出典: <a href="https://t.co/SKXgBGSb8E">https://t.co/SKXgBGSb8E</a> )</p>&mdash; 祥太(2日目 東Q30a) (@shota_) <a href="https://twitter.com/shota_/status/799066960466034689">November 17, 2016</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>




<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">明暗暗転で読み取らないという話を多数見かけますけど、そちらについては「ISO/IEC 18004からは逸脱」「JIS X 0510には準拠」(規格票7.3.8参照)という微妙な状況なのです。多分ISOには準拠しているのでアプリは悪くないと思います。</p>&mdash; 祥太(2日目 東Q30a) (@shota_) <a href="https://twitter.com/shota_/status/799104490095808512">November 17, 2016</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>たしかに <a href="http://www.qrcode.com/faq.html">qrcode.comのFAQ</a>には
特許について以下の記述があります。</p>

<blockquote><p>色を付けたりイラストを入れるような使い方をしても問題ありませんか？
(中略)
また、QRコードにイラストを重ねたりデザインを乗せるということは、QRコードの規格から外れ「QRコードではないもの」となってしまう可能性がございます。
デンソーウェーブは、JIS、ISOの規格に沿ったQRコードに限っては特許権を行使しませんが、規格を逸脱したQRコードについてはこの限りではございませんので、特許権を行使させていただくこともございます。</p></blockquote>

<h2>問題点</h2>

<p>公式アプリの生成する二次元コードは以下のような問題があります。</p>

<ul>
<li>データパターンの20%近くがアイコンで上書きされている</li>
<li>「アライメントパターン」がTwitterのロゴで欠けている</li>
<li>明暗暗転している(一応JISには沿っているらしい)</li>
</ul>


<p>法的リスク以前に、
読み取り性能/互換性が劣化するので使わない方が無難でしょう。</p>

<p>自分のプロフィールのURL
(僕の場合は <a href="https://twitter.com/shogo82148">https://twitter.com/shogo82148</a> )を
QRコードに変換すれば公式アプリのリーダーでも読めるので、
こちらの方がオススメです。</p>

<p><img src="http://chart.apis.google.com/chart?cht=qr&amp;chs=130x130&amp;chl=https://twitter.com/shogo82148" alt="僕のQRコード" /></p>

<h2>QRコード関連の権利</h2>

<h3>特許</h3>

<p>QRコード®のJIS規格JIS X 0510には、
関連する特許として特許第2938338号「二次元コード」があげられています。
ただし、特許の保護期間は20年なので、1994年に出願されたこの特許は2014年で消滅しています。
したがってこの特許を理由に訴えられることはなさそうです。</p>

<p>ところがQRコードには実はモデル1とモデル2の二種類があり、
モデル2に関しては特許第3716527号「２次元コードおよび２次元コードの読取方法」が
該当しそうです。
この特許は「アライメントパターン」という特殊なパターンを二次元コードに埋め込んで、
大きなコードや曲面に印刷されたコードも読み取れるようにするというものです。
こちらは2017年1月28日までが保護期間で、この記事を書いている時点ではまだ保護期間内です。</p>

<p>Twitter公式アプリの二次元コードはモデル2にが該当するので、
この特許を理由に訴えられる可能性は依然としてありそうです。
ただし、期限が切れる2017年1月29日以降であれば、堂々と規格違反のQRコードを作れるはず(?)
(繰り返しになりますが、僕が関連特許を見落としている可能性もあるので、実際の使用は各自の判断で)</p>

<h3>商標</h3>

<p>商標にも保護期限ってあるのかなあと調べてみたところ、
10年の期限はあるものの上限なく延長できるそうです。
したがって、QRコード®でないものをQRコード®として公開するのはまずそうです。</p>

<p>なお、作った二次元コード自体は商標ではないので、
公式アプリで作ったコードを利用するだけであれば何も問題はないはずです。
ユーザが訴えられる可能性はほとんどないのでご安心を。</p>

<h2>フレームQRについて</h2>

<p>QRコード®も進化していて、今はフレームQR®というものがあり、
コードの中に画像を埋め込めるそうです。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr"><a href="https://twitter.com/shota_">@shota_</a> フレームQRという既存技術なので問題ないのではないでしょうか？<a href="https://t.co/sYsAIQiNWW">https://t.co/sYsAIQiNWW</a></p>&mdash; かおる (@awKaoru) <a href="https://twitter.com/awKaoru/status/799074365572644865">November 17, 2016</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>ググって調べてみたところ、これには特許第5057560号「プログラム、情報記憶媒体、２次元コード、印刷物、２次元コード画像、２次元コード画像の表示制御方法、２次元コード生成システム」
が関連していそうです。
この特許、出願人がQRコード®の開発元であるデンソーウェーブではなく、
株式会社バンダイナムコエンターテインメントなんですよね。
QRコード®が比較的オープンなのに対してフレームQR®関連の資料がないのは
この辺が関連しているのでしょうか・・・。</p>

<h3>QRコードとフレームQR見分け方</h3>

<p>さて気になるのは、Twitterの二次元コードがフレームQR®に該当するか、ですよね。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">QRフレームと違うらいいけどそもそもQRフレームの定義がわからないせいで違いがわからない・・・  自由に使えるキャンパス領域に描いてるように見えるような気もするんだけど</p>&mdash; オウカ♥ドール (@rofi) <a href="https://twitter.com/rofi/status/799088728035598336">November 17, 2016</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>結論から言うと、<strong>QRコード®とフレームQR®は別物</strong> であり、
 <strong>Twitterの二次元コードはフレームQR®ではありません</strong>。</p>

<p>具体的な見分け方ですが、QRコード®に特徴的な「位置検出パターン」「タイミングパターン」「アライメントパターン」は
フレームQR®にもあるため、「型式情報」を頑張って読み取るしかないようです。
「型式情報」は<a href="https://ja.wikipedia.org/wiki/BCH%E7%AC%A6%E5%8F%B7">BCH符号</a>で符号化されているため、
人間が手動で復号するのは少し大変です。
「型式情報」はたったの32パターンしかないので、
<strong>すべてのパターンを覚えるのが一番楽</strong> な方法です。
というわけで、パターン一覧を作ってみました。</p>

<ul>
<li><a href="https://shogo82148.github.io/images/2016-11-23-qrlist.svg">パターン一覧</a></li>
<li><a href="https://gist.github.com/shogo82148/07018ddad8f001e149a5aa34b0dff2c4">生成プログラム</a></li>
</ul>


<p>QRコード®やフレームQR®には「位置検出パターン」と呼ばれる「回」のようなパターンが3つあります。
このうち左上のパターンの周りに「型式情報」があります
(本当は冗長性のために他の2つの位置検出パターンの周りにもあるけど、左上のが一番みやすい)。
先ほどの<a href="https://shogo82148.github.io/images/2016-11-23-qrlist.svg">パターン一覧</a>から一番近いものを探しましょう。
各行の一番左を手掛かりにすると探しやすいです。
その隣に「QRコード®モデル1」「QRコード®モデル2」「フレームQR®」に並んでいます。
以下は僕のコードを調べてみたときの例です。</p>

<p><img src="https://shogo82148.github.io/images/2016-11-23-sample.svg" alt="解析例" /></p>

<p><strong>さあ、これで君もQRコードーリーダーになれる！！</strong></p>

<h2>まとめ</h2>

<ul>
<li>Twitterの二次元コードはQRコード®でもフレームQR®でもない</li>
<li>やっぱり法的リスクはありそう(な気がする)

<ul>
<li>少なくとも2017年1月28日までは特許権を理由に訴えられる可能性あり</li>
<li>QRコード®の商標を使っているのは危なそう</li>
</ul>
</li>
<li>ユーザに対しての法的リスクはないので、公式アプリの二次元コードの利用はご自由に

<ul>
<li>でも、法的に問題なくても、規格違反なので使わない方が無難</li>
</ul>
</li>
</ul>


<h2>参考</h2>

<ul>
<li>JIS X 0510 二次元コードシンボル―ＱＲコード―基本仕様</li>
<li>特許第2938338号「二次元コード」</li>
<li>特許第3716527号「２次元コードおよび２次元コードの読取方法」</li>
<li>特許第5057560号「プログラム、情報記憶媒体、２次元コード、印刷物、２次元コード画像、２次元コード画像の表示制御方法、２次元コード生成システム」</li>
</ul>


<p>QRコード®およびフレームQR®は<a href="http://www.denso-wave.com/">(株)デンソーウェーブ</a>の登録商標です</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GitHub Pagesがhttpsをサポートしたので切り替えてみた]]></title>
    <link href="https://shogo82148.github.io/blog/2016/06/10/github-page-supports-https/"/>
    <updated>2016-06-10T00:53:51+09:00</updated>
    <id>https://shogo82148.github.io/blog/2016/06/10/github-page-supports-https</id>
    <content type="html"><![CDATA[<p>このブログを設置しているGithub PagesがHTTPSに正式対応したらしいので、HTTPSを強制するように設定してみました。</p>

<ul>
<li><a href="https://github.com/blog/2186-https-for-github-pages">HTTPS for GitHub Pages</a></li>
</ul>


<!-- More -->


<h2>やったこと</h2>

<p>ページ内にHTTP経由で取得したリソースが含まれていると、
警告が出たり取得自体がブロックされたりしてしまうので、
全てHTTPS経由で取得するように書きなおす必要があります。
画像・CSS・Javascript等のURLを、以下のようにnetwork-path referenceへの置き換えましょう。
HTTPでページを開いた場合はHTTPで、HTTPSでページを開いた場合はHTTPSで、リソースを取得してくれます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;a href="http://google.co.jp"&gt;
</span><span class='line'>&lt;a href="//google.co.jp"&gt;</span></code></pre></td></tr></table></div></figure>


<p>このサイトはHTTPのレンダリングに<a href="https://github.com/imathis/octopress">Octopress</a>を使っています。
最新版のOctopressではnetwork-path referenceを使ってくれるので特に対応は不要です。
このサイトの場合は古すぎてHTTP参照だったので、
「<a href="http://blog.glidenote.com/blog/2014/02/14/octopress-update/">Octopressをアップデートした</a>」を参考にしてアップデートしました。
はてなブックマーク連携など、自分でカスタマイズした部分に関しては手作業で対応したました。</p>

<h3>HTTPS強制の設定</h3>

<p><a href="https://help.github.com/articles/securing-your-github-pages-site-with-https/">Securing your GitHub Pages site with HTTPS</a> どおりに設定を有効化すればOKです。
ユーザ毎ではなくプロジェクト毎の設定のようなので、
プロジェクト用のページを作っている場合は個別に設定が必要です。</p>

<h2>はてなブックマークについて</h2>

<p>HTTPとHTTPSは別URLとして扱われるようなので、過去の記事に対するはてブ数はリセットされてしまいます。
解決方法は無いかと調べてみたものの、現象無理っぽいです。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">自分のブログは http から https に移行したけど、記事についたはてブを移行することは出来なかった（はてなのサポートに聞いた）。分からないでもないけど、https 移行の躊躇材料になるという点においてはイケてない。</p>&mdash; Takashi Masuda (@masutaka) <a href="https://twitter.com/masutaka/status/739747936318283776">June 6, 2016</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>はてなさんの方で対応してくれないかな・・・</p>

<h2>2016/06/30追記: DISQUSのマイグレーション</h2>

<p>記事にコメントをつけるのに使っている<a href="https://disqus.com/">DISQUS</a>をマイグレーションするのを忘れてて、
過去のコメントが見れなくなっていたので追記。</p>

<p><a href="https://disqus.com/">DISQUS</a>のホームから「Admin」「Edit Settings」で設定画面を開き、
Website URLの近くの「Changing domains? Learn how.」をクリックします。
すると「Migration Tools」が開くので、「Start URL mapper」「you can download a CSV here」をクリック。
5分くらいするとDISQUSがコメントを管理しているURL一覧がメールで届くので、
それを元に新旧URLの対応表を作ります。</p>

<p>今回はプロトコルの変更なので、以下のような雑なワンライナーで変換しました。
(改行コードがCRLFで地味に面倒だった)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grep http:// links.csv | perl -e '$/="\r\n";while(&lt;&gt;){chomp;print "$_,@{[$_=~s/^http:/https:/r]}$/"}' &gt; new-links.csv</span></code></pre></td></tr></table></div></figure>


<p>最後に設定画面からCSVをアップロードします。
以上で作業完了です。
最後に「24時間以内に反映するよ」的なメッセージが表示されましたが、僕の場合は5分くらいで反映が確認できました。</p>

<p>残るははてブ。はてなさん頼む〜〜〜。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Net/httpで安全に静的ファイルを返す]]></title>
    <link href="https://shogo82148.github.io/blog/2016/04/13/serving-static-files-in-golang/"/>
    <updated>2016-04-13T02:29:00+09:00</updated>
    <id>https://shogo82148.github.io/blog/2016/04/13/serving-static-files-in-golang</id>
    <content type="html"><![CDATA[<p><a href="http://konboi.hatenablog.com/entry/2016/04/12/121105">net/httpで静的ファイルを返す</a>で、
<code>http.ServeFile</code>を使っていてアレ？と思ったのでちょっと詳しく調べてみました。
(<code>http.FileServer</code>を使うものだと思ってたため)</p>

<p>結論だけ先に書いておくと</p>

<ul>
<li>やはり、特に理由がなければ<code>http.FileServer</code>を使ったほうが良さそう</li>
<li>どうしても<code>http.ServeFile</code>を使う場合は定数でパス指定をする</li>
<li>「自作パスルータを使っている」かつ「Go 1.6.1 未満を使っている」場合はとくに要注意</li>
</ul>


<!-- More -->


<h2>ディレクトリトラバーサル脆弱性</h2>

<p>紹介されているのは以下のコードです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/static/&quot;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">ServeFile</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>しかし、参照先の「<a href="http://stackoverflow.com/questions/25945538/go-golang-to-serve-a-specific-html-file">Go Golang to serve a specific html file</a>」には
<strong>Actually, do not do that.</strong> (やっちゃいけない)とコメントされています。
<a href="https://ja.wikipedia.org/wiki/%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%83%88%E3%83%A9%E3%83%90%E3%83%BC%E3%82%B5%E3%83%AB">ディレクトリトラバーサル</a>により
脆弱性の原因となってしまう可能性があるためです。</p>

<p>脆弱性再現のために、以下の様なコードを書いてGo1.5でコンパイルして実行してみました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>  <span class="s">&quot;strings&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:3000&quot;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">HasPrefix</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="s">&quot;/static/&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">http</span><span class="p">.</span><span class="nx">ServeFile</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">http</span><span class="p">.</span><span class="nx">NotFound</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>..</code>を含んだパスをリクエストしてみます。(実行した場所によって<code>..</code>の数は変わるので適宜調整してみてください)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -v http://localhost:3000/static/../../../.ssh/id_rsa
</span><span class='line'>* About to connect() to localhost port 3000 (#0)
</span><span class='line'>*   Trying ::1... connected
</span><span class='line'>* Connected to localhost (::1) port 3000 (#0)
</span><span class='line'>&gt; GET /static/../../../.ssh/id_rsa HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.19.1 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2
</span><span class='line'>&gt; Host: localhost:3000
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt;
</span><span class='line'>&lt; HTTP/1.1 200 OK
</span><span class='line'>&lt; Accept-Ranges: bytes
</span><span class='line'>&lt; Content-Length: 1679
</span><span class='line'>&lt; Content-Type: text/plain; charset=utf-8
</span><span class='line'>&lt; Last-Modified: Fri, 13 Jun 2014 04:57:05 GMT
</span><span class='line'>&lt; Date: Tue, 12 Apr 2016 17:53:19 GMT
</span><span class='line'>&lt;
</span><span class='line'>-----BEGIN RSA PRIVATE KEY-----
</span><span class='line'>(中略)
</span><span class='line'>-----END RSA PRIVATE KEY-----
</span><span class='line'>* Connection #0 to host localhost left intact
</span><span class='line'>* Closing connection #0</span></code></pre></td></tr></table></div></figure>


<p>macのcurlで試したらクライアント側で相対パスを解決した状態でリクエストが飛んでしまって上手く行きませんでした。
オプションで外す方法がよくわかなかったので、<code>telnet</code>で叩いてみた例も載せておきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ telnet localhost 3000
</span><span class='line'>Trying ::1...
</span><span class='line'>Connected to localhost.
</span><span class='line'>Escape character is '^]'.
</span><span class='line'>GET /static/../../../.ssh/id_rsa HTTP/1.0
</span><span class='line'>
</span><span class='line'>HTTP/1.0 200 OK
</span><span class='line'>Accept-Ranges: bytes
</span><span class='line'>Content-Length: 1679
</span><span class='line'>Content-Type: text/plain; charset=utf-8
</span><span class='line'>Last-Modified: Fri, 13 Jun 2014 04:57:05 GMT
</span><span class='line'>Date: Tue, 12 Apr 2016 18:02:56 GMT
</span><span class='line'>
</span><span class='line'>-----BEGIN RSA PRIVATE KEY-----
</span><span class='line'>(中略)
</span><span class='line'>-----END RSA PRIVATE KEY-----
</span><span class='line'>Connection closed by foreign host.</span></code></pre></td></tr></table></div></figure>


<p>ああ、僕の秘密鍵が・・・。</p>

<h2>脆弱性を回避する</h2>

<h3>Go1.6以降を使う</h3>

<p>Go1.6以降では修正されており、
同じコードをGo1.6でコンパイルしてcurlで叩くと400が帰ってきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -v http://localhost:3000/static/../../../.ssh/id_rsa
</span><span class='line'>* About to connect() to localhost port 3000 (#0)
</span><span class='line'>*   Trying ::1... connected
</span><span class='line'>* Connected to localhost (::1) port 3000 (#0)
</span><span class='line'>&gt; GET /static/../../../.ssh/id_rsa HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.19.1 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2
</span><span class='line'>&gt; Host: localhost:3000
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt; 
</span><span class='line'>&lt; HTTP/1.1 400 Bad Request
</span><span class='line'>&lt; Content-Type: text/plain; charset=utf-8
</span><span class='line'>&lt; X-Content-Type-Options: nosniff
</span><span class='line'>&lt; Date: Tue, 12 Apr 2016 18:12:46 GMT
</span><span class='line'>&lt; Content-Length: 17
</span><span class='line'>&lt; 
</span><span class='line'>invalid URL path
</span><span class='line'>* Connection #0 to host localhost left intact
</span><span class='line'>* Closing connection #0</span></code></pre></td></tr></table></div></figure>


<h3><code>http.ServeMux</code>を使う</h3>

<p><code>http.ServeMux</code>にはパスの正規化機能が組み込まれており、
正規化されていないURLにアクセスが来た場合は自動的リダイレクトしてくれるようです。
HTTPハンドラに渡ってくるときには、必ず相対パスが含まれていない状態になっています。
(これに最初は気が付かず、脆弱性が再現しないので困ってた。)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 内部でhttp.ServeMuxを使ってくれる</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/static/&quot;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// r.URLには相対パスが含まれない形で渡ってくる</span>
</span><span class='line'>    <span class="nx">http</span><span class="p">.</span><span class="nx">ServeFile</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:3000&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>相対パスを含んだリクエストを投げてもアクセスはできません。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -v http://localhost:3000/static/../../../.ssh/id_rsa
</span><span class='line'>* About to connect() to localhost port 3000 (#0)
</span><span class='line'>*   Trying ::1... connected
</span><span class='line'>* Connected to localhost (::1) port 3000 (#0)
</span><span class='line'>&gt; GET /static/../../../.ssh/id_rsa HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.19.1 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2
</span><span class='line'>&gt; Host: localhost:3000
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt; 
</span><span class='line'>&lt; HTTP/1.1 301 Moved Permanently
</span><span class='line'>&lt; Location: /.ssh/id_rsa
</span><span class='line'>&lt; Date: Tue, 12 Apr 2016 18:14:49 GMT
</span><span class='line'>&lt; Content-Length: 47
</span><span class='line'>&lt; Content-Type: text/html; charset=utf-8
</span><span class='line'>&lt; 
</span><span class='line'>&lt;a href="https://shogo82148.github.io/.ssh/id_rsa"&gt;Moved Permanently&lt;/a&gt;.
</span><span class='line'>
</span><span class='line'>* Connection #0 to host localhost left intact
</span><span class='line'>* Closing connection #0</span></code></pre></td></tr></table></div></figure>


<h3><code>http.FileServer</code>を使う</h3>

<p><code>http.Dir</code>と<code>http.FileServer</code>を使うとルートディレクトリを指定でき、
その外へはアクセスできなくなるので想定外のファイルが見えてしまうことはありません。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>  <span class="s">&quot;strings&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">fileServer</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StripPrefix</span><span class="p">(</span><span class="s">&quot;/static/&quot;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileServer</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">Dir</span><span class="p">(</span><span class="s">&quot;static&quot;</span><span class="p">)))</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:3000&quot;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">HasPrefix</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="s">&quot;/static/&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fileServer</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">http</span><span class="p">.</span><span class="nx">NotFound</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="p">}))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>相対パスを含んだURLにアクセスしても404になって見れません。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -v http://localhost:3000/static/../../../.ssh/id_rsa
</span><span class='line'>* About to connect() to localhost port 3000 (#0)
</span><span class='line'>*   Trying ::1... connected
</span><span class='line'>* Connected to localhost (::1) port 3000 (#0)
</span><span class='line'>&gt; GET /static/../../../.ssh/id_rsa HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.19.1 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2
</span><span class='line'>&gt; Host: localhost:3000
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt; 
</span><span class='line'>&lt; HTTP/1.1 404 Not Found
</span><span class='line'>&lt; Content-Type: text/plain; charset=utf-8
</span><span class='line'>&lt; X-Content-Type-Options: nosniff
</span><span class='line'>&lt; Date: Tue, 12 Apr 2016 18:39:34 GMT
</span><span class='line'>&lt; Content-Length: 19
</span><span class='line'>&lt; 
</span><span class='line'>404 page not found
</span><span class='line'>* Connection #0 to host localhost left intact
</span><span class='line'>* Closing connection #0</span></code></pre></td></tr></table></div></figure>


<h3><code>http.ServeFile</code>に定数を渡す</h3>

<p>どうしても特定のファイルを指定したい場合は、<code>http.ServeFile</code>に渡すファイルパスを定数で指定するべきです。
例えば、「<a href="http://stackoverflow.com/questions/25945538/go-golang-to-serve-a-specific-html-file">Go Golang to serve a specific html file</a>」の質問者が上げている例を
正しく書きなおすと以下のようになると思います。</p>

<blockquote><p><code>http.Handle("/", http.FileServer(http.Dir("static")))</code>
Serves the html file in static directory.</p>

<p>Is there any way in Go that we can specify the html file to serve?</p>

<p>Something like render_template in Flask</p>

<p>I want to do something like:</p>

<p><code>http.Handle("/hello", http.FileServer(http.Dir("static/hello.html")))</code></p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/hello&quot;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">http</span><span class="p">.</span><span class="nx">ServeFile</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="s">&quot;static/hello.html&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:3000&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>回答者がActually, do not do thatとコメントしているのは<code>http.ServeFile</code>に<code>r.URL.Path[1:]</code>を渡すことで、
<code>http.ServeFile</code>自体が悪いわけではありません。
正しく安全に使いましょう。</p>

<h2>まとめ</h2>

<p>まとめ再掲。</p>

<ul>
<li>やはり、特に理由がなければ<code>http.FileServer</code>を使ったほうが良さそう</li>
<li>どうしても<code>http.ServeFile</code>を使う場合は定数でパス指定をする</li>
<li>「自作パスルータを使っている」かつ「Go 1.6.1 未満を使っている」場合はとくに要注意</li>
</ul>


<h2>まとめのまとめ</h2>

<p><a href="https://golang.org/pkg/net/http/#example_FileServer">godocのexample</a>どおりにやるのが一番。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/static/&quot;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StripPrefix</span><span class="p">(</span><span class="s">&quot;/static/&quot;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileServer</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">Dir</span><span class="p">(</span><span class="s">&quot;static&quot;</span><span class="p">))))</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:3000&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PerlでもGoでも実行できるQuine書いた]]></title>
    <link href="https://shogo82148.github.io/blog/2016/04/06/ployglot-quine-of-golang-and-perl/"/>
    <updated>2016-04-06T10:07:00+09:00</updated>
    <id>https://shogo82148.github.io/blog/2016/04/06/ployglot-quine-of-golang-and-perl</id>
    <content type="html"><![CDATA[<p><a href="http://shogo82148.github.io/blog/2016/04/05/polyglot-of-perl-and-golang/">昨日のPolyglot</a>を元にPerlでもGoでも実行できるQuine書いた。</p>

<!-- More -->




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package main;import("fmt");var(q=`printf'package main;import("fmt");var(q%c%c%s%c/*%c);sub import{}sub var{$_%cshift%c~s!%c(.*)%c/\*!$1!gr;eval}%c__END__%c',61,96,$_,96,61,61,61,96,96,10,10;print&lt;DATA&gt;`/*=);sub import{}sub var{$_=shift=~s!`(.*)`/\*!$1!gr;eval}
</span><span class='line'>__END__
</span><span class='line'>*/);func main(){s:=`package main;import("fmt");var(q=%c%s%c/*=);sub import{}sub var{$_=shift=~s!%c(.*)%c/\*!$1!gr;eval}
</span><span class='line'>__END__
</span><span class='line'>*/);func main(){s:=%c%s%c;fmt.Printf(s,96,q,96,96,96,96,s,96)}
</span><span class='line'>`;fmt.Printf(s,96,q,96,96,96,96,s,96)}</span></code></pre></td></tr></table></div></figure>


<p>Perlで実行してもGoで実行しても自分自身を出力します。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PerlとGolangで実行できるPolyglot書いてみた]]></title>
    <link href="https://shogo82148.github.io/blog/2016/04/05/polyglot-of-perl-and-golang/"/>
    <updated>2016-04-05T12:27:00+09:00</updated>
    <id>https://shogo82148.github.io/blog/2016/04/05/polyglot-of-perl-and-golang</id>
    <content type="html"><![CDATA[<p>Rubyの会社をPerlの会社に変えてしまおう計画。
Golangのフリをして忍び込ませれば行けるのではという話になったので、
GoでもPerlでも実行できるコードを書いてみた。</p>

<!-- More -->


<p>出来上がったのがこちら。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package main;
</span><span class='line'>import ("fmt");
</span><span class='line'>var (s=0/*==);
</span><span class='line'>sub import {}
</span><span class='line'>sub var { print "Hello macotasu"; }
</span><span class='line'>__END__
</span><span class='line'>*/)
</span><span class='line'>func main() { fmt.Println("Hello macotasu") }</span></code></pre></td></tr></table></div></figure>


<p>一番のポイントは<code>var (s=0/*==);</code>の行ですね。
Perlで解釈すると正規表現置換<code>s///</code>として解釈され、<code>/*</code>が無視されます。
Goで解釈すると変数<code>s</code>への代入として解釈され、<code>/*</code>がコメントとして扱われます。</p>

<p>あとはGoのキーワードをPerlが解釈できないので、ちょっと書き方を工夫します。</p>

<ul>
<li><code>package main</code> はGoでもPerlでも似たような意味で解釈されるのでそのまま</li>
<li>Goの <code>import</code>, <code>var</code> はPerlで解釈できないので、()を省略せずに書いてPerlの関数呼び出しっぽくする</li>
<li>省略可能なセミコロンをちゃんと書く</li>
</ul>


<p>GoとPerlのコードは分かれているのでどんな処理でも自由に書くことができますが、
<code>import</code> だけGoでもPerlでも解釈されてしまうというという制限があります。
<code>import</code> するパッケージが一個だけなら問題ないんですが、
複数書く場合は以下のように２個め以降をすべてドットインポートする必要があって男気あふれる感じです。
(Perlでは文字列結合として解釈される。Goでは<code>var</code>のあとに<code>import</code>かけないっぽいので、ここに押し込むしかない。)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package main;
</span><span class='line'>import (
</span><span class='line'>  "fmt"
</span><span class='line'>  . "math"
</span><span class='line'>);
</span><span class='line'>var (s=0/*==);
</span><span class='line'>sub import {}
</span><span class='line'>sub var { print "Hello macotasu"; }
</span><span class='line'>__END__
</span><span class='line'>*/)
</span><span class='line'>func main() { fmt.Println("Hello macotasu", Pi) }</span></code></pre></td></tr></table></div></figure>


<p>もっと簡潔にかけないかな。</p>

<h2>追記</h2>

<p>シンタックスハイライトしてみたらわかりやすいかなと思ってやってみた。</p>

<p>Perlのシンタックスハイライト。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="nb">package</span> <span class="n">main</span><span class="p">;</span>
</span><span class='line'><span class="nb">import</span> <span class="p">(</span><span class="s">&quot;fmt&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">var</span> <span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="o">/*==</span><span class="p">);</span>
</span><span class='line'><span class="k">sub </span><span class="nf">import</span> <span class="p">{}</span>
</span><span class='line'><span class="k">sub </span><span class="nf">var</span> <span class="p">{</span> <span class="k">print</span> <span class="s">&quot;Hello macotasu&quot;</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="cp">__END__</span>
</span><span class='line'><span class="cp">*/)</span>
</span><span class='line'><span class="cp">func main() { fmt.Println(&quot;Hello macotasu&quot;) }</span>
</span></code></pre></td></tr></table></div></figure>


<p>Goのシンタックスハイライト。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span><span class="p">;</span>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span><span class="s">&quot;fmt&quot;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="p">(</span><span class="nx">s</span><span class="p">=</span><span class="mi">0</span><span class="cm">/*==);</span>
</span><span class='line'><span class="cm">sub import {}</span>
</span><span class='line'><span class="cm">sub var { print &quot;Hello macotasu&quot;; }</span>
</span><span class='line'><span class="cm">__END__</span>
</span><span class='line'><span class="cm">*/</span><span class="p">)</span>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Hello macotasu&quot;</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>参考</h2>

<ul>
<li><a href="https://golang.org/ref/spec">The Go Programming Language Specification</a></li>
<li><a href="http://d.hatena.ne.jp/sugyan/20110306/1299418878">polyglot 基礎の基礎</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Webブラウザを使って電波を出してみた]]></title>
    <link href="https://shogo82148.github.io/blog/2016/03/29/web-jjy/"/>
    <updated>2016-03-29T12:19:00+09:00</updated>
    <id>https://shogo82148.github.io/blog/2016/03/29/web-jjy</id>
    <content type="html"><![CDATA[<p>読者の持っている至って普通のコンピューターは、実は電波時計の時刻合わせを行うために必要な標準電波の発信装置が備わっている。</p>

<p>コードは以下から入手できる。</p>

<ul>
<li><a href="https://github.com/shogo82148/web-jjy">shogo82148/web-jjy</a></li>
<li><a href="http://shogo82148.github.io/web-jjy/">JJYシミュレータWeb版</a></li>
</ul>


<!-- More -->


<h2>動かし方</h2>

<p>パソコンのイヤホンジャックにアンテナ(普通のイヤホンで十分です)を接続し、電波時計の近くに置きます。
音量を最大にし、「Start」ボタンを押すと信号が送信されます。
電波時計を強制受信モードにし、時刻が設定されるのを待ちましょう。</p>

<p>パソコンの時間を基準にするので、あらかじめntpとかで時刻設定をしておくといいと思います。</p>

<h2>原理</h2>

<p><a href="http://jjy.nict.go.jp/jjy/trans/index.html">標準電波JJY</a>は日本標準時のタイムコードを送信する電波で、
東日本では40kHz、西日本では60kHzの周波数で発信されています。
電波時計はこの信号を使って時刻合わせをしています。</p>

<p>この信号をオーディオデバイスから出力する<a href="http://www.starstonesoft.com/jjy_simulator.htm">電波時計用JJYシミュレータ</a>というものがあるのを知り、
「今のWebブラウザならjavascriptだけで実装できるのでは？」と思いやってみました。
一般的なオーディオデバイスは、20kHz以上の周波数の再生には適していないため、そのままでは40kHz/60kHzの信号は出せません。
そこで、<a href="http://www.starstonesoft.com/jjy_simulator.htm">電波時計用JJYシミュレータ</a>は、歪んだ波形に含まれる高調波を利用しています。
ボリュームを大きくして音が割れた状態になると、音声信号は矩形波に近いかたちになります。
矩形波には3倍、5倍、7倍&hellip;の奇数倍の周波数成分が含まれているため、
(<a href="http://togetter.com/li/942071">世はまさに大フーリエ時代</a>とか見ると楽しい)
13.333kHzの矩形波を出力することで、39.999kHzの信号を出せるというわけです。</p>

<p>元のソフトウェアはWindowsのバイナリ形式でしたが、
WebAudioの登場によりWebブラウザからも同様のことが行えるようになりました。</p>

<h2>最後に</h2>

<p>少し前にCPUから出るノイズを使ってAMラジオの電波を発信するという記事が話題になりましたね。</p>

<ul>
<li><a href="http://cpplover.blogspot.jp/2016/03/am.html">普通のコンピューターからAMラジオを鳴らそう</a></li>
</ul>


<p>CPUやオーディオデバイスも電気で動いている以上、電波が出ているのは当たり前のことなのですが、
こうやって改めて確認できると面白いですね。</p>

<p>パソコンから出る程度の電波強度では、電波法に抵触することはないと思いますが、
うっかり強力な電波を発信しないよう気をつけてください。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[数値と文字列がごちゃ混ぜになっているJSONをよしなにParseするやつ作った]]></title>
    <link href="https://shogo82148.github.io/blog/2016/03/23/go-weaktyping/"/>
    <updated>2016-03-23T20:44:00+09:00</updated>
    <id>https://shogo82148.github.io/blog/2016/03/23/go-weaktyping</id>
    <content type="html"><![CDATA[<p>Goは数値と文字列を厳格に区別しますが、他の言語もそうとは限りません。
例えばPerlは数値と文字列を自動変換してくれるので、気をつけていないといつの間にか数値が文字列になっていたりします。
その言語の中に閉じていいれば問題ないのですが、Goとやり取りしようとすると困ります。
そんなときに使えるライブラリを書いてみました。</p>

<ul>
<li><a href="https://github.com/shogo82148/go-weaktyping">shogo82148/go-weaktyping</a></li>
</ul>


<!-- More -->


<h2>背景</h2>

<p><code>map[string][]*string</code>を返してくるライブラリがあって、
そのままだと扱いにくいのでなんとか構造体にできないかと頭を悩ませていました。
JSONに一旦変換すれば楽かなーとも思ったのですが、一部フィールドを数値に変換する必要がありました。
JSONの数値と文字列を区別するため、JSONの文字列をGoの数値型に変換するのは厄介です。
タグに<code>json:",string"</code>と指定すると変換可能になりますが、逆にJSONの数値を受け付けなくなりますし、
JSONに変換すると文字列になってしまいます。
変換先の構造体は普通のJSONの操作にも使いたかったので、これでは困ります。
「数値も文字列もUnmarshalできて、Marshalするときには数値になる」ようなJSONライブラリが必要でした。</p>

<p><code>"encoding/json"</code>に代わる新しいJSONライブラリを・・・とも考えたのですが、
よく考えるとUnmarshal時の挙動は<code>"encoding/json".Unmarshaler</code>インターフェースを実装することでカスタマイズ可能です。
こうして作ったのが go-weaktyping です。</p>

<h2>使い方</h2>

<p>builtinの型の先頭を大文字にしたものを用意しているので、
適当にUnmarshalして欲しいところでbuiltinの型の代わりに指定するだけです。
以下は整数型をUnmarshalする例です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;encoding/json&quot;</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>  <span class="s">&quot;log&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="s">&quot;github.com/shogo82148/go-weaktyping&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">ptr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">Foo</span> <span class="nx">weaktyping</span><span class="p">.</span><span class="nx">Int</span> <span class="s">`json:&quot;foo&quot;`</span>
</span><span class='line'>  <span class="p">}{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&quot;foo&quot;:123}`</span><span class="p">),</span> <span class="nx">ptr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Foo:&quot;</span><span class="p">,</span> <span class="nx">ptr</span><span class="p">.</span><span class="nx">Foo</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&quot;foo&quot;:&quot;456&quot;}`</span><span class="p">),</span> <span class="nx">ptr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Foo:&quot;</span><span class="p">,</span> <span class="nx">ptr</span><span class="p">.</span><span class="nx">Foo</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>{"foo":123}</code>が正常にUnmarshalできるのはもちろん、
通常はエラーになってしまう<code>{"foo":"456"}</code>のUnmarshalも問題なく行えます。
Marshal時は通常のint型と同様に振る舞います。</p>

<p>数値型だけでなく<code>weaktyping.String</code>も用意されていて、
通常はエラーになってしまう <code>{"foo":123}</code> も <code>struct { Foo weaktyping.String }{"123"}</code>にUnmarshal可能です。</p>

<p>その他使える型は <a href="https://godoc.org/github.com/shogo82148/go-weaktyping">godoc</a> をどうぞ。</p>

<h2>各種Boolたち</h2>

<p>builtinの<code>bool</code>に対応する<code>weaktyping.Bool</code>も実装してみたのですが、
何を持って真偽を判断するか難しい・・・。
例えば空のARRAYは真とみなすべきか、偽とみなすべきか。
普段触っている言語によって意見が分かれるのではないでしょうか。
(そもそも型が違うからエラーという人もいるだろうけど、そういうときは普通に<code>bool</code>を使いましょう)</p>

<p>JSONはもともとJavaScriptから派生した形式なので、JavaScriptに合わせるのが妥当かなと思い、
<code>weaktyping.Bool</code>の挙動はJavaScriptに合わせてあります。
「<a href="http://blog.mirakui.com/entry/20090604/truefalse">各言語におけるtrue/falseまとめ</a>」を参考に言語別のBoolも用意しています。</p>

<ul>
<li><code>Bool</code>/<code>JavaScriptBool</code>: <code>false</code>, <code>0</code>, <code>0.0</code>, <code>""</code>, <code>null</code> は偽、それ以外は真</li>
<li><code>RubyBool</code>: <code>false</code>, <code>null</code> は偽、それ以外は真</li>
<li><code>PHPBool</code>: <code>false</code>, <code>0</code>, <code>0.0</code>, <code>""</code>, <code>null</code>, <code>"0"</code>, <code>[]</code> は偽、それ以外は真</li>
<li><code>PerlBool</code>: <code>false</code>, <code>0</code>, <code>0.0</code>, <code>""</code>, <code>null</code>, <code>"0"</code> は偽、それ以外は真</li>
<li><code>PythonBool</code>: <code>false</code>, <code>0</code>, <code>0.0</code>, <code>""</code>, <code>null</code>, <code>[]</code>, <code>{}</code> は偽、それ以外は真</li>
</ul>


<p>ややこしい・・・なるべく使わない方がいいと思います。</p>

<h2>最後に</h2>

<p>これを作るきっかけになった問題ですが、reflectで解決しました。reflect最強。
go-weaktypingを使うとすべてのUnmarshal時に有効になってしまって怖いなと考えたためです。</p>

<p>今後もなるべく go-weaktyping を使わずに済むよう祈ってます。</p>
]]></content>
  </entry>
  
</feed>
